<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·¥ç¨‹éšå±¤çµç®—ç³»çµ±</title>
    <style>
        :root {
            --bg: #F0EFE9;
            --card: #FFFFFF;
            --primary: #6D7850;
            --accent: #8D6E50;
            --text: #2D2D2D;
            --border: #C0BEB3;
            --danger: #c0392b;
            --success: #1b5e20;
            --info: #3d868a;
            --dark: #1a252f;
        }

        body { background-color: var(--bg); color: var(--text); font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; width: 100%; max-width: 500px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #D1D0C6; cursor: pointer; border-radius: 8px 8px 0 0; color: #555; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }

        .page { display: none; width: 100%; max-width: 500px; animation: fadeIn 0.3s; }
        #listPage.page.active { display: block; width: 98vw; max-width: none; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card); width: 100%; padding: 25px; border-radius: 0 0 15px 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); box-sizing: border-box; margin-bottom: 20px; }
        .list-card { background: var(--card); width: 100%; padding: 25px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); box-sizing: border-box; }
        
        h2 { text-align: center; color: var(--primary); font-weight: 700; margin-bottom: 20px; letter-spacing: 1px; }
        .row { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; }
        .col { flex: 1; display: flex; flex-direction: column; }
        
        label { font-size: 0.85rem; margin-bottom: 5px; color: #666; font-weight: bold; }
        input, select { padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; outline: none; background: #FFFFFF; width: 100%; box-sizing: border-box; color: var(--text); }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(109, 120, 80, 0.2); }
        
        #netAmount { font-weight: bold; color: #6b4d32; background-color: #FFF2E6; border: 1px solid var(--accent); }
        .config-box { background: #F4F4F1; padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid var(--border); }
        .payment-box { border-top: 2px solid var(--primary); padding-top: 15px; margin-top: 20px; }
        
        .input-with-unit { position: relative; display: flex; align-items: center; }
        .unit-label { margin-left: 5px; font-size: 0.85rem; color: #444; white-space: nowrap; width: 20px; font-weight: bold; }

        .display-area { background: #FFFFFF; border: 1px solid var(--border); padding: 20px; border-radius: 10px; margin-top: 20px; min-height: 50px; }
        .section-title { font-size: 0.9rem; font-weight: bold; color: var(--primary); margin-bottom: 10px; border-left: 4px solid var(--primary); padding-left: 8px; }
        
        .formula { font-size: 0.95rem; margin-bottom: 12px; line-height: 1.6; color: #333; }
        .formula strong { color: #000; font-weight: 700; }
        .subtotal-line { background: #E6E9DD; padding: 6px 10px; border-radius: 4px; color: var(--primary) !important; border: 1px solid #C4CCB2; }
        
        .payment-result { margin-top: 15px; padding-top: 10px; border-top: 2px dashed var(--border); }
        .date-line { font-family: monospace; font-weight: bold; font-size: 1.2rem; color: var(--accent); margin-bottom: 5px; }

        .btn-save { width: 100%; padding: 14px; margin-top: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.2s; }
        .btn-save:hover { opacity: 0.9; }
        .btn-excel { padding: 10px 20px; background: var(--success); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-info { padding: 10px 20px; background: var(--info); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-reset { width: 100%; padding: 10px; margin-top: 10px; color: #666; border: 1px solid var(--border); background: #E8E7E0; cursor: pointer; border-radius: 8px; font-size: 0.8rem; font-weight: bold; }
        
        .check-label { display: flex; align-items: center; gap: 5px; cursor: pointer; color: var(--text); font-weight: bold; }
        .check-label input[type="checkbox"] { width: 18px; height: 18px; margin: 0; }

        .toggle-group { display: flex; background: #ECEBE4; border-radius: 8px; padding: 3px; gap: 2px; border: 1px solid var(--border); }
        .toggle-btn { 
            flex: 1; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; 
            font-size: 0.75rem; font-weight: bold; color: #888; background: transparent; 
            transition: all 0.2s ease; white-space: nowrap;
        }
        .toggle-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #receiptToggle .toggle-btn.active { color: var(--accent); }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; table-layout: auto; }
        th { background-color: #E8E7E0; color: #333; border: 1px solid var(--border); padding: 10px 8px; font-weight: bold; }
        td { border: 1px solid var(--border); padding: 8px; text-align: left; overflow: hidden; color: var(--text); }
        
        .col-bank { width: 8.5ch; max-width: 8.5ch; }
        .col-acc { width: 17ch; max-width: 17ch; }
        .col-desc { width: auto; min-width: 150px; }

        #recordTable td { text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
        #recordTable td:hover { overflow: visible; white-space: normal; word-break: break-all; position: relative; z-index: 1; background: inherit; }
        
        .sortable { cursor: pointer; user-select: none; position: relative; }
        .sortable:hover { background-color: #D1D0C6; }
        
        .editable { cursor: pointer; background-color: #FFFCE0; border-radius: 4px; padding: 2px 5px; display: block; width: calc(100% - 10px); min-height: 1.2em; border: 1px solid #E0D5A0; }
        .editable:focus { border-color: var(--accent); outline: none; background-color: #fff; box-shadow: 0 0 5px rgba(141, 110, 80, 0.3); }
        
        .amount-cell { text-align: right; font-family: 'Courier New', monospace; font-weight: bold; }
        
        .action-cell { text-align: center; width: 90px; }
        .btn-calc { color: var(--info); border: 1.5px solid var(--info); background: white; cursor: pointer; border-radius: 50%; width: 26px; height: 26px; font-size: 0.75rem; font-weight: bold; padding: 0; margin-right: 5px; transition: 0.2s; vertical-align: middle; }
        .btn-calc:hover { background: var(--info); color: white; }
        .btn-edit-tool { color: var(--accent); border: 1.5px solid var(--accent); background: white; cursor: pointer; border-radius: 4px; padding: 2px 5px; font-size: 0.7rem; font-weight: bold; margin-right: 5px; transition: 0.2s; vertical-align: middle; }
        .btn-del { color: var(--danger); border: none; background: none; cursor: pointer; font-weight: bold; font-size: 1.4rem; line-height: 1; vertical-align: middle; }
        
        .summary-bar { margin-top: 15px; padding: 15px; background: #E8E7E0; border-radius: 8px; text-align: right; font-size: 1.1rem; color: #000; border: 1px solid var(--border); }
        .summary-bar strong { color: #d35400; font-size: 1.4rem; text-shadow: 1px 1px 0px #fff; }

        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid var(--primary); border-radius: 8px; z-index: 100; max-height: 250px; overflow-y: auto; box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: none; }
        .search-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #EEE; font-size: 0.9rem; color: #333; }
        .search-item:hover { background: #F0F2EB; color: var(--primary); }

        .filter-row { margin-bottom: 25px; display: flex; flex-wrap: wrap; align-items: center; gap: 20px; justify-content: space-between; }
        .filter-group { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .button-cluster { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 12px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 450px; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .close-modal { position: absolute; right: 15px; top: 15px; font-size: 1.5rem; cursor: pointer; color: #999; }
        
        .draggable-row { transition: background 0.2s; }
        .draggable-row.dragging { opacity: 0.5; background: #f0f0f0; }
        .drag-over { border-top: 3px dashed var(--primary) !important; }

        .drag-handle { cursor: grab; background-color: #f8f8f8; transition: background 0.2s; }
        .drag-handle:active { cursor: grabbing; background-color: #eee; }

        .vendor-form { background: #F4F4F1; padding: 15px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="tabs">
    <button class="tab-btn active" onclick="switchPage('calcPage', this)">è¨ˆç®—å·¥å…·</button>
    <button class="tab-btn" onclick="switchPage('listPage', this)">ä»˜æ¬¾æ¸…å–®</button>
    <button class="tab-btn" onclick="switchPage('vendorPage', this)">å» å•†è³‡æ–™</button>
</div>

<div id="calcPage" class="page active">
    <div class="card">
        <h2>å·¥ç¨‹çµç®—æ˜ç´°</h2>
        <div class="row">
            <div class="col">
                <label>ä»˜æ¬¾å…¬å¸</label>
                <select id="companySelect">
                    <option value="ç€å·">ç€å·</option>
                    <option value="è¿å·">è¿å·</option>
                    <option value="é•·å·">é•·å·</option>
                    <option value="ä¸Šå·">ä¸Šå·</option>
                </select>
            </div>
            <div class="col" style="position: relative;">
                <label>æœå°‹å» å•† (é è¦½åŒ…å«å¸³è™Ÿ)</label>
                <input type="text" id="vendorSearch" placeholder="æœå°‹å» å•†é—œéµå­—..." oninput="searchVendor(this.value)">
                <div id="searchResults" class="search-results"></div>
                <input type="hidden" id="tempBankCode">
                <input type="hidden" id="tempAccount">
                <input type="hidden" id="tempOwner">
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>å·¥ç¨‹å…§å®¹ (æ˜ç´°)</label>
                <input type="text" id="workNote" placeholder="ä¾‹å¦‚ï¼šæœ¨åœ°æ¿å·²å®Œæˆ54æˆ¶è«‹æ¬¾">
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <label style="margin-bottom:0">è¼¸å…¥é‡‘é¡</label>
                    <div style="display:flex; gap: 8px;">
                        <div class="toggle-group" id="receiptToggle">
                            <button class="toggle-btn active" onclick="setDocType('ç™¼ç¥¨')">ç™¼ç¥¨</button>
                            <button class="toggle-btn" onclick="setDocType('æ”¶æ“š')">æ”¶æ“š</button>
                        </div>
                        <div class="toggle-group" id="taxModeToggle">
                            <button class="toggle-btn active" onclick="setTaxMode('æœªç¨…')">æœªç¨…</button>
                            <button class="toggle-btn" onclick="setTaxMode('å«ç¨…')">å«ç¨…</button>
                        </div>
                    </div>
                </div>
                <input type="number" id="inputAmount" placeholder="è«‹è¼¸å…¥é‡‘é¡" oninput="calculate()">
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>æœªç¨…é‡‘é¡ (å¯æ‰‹å‹•ä¿®æ”¹)</label>
                <input type="number" id="rawAmount" style="font-weight: bold;" oninput="calculate(false, false, true)">
            </div>
            <div class="col">
                <label>ç¨…é¡ (å¯æ‰‹å‹•ä¿®æ”¹)</label>
                <input type="number" id="taxAmount" style="font-weight: bold;" oninput="calculate(false, false, false, true)">
            </div>
        </div>

        <div class="config-box">
            <div class="row">
                <div class="col">
                    <label class="check-label"><input type="checkbox" id="cleanCheck" checked onchange="calculate()"> æ¸…æ½”ä¿éšª (%)</label>
                    <input type="number" id="cleanRate" value="0.5" step="0.1" oninput="calculate()">
                </div>
                <div class="col">
                    <label>æ¸…æ½”ä¿éšªè²»é‡‘é¡ (å¯æ‰‹å‹•ä¿®æ”¹)</label>
                    <input type="number" id="cleanFeeAmount" oninput="calculate(false, true)">
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label class="check-label"><input type="checkbox" id="retentionCheck" checked onchange="calculate()"> ä¿ç•™æ¬¾ (%)</label>
                    <input type="number" id="retentionRate" value="10" step="1" oninput="calculate()">
                </div>
                <div class="col">
                    <label>ä¿ç•™æ¬¾é‡‘é¡ (å¯æ‰‹å‹•ä¿®æ”¹)</label>
                    <input type="number" id="retentionAmount" oninput="calculate(true)">
                </div>
            </div>
            <div class="row" style="margin-top: 5px;">
                <div class="col">
                    <label class="check-label" style="color: var(--accent);">
                        <input type="checkbox" id="isTaxInclusiveRetention" onchange="calculate()"> 
                        ç™¼ç¥¨é‡‘é¡å«ä¿ç•™æ¬¾ (åˆ†åˆ—æ‡‰ä»˜èˆ‡ç™¼ç¥¨)
                    </label>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>åŠ æ‰£æ¬¾äº‹ç”±</label>
                <input type="text" id="adjustmentNote" placeholder="ä¾‹å¦‚ï¼šä»£è³¼ææ–™æ‰£æ¬¾" oninput="calculate()">
            </div>
            <div class="col">
                <label>åŠ æ‰£æ¬¾é‡‘é¡</label>
                <input type="number" id="adjustmentAmount" placeholder="0" oninput="calculate()">
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>æœ€çµ‚æ·¨é¡ (å¯æ‰‹å‹•ä¿®æ”¹)</label>
                <input type="number" id="netAmount" oninput="updateFormulaOnly()">
            </div>
        </div>

        <div class="payment-box">
            <div class="row">
                <div class="col">
                    <label>ä»˜æ¬¾åŸºæº–æ—¥ (æ ¼å¼: 1150212)</label>
                    <input type="text" id="baseDate" placeholder="ä¾‹å¦‚: 1150212" oninput="renderDetail()">
                </div>
            </div>
            <label>ä»˜æ¬¾æ¯”ä¾‹ / æœŸæ•¸ (æœˆ)</label>
            <div class="row">
                <div class="col"><div class="input-with-unit"><input type="number" id="p1Pct" placeholder="æ¯”ä¾‹" oninput="renderDetail()"><span class="unit-label">%</span></div></div>
                <div class="col"><div class="input-with-unit"><input type="number" id="p1Mon" placeholder="æœŸæ•¸" oninput="renderDetail()"><span class="unit-label">æœˆ</span></div></div>
            </div>
            <div class="row">
                <div class="col"><div class="input-with-unit"><input type="number" id="p2Pct" placeholder="æ¯”ä¾‹" oninput="renderDetail()"><span class="unit-label">%</span></div></div>
                <div class="col"><div class="input-with-unit"><input type="number" id="p2Mon" placeholder="æœŸæ•¸" oninput="renderDetail()"><span class="unit-label">æœˆ</span></div></div>
            </div>
        </div>

        <div class="display-area">
            <div class="section-title">éšå±¤è¨ˆç®—åˆ—ç¤º</div>
            <div id="processFormula" class="formula">è«‹è¼¸å…¥è³‡æ–™...</div>
            <div class="payment-result" id="paymentDetail"></div>
        </div>

        <button class="btn-save" onclick="saveData()">å„²å­˜æ­¤ç­†æ’ç¨‹</button>
        <button class="btn-reset" onclick="location.reload()">é‡æ–°æ•´ç†</button>
    </div>
</div>

<div id="listPage" class="page">
    <div class="list-card">
        <div class="section-title">ä»˜æ¬¾æ¸…å–®æ˜ç´°</div>
        <div class="filter-row">
            <div class="filter-group">
                <label style="margin:0">æœˆä»½ï¼š</label>
                <select id="filterMonth" style="width: auto; padding: 5px; font-weight: bold;" onchange="renderTable()"></select>
                <label style="margin:0; margin-left:10px;">å…¬å¸ï¼š</label>
                <select id="filterCompany" style="width: auto; padding: 5px; font-weight: bold;" onchange="renderTable()">
                    <option value="å…¨éƒ¨">å…¨éƒ¨é¡¯ç¤º</option>
                    <option value="ç€å·">ç€å·</option>
                    <option value="è¿å·">è¿å·</option>
                    <option value="é•·å·">é•·å·</option>
                    <option value="ä¸Šå·">ä¸Šå·</option>
                </select>
                <label style="margin:0; margin-left:10px;">æ—¥æœŸç¯©é¸ï¼š</label>
                <input type="text" id="filterDate" placeholder="è¼¸å…¥æ—¥æœŸ(å¦‚11502)" style="width: 130px; padding: 5px; font-weight: bold;" oninput="renderTable()">
            </div>
            <div class="button-cluster">
                <button class="btn-info" id="btnCopyClaim" style="background: var(--accent);" onclick="copyToClipboard('claim', this)">ğŸ“‹ è¤‡è£½è«‹æ¬¾æ˜ç´° (è²¼Excel)</button>
                <button class="btn-info" id="btnCopyBank" style="background: var(--dark);" onclick="copyToClipboard('bank', this)">ğŸ“‹ è¤‡è£½åŒ¯æ¬¾è³‡æ–™ (è²¼Excel)</button>
                <button class="btn-info" onclick="autoFillRecordsByOwner()">æŒ‰æˆ¶åè£œé½Šè³‡æ–™</button>
                <button class="btn-save" style="background: var(--danger); width: auto; padding: 10px 20px; margin: 0;" onclick="clearData()">æ¸…ç©ºæ‰€æœ‰æ’ç¨‹</button>
            </div>
        </div>
        <table id="recordTable">
            <thead>
                <tr>
                    <th style="width: 30px; text-align: center;"><input type="checkbox" id="selectAll" checked onclick="toggleSelectAll(this)"></th>
                    <th style="width: 35px;">No.</th>
                    <th style="width: 8.5ch;">æ—¥æœŸ</th>
                    <th class="sortable col-desc" onclick="toggleSort('desc')">æ˜ç´°å…§å®¹</th>
                    <th style="width: 90px;">é‡‘é¡</th>
                    <th class="col-bank">è§£æ¬¾è¡Œ</th>
                    <th class="col-acc">å¸³è™Ÿ</th>
                    <th style="width: 20em;">æˆ¶å</th>
                    <th style="width: 3.2em;">å…¬å¸</th>
                    <th class="action-cell">åŠŸèƒ½</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div class="summary-bar" id="listSummary">
            ç¯©é¸ç¸½é‡‘é¡ï¼š<span id="filteredTotal">$0</span> | å‹¾é¸ç¸½é‡‘é¡ï¼š<strong id="checkedTotal">$0</strong>
        </div>
    </div>
</div>

<div id="vendorPage" class="page" style="max-width: 850px;">
    <div class="list-card">
        <div class="section-title">å» å•†åŒ¯æ¬¾è³‡æ–™ç®¡ç†</div>
        <div class="vendor-form">
            <div class="section-title" style="border-left: 4px solid var(--accent); color: var(--accent);">æ‰‹å‹•æ–°å¢å» å•†</div>
            <div class="row">
                <div class="col"><label>å» å•†åç¨±</label><input type="text" id="newVName" placeholder="å…¬å¸å"></div>
                <div class="col"><label>è§£æ¬¾è¡Œ</label><input type="text" id="newVBank" placeholder="ä»£è™Ÿ+åç¨±"></div>
            </div>
            <div class="row">
                <div class="col"><label>æ”¶æ¬¾å¸³è™Ÿ</label><input type="text" id="newVAcc" placeholder="éŠ€è¡Œå¸³è™Ÿ"></div>
                <div class="col"><label>æ”¶æ¬¾æˆ¶å</label><input type="text" id="newVOwner" placeholder="æˆ¶å"></div>
            </div>
            <button class="btn-save" style="margin-top: 5px; margin-bottom: 25px; background: var(--accent);" onclick="manualAddVendor()">æ–°å¢å» å•†è³‡æ–™</button>
        </div>
        <div class="filter-row" style="margin-top: 20px;">
            <div class="filter-group">
                <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="importVendorCSV(this)">
                <button class="btn-excel" onclick="document.getElementById('csvFileInput').click()">æ‰¹æ¬¡åŒ¯å…¥ CSV</button>
                <button class="btn-info" style="background: var(--info);" onclick="exportVendorExcel()">åŒ¯å‡ºå» å•†æ¸…å–®</button>
                <button class="btn-info" style="background: var(--dark);" onclick="exportFullBackup()">å‚™ä»½å…¨ç³»çµ±è³‡æ–™ (.json)</button>
                <input type="file" id="backupFileInput" accept=".json" style="display:none" onchange="importFullBackup(this)">
                <button class="btn-save" style="background: var(--accent); width: auto; padding: 10px 20px; margin: 0;" onclick="document.getElementById('backupFileInput').click()">é‚„åŸç³»çµ±è³‡æ–™</button>
                <button class="btn-save" style="background: #eee; color: var(--danger); width: auto; padding: 10px 20px; margin: 0; border: 1px solid var(--danger);" onclick="clearVendors()">æ¸…ç©ºå» å•†åº«</button>
            </div>
        </div>
        <table id="vendorTable">
            <thead>
                <tr>
                    <th style="width: 25%;">å» å•†åç¨±</th>
                    <th style="width: 20%;">è§£æ¬¾è¡Œ</th>
                    <th style="width: 20%;">å¸³è™Ÿ</th>
                    <th style="width: 20%;">æˆ¶å</th>
                    <th class="action-cell">åŠŸèƒ½</th>
                </tr>
            </thead>
            <tbody id="vendorTableBody"></tbody>
        </table>
    </div>
</div>

<div id="infoModal" class="modal" onclick="document.getElementById('infoModal').style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="document.getElementById('infoModal').style.display='none'">&times;</span>
        <div class="section-title">è¨ˆç®—éç¨‹ç´€éŒ„</div>
        <div id="modalBody" class="formula"></div>
    </div>
</div>

<script>
    const fmt = new Intl.NumberFormat('zh-TW');
    let db = JSON.parse(localStorage.getItem('paymentRecords')) || [];
    let vendors = JSON.parse(localStorage.getItem('vendorList')) || [];
    let currentSortOrder = 'asc';
    let checkedIds = new Set();
    
    let currentDocType = 'ç™¼ç¥¨';
    let currentTaxMode = 'æœªç¨…';

    let lastCalcState = { raw: 0, tax: 0, total: 0, cRate: 0, cleanFee: 0, subtotal: 0, rRate: 0, retention: 0, adj: 0, adjNote: "", isTaxInclusiveRetention: false };

    function setDocType(type) {
        currentDocType = type;
        const btns = document.querySelectorAll('#receiptToggle .toggle-btn');
        btns.forEach(b => b.classList.toggle('active', b.innerText === type));
        const taxGroup = document.getElementById('taxModeToggle');
        if (type === 'æ”¶æ“š') {
            taxGroup.style.opacity = '0.2';
            taxGroup.style.pointerEvents = 'none';
            setTaxMode('æœªç¨…');
        } else {
            taxGroup.style.opacity = '1';
            taxGroup.style.pointerEvents = 'auto';
        }
        calculate();
    }

    function setTaxMode(mode) {
        currentTaxMode = mode;
        const btns = document.querySelectorAll('#taxModeToggle .toggle-btn');
        btns.forEach(b => b.classList.toggle('active', b.innerText === mode));
        calculate();
    }

    function searchVendor(val) {
        const resultsDiv = document.getElementById('searchResults');
        if (!val) { resultsDiv.style.display = 'none'; return; }
        const filtered = vendors.filter(v => v.name.includes(val) || v.owner.includes(val) || (v.account && v.account.includes(val)));
        if (filtered.length > 0) {
            resultsDiv.innerHTML = filtered.map(v => `
                <div class="search-item" onclick="selectVendor('${v.name}', '${v.bankCode}', '${v.account}', '${v.owner}')">
                    <div><strong>${v.name}</strong> (${v.owner})</div>
                    <div style="font-size:0.8rem; color:#666">è¡Œåº«ï¼š${v.bankCode || ''} | å¸³è™Ÿï¼š${v.account || ''}</div>
                </div>
            `).join('');
            resultsDiv.style.display = 'block';
        } else {
            resultsDiv.style.display = 'none';
        }
    }

    function selectVendor(name, bank, acc, owner) {
        document.getElementById('vendorSearch').value = name;
        document.getElementById('tempBankCode').value = bank || "";
        document.getElementById('tempAccount').value = acc || "";
        document.getElementById('tempOwner').value = owner || "";
        document.getElementById('searchResults').style.display = 'none';

        const lastRecord = [...db].reverse().find(r => r.owner === owner);
        if (lastRecord && lastRecord.settings) {
            const s = lastRecord.settings;
            if (s.docType) setDocType(s.docType);
            if (s.taxMode) setTaxMode(s.taxMode);
            document.getElementById('cleanCheck').checked = s.cleanCheck;
            document.getElementById('cleanRate').value = s.cleanRate;
            document.getElementById('retentionCheck').checked = s.retentionCheck;
            document.getElementById('retentionRate').value = s.retentionRate;
            if(s.isTaxInclusiveRetention !== undefined) document.getElementById('isTaxInclusiveRetention').checked = s.isTaxInclusiveRetention;
            document.getElementById('p1Pct').value = s.p1Pct;
            document.getElementById('p1Mon').value = s.p1Mon;
            document.getElementById('p2Pct').value = s.p2Pct;
            document.getElementById('p2Mon').value = s.p2Mon;
            calculate();
        }
    }

    function exportFullBackup() {
        const backupData = { paymentRecords: db, vendorList: vendors, backupDate: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(backupData)], { type: 'application/json' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `å·¥ç¨‹ç³»çµ±å…¨å‚™ä»½_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`;
        link.click();
    }

    function importFullBackup(input) {
        const file = input.files[0];
        if (!file) return;
        if (!confirm("é‚„åŸç³»çµ±å°‡æœƒè“‹æ‰ç›®å‰é›»è…¦ä¸­çš„æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) { input.value = ""; return; }
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (imported.paymentRecords && imported.vendorList) {
                    db = imported.paymentRecords;
                    vendors = imported.vendorList;
                    localStorage.setItem('paymentRecords', JSON.stringify(db));
                    localStorage.setItem('vendorList', JSON.stringify(vendors));
                    alert("ç³»çµ±é‚„åŸæˆåŠŸï¼");
                    location.reload();
                } else { alert("å‚™ä»½æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºã€‚"); }
            } catch (err) { alert("è®€å–æª”æ¡ˆå¤±æ•—ï¼š" + err); }
        };
        reader.readAsText(file);
    }

    function autoFillRecordsByOwner() {
        let count = 0;
        db.forEach(item => {
            if ((!item.bank || !item.acc) && item.owner) {
                const match = vendors.find(v => v.owner === item.owner.trim());
                if (match) {
                    item.bank = match.bankCode;
                    item.acc = match.account;
                    count++;
                }
            }
        });
        if (count > 0) {
            localStorage.setItem('paymentRecords', JSON.stringify(db));
            renderTable();
            alert(`æˆåŠŸè£œé½Š ${count} ç­†åŒ¯æ¬¾è³‡æ–™ï¼`);
        } else { alert("æœªæ‰¾åˆ°ç›¸ç¬¦æˆ¶åçš„å» å•†è³‡æ–™ã€‚"); }
    }

    function manualAddVendor() {
        const name = document.getElementById('newVName').value.trim();
        const bank = document.getElementById('newVBank').value.trim();
        const acc = document.getElementById('newVAcc').value.trim();
        const owner = document.getElementById('newVOwner').value.trim();
        if(!name || !acc) { alert("å» å•†åç¨±èˆ‡å¸³è™Ÿç‚ºå¿…å¡«ï¼"); return; }
        vendors.push({ id: Date.now() + Math.random(), name, bankCode: bank, account: acc, owner });
        localStorage.setItem('vendorList', JSON.stringify(vendors));
        renderVendorTable();
        ['newVName', 'newVBank', 'newVAcc', 'newVOwner'].forEach(id => document.getElementById(id).value = "");
        alert("å» å•†æ–°å¢æˆåŠŸï¼");
    }

    function importVendorCSV(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const rows = text.split('\n').filter(r => r.trim() !== "");
            rows.slice(1).forEach(row => {
                const cols = row.split(',').map(s => s.trim().replace(/^="|"$/g, '').replace(/^'/, ''));
                if (cols.length >= 4) {
                    vendors.push({ id: Date.now() + Math.random(), name: cols[0], bankCode: cols[1], account: cols[2], owner: cols[3] });
                }
            });
            localStorage.setItem('vendorList', JSON.stringify(vendors));
            renderVendorTable();
            alert("åŒ¯å…¥æˆåŠŸï¼");
            input.value = "";
        };
        reader.readAsText(file, 'UTF-8');
    }

    function exportVendorExcel() {
        if(vendors.length === 0) return alert("ç›®å‰ç„¡å» å•†è³‡æ–™å¯åŒ¯å‡º");
        let csvContent = "\ufeffå» å•†åç¨±,è§£æ¬¾è¡Œ,å¸³è™Ÿ,æˆ¶å\n";
        vendors.forEach(v => {
            csvContent += `"${v.name}","${v.bankCode || ''}","${v.account || ''}","${v.owner || ''}"\n`;
        });
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `å» å•†è³‡æ–™åº«_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`;
        link.click();
    }

    function renderVendorTable() {
        const tbody = document.getElementById('vendorTableBody');
        tbody.innerHTML = vendors.map(v => `
            <tr>
                <td><span class="editable" onblur="updateVendorField('${v.id}', 'name', this.innerText)" contenteditable="true">${v.name}</span></td>
                <td><span class="editable" onblur="updateVendorField('${v.id}', 'bankCode', this.innerText)" contenteditable="true">${v.bankCode || ''}</span></td>
                <td><span class="editable" onblur="updateVendorField('${v.id}', 'account', this.innerText)" contenteditable="true">${v.account || ''}</span></td>
                <td><span class="editable" onblur="updateVendorField('${v.id}', 'owner', this.innerText)" contenteditable="true">${v.owner || ''}</span></td>
                <td class="action-cell">
                    <button class="btn-edit-tool" onclick="alert('è«‹ç›´æ¥åœ¨é»ƒè‰²æ¬„ä½å…§ä¿®æ”¹')">æ”¹</button>
                    <button class="btn-del" onclick="deleteVendor('${v.id}')">Ã—</button>
                </td>
            </tr>
        `).join('');
    }

    function updateVendorField(id, field, value) {
        const idx = vendors.findIndex(v => v.id == id);
        if(idx !== -1) { vendors[idx][field] = value.trim(); localStorage.setItem('vendorList', JSON.stringify(vendors)); }
    }

    function deleteVendor(id) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤å» å•†ï¼Ÿ")) { vendors = vendors.filter(v => v.id != id); localStorage.setItem('vendorList', JSON.stringify(vendors)); renderVendorTable(); }
    }

    function clearVendors() {
        if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰å» å•†è³‡æ–™ï¼Ÿ")) { vendors = []; localStorage.removeItem('vendorList'); renderVendorTable(); }
    }

    function switchPage(pageId, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        btn.classList.add('active');
        if(pageId === 'listPage') { initMonthFilter(); renderTable(); }
        if(pageId === 'vendorPage') { renderVendorTable(); }
    }

    function calculate(isManualRetention = false, isManualClean = false, isManualRaw = false, isManualTax = false) {
        const inputVal = parseFloat(document.getElementById('inputAmount').value) || 0;
        const rawInput = document.getElementById('rawAmount');
        const taxInput = document.getElementById('taxAmount');
        const retentionInput = document.getElementById('retentionAmount');
        const cleanFeeInput = document.getElementById('cleanFeeAmount');
        const adj = parseFloat(document.getElementById('adjustmentAmount').value) || 0;
        const adjNote = document.getElementById('adjustmentNote').value || "åŠ æ‰£æ¬¾";
        const isTaxInclusiveRetention = document.getElementById('isTaxInclusiveRetention').checked;
        
        let raw = 0;
        let tax = 0;

        if (isManualRaw || isManualTax) {
            raw = parseFloat(rawInput.value) || 0;
            tax = parseFloat(taxInput.value) || 0;
        } else {
            if (currentDocType === 'ç™¼ç¥¨') {
                if (currentTaxMode === 'æœªç¨…') {
                    raw = inputVal;
                    tax = Math.round(raw * 0.05);
                } else {
                    raw = Math.round(inputVal / 1.05);
                    tax = inputVal - raw;
                }
            } else {
                raw = inputVal;
                tax = 0;
            }
            rawInput.value = raw || "";
            taxInput.value = tax || "";
        }
        
        const total = raw + tax;
        const hasClean = document.getElementById('cleanCheck').checked;
        const cRate = parseFloat(document.getElementById('cleanRate').value) || 0;
        
        let cleanFee = 0;
        if (hasClean) {
            cleanFee = isManualClean ? (parseFloat(cleanFeeInput.value) || 0) : Math.round(total * (cRate / 100));
        }
        if(!isManualClean) cleanFeeInput.value = cleanFee || "";

        const subtotal = total - cleanFee;
        const hasRetention = document.getElementById('retentionCheck').checked;
        const rRate = parseFloat(document.getElementById('retentionRate').value) || 0;
        let retention = hasRetention ? (isManualRetention ? (parseFloat(retentionInput.value) || 0) : Math.round(subtotal * (rRate / 100))) : 0;
        
        if(!isManualRetention) retentionInput.value = retention || "";
        
        const net = (subtotal - retention) + adj;
        
        lastCalcState = { raw, tax, total, cRate, cleanFee, subtotal, rRate, retention, adj, adjNote, isTaxInclusiveRetention };
        document.getElementById('netAmount').value = net;
        renderFormula(net);
        renderDetail();
    }

    function updateFormulaOnly() {
        const manualNet = parseFloat(document.getElementById('netAmount').value) || 0;
        renderFormula(manualNet);
        renderDetail();
    }

    function renderFormula(currentNet) {
        let html = `<div>â‘  å…¨é¡ï¼š${fmt.format(lastCalcState.raw)}${lastCalcState.tax > 0 ? ' + ç¨…' + fmt.format(lastCalcState.tax) : ''} = <strong>${fmt.format(lastCalcState.total)}</strong></div>`;
        let stepCount = 2;
        if (lastCalcState.cleanFee !== 0) {
            html += `<div>â‘¡ æ¸…æ½”è²»(${lastCalcState.cRate}%)ï¼š${fmt.format(lastCalcState.total)} Ã— ${lastCalcState.cRate}% = <strong>${fmt.format(lastCalcState.cleanFee)}</strong></div>`;
            html += `<div class="subtotal-line">â‘¢ å°è¨ˆ (ç™¼ç¥¨åŸºæº–)ï¼š${fmt.format(lastCalcState.total)} - ${fmt.format(lastCalcState.cleanFee)} = <strong>${fmt.format(lastCalcState.subtotal)}</strong></div>`;
            stepCount = 4;
        }
        const getIdx = () => {
            const map = { 1: "â‘ ", 2: "â‘¡", 3: "â‘¢", 4: "â‘£", 5: "â‘¤", 6: "â‘¥", 7: "â‘¦", 8: "â‘§" };
            return map[stepCount++];
        };
        
        if (lastCalcState.retention !== 0) {
            html += `<div>${getIdx()} ä¿ç•™æ¬¾ï¼š${fmt.format(lastCalcState.subtotal)} Ã— ${lastCalcState.rRate}% = <strong>${fmt.format(lastCalcState.retention)}</strong></div>`;
        }
        if (lastCalcState.adj !== 0) {
            html += `<div>${getIdx()} ${lastCalcState.adjNote}ï¼š<strong>${lastCalcState.adj >= 0 ? '+' : ''}${fmt.format(lastCalcState.adj)}</strong></div>`;
        }

        if (lastCalcState.isTaxInclusiveRetention) {
            const invoiceAmount = lastCalcState.subtotal + lastCalcState.adj;
            html += `<div style="margin-top:10px; padding: 10px; border: 1px solid var(--accent); border-radius: 8px; background: #FFFBF0;">`;
            html += `<div style="color: var(--accent); font-weight: bold;">â— æœ¬æ¬¡ç™¼ç¥¨é‡‘é¡ï¼š${fmt.format(invoiceAmount)} (å«ä¿ç•™æ¬¾)</div>`;
            html += `<div style="color: var(--primary); font-weight: bold;">â— æœ¬æ¬¡æ‡‰ä»˜é‡‘é¡ï¼š${fmt.format(currentNet)}</div>`;
            html += `</div>`;
        } else {
            html += `<div style="margin-top:5px; border-top:1px solid #EEE; padding-top:5px;">${getIdx()} æ·¨é¡ï¼š<strong>${fmt.format(currentNet)}</strong></div>`;
        }
        
        document.getElementById('processFormula').innerHTML = html;
    }

    function getCalculatedDate(addMonths, useSlash = true) {
        const rawBase = document.getElementById('baseDate').value;
        if (!/^\d{7}$/.test(rawBase)) return "æ ¼å¼éŒ¯èª¤";
        let year = parseInt(rawBase.substring(0, 3)) + 1911;
        let month = parseInt(rawBase.substring(3, 5)) - 1;
        let day = parseInt(rawBase.substring(5, 7));
        let d = new Date(year, month, day);
        if (addMonths > 0) {
            d.setMonth(d.getMonth() + addMonths);
            d.setDate(15);
        }
        const resY = d.getFullYear() - 1911;
        const resM = (d.getMonth() + 1).toString().padStart(2, '0');
        const resD = d.getDate().toString().padStart(2, '0');
        return useSlash ? `${resY}/${resM}/${resD}` : `${resY}${resM}${resD}`;
    }

    function renderDetail() {
        const net = parseFloat(document.getElementById('netAmount').value) || 0;
        const p1Pct = parseFloat(document.getElementById('p1Pct').value) || 0;
        const pDetail = document.getElementById('paymentDetail');
        if(net <= 0 || isNaN(p1Pct)) { pDetail.innerHTML = ""; return; }
        const pay1 = Math.round(net * (p1Pct / 100));
        const date1 = getCalculatedDate(parseInt(document.getElementById('p1Mon').value || 0), true);
        let html = `<div class="section-title">ä»˜æ¬¾æ’ç¨‹ (é è¦½)</div><div class="date-line">${date1} &nbsp; $${fmt.format(pay1)}</div>`;
        if (p1Pct < 100) {
            const pay2 = net - pay1;
            const date2 = getCalculatedDate(parseInt(document.getElementById('p2Mon').value || 0), true);
            html += `<div class="date-line">${date2} &nbsp; $${fmt.format(pay2)}</div>`;
        }
        pDetail.innerHTML = html;
    }

    function saveData() {
        const net = parseFloat(document.getElementById('netAmount').value) || 0;
        if (net <= 0 || !document.getElementById('p1Pct').value) { alert("è«‹è¼¸å…¥é‡‘é¡èˆ‡æ¯”ä¾‹"); return; }
        const timestamp = Date.now();
        const saveMonthLabel = `${new Date().getFullYear()}.${(new Date().getMonth()+1).toString().padStart(2, '0')}`;
        const p1Pct = parseFloat(document.getElementById('p1Pct').value);
        const pay1 = Math.round(net * (p1Pct / 100));
        const workNote = document.getElementById('workNote').value || "å·¥ç¨‹";
        const hasRetention = document.getElementById('retentionCheck').checked;
        const rRate = document.getElementById('retentionRate').value;
        const currentBaseDate = document.getElementById('baseDate').value; 
        let baseDesc = workNote;
        if (hasRetention) baseDesc += `-ä¿ç•™${rRate}%`;
        const isInstallment = p1Pct < 100;
        const settings = {
            docType: currentDocType,
            taxMode: currentTaxMode,
            cleanCheck: document.getElementById('cleanCheck').checked,
            cleanRate: document.getElementById('cleanRate').value,
            retentionCheck: document.getElementById('retentionCheck').checked,
            retentionRate: document.getElementById('retentionRate').value,
            isTaxInclusiveRetention: document.getElementById('isTaxInclusiveRetention').checked,
            p1Pct: document.getElementById('p1Pct').value,
            p1Mon: document.getElementById('p1Mon').value,
            p2Pct: document.getElementById('p2Pct').value,
            p2Mon: document.getElementById('p2Mon').value,
            baseDate: currentBaseDate 
        };
        const recordBase = { 
            company: document.getElementById('companySelect').value, 
            bank: document.getElementById('tempBankCode').value || "", 
            acc: document.getElementById('tempAccount').value || "", 
            owner: document.getElementById('tempOwner').value || "", 
            formula: document.getElementById('processFormula').innerHTML, 
            saveMonth: saveMonthLabel,
            settings: settings 
        };
        const date1_save = getCalculatedDate(parseInt(document.getElementById('p1Mon').value || 0), false);
        const item1 = { ...recordBase, id: timestamp + "_1", date: date1_save, desc: isInstallment ? `${baseDesc}(2-1)` : baseDesc, amount: pay1 };
        db.push(item1);
        checkedIds.add(item1.id);
        if (isInstallment) { 
            const date2_save = getCalculatedDate(parseInt(document.getElementById('p2Mon').value || 0), false);
            const item2 = { ...recordBase, id: timestamp + "_2", date: date2_save, desc: `${baseDesc}(2-2)`, amount: net - pay1 };
            db.push(item2); 
            checkedIds.add(item2.id);
        }
        localStorage.setItem('paymentRecords', JSON.stringify(db));
        clearInputFields(currentBaseDate, currentDocType, currentTaxMode);
    }

    function clearInputFields(keptBaseDate, keptDocType, keptTaxMode) {
        ['vendorSearch', 'workNote', 'inputAmount', 'rawAmount', 'taxAmount', 'cleanFeeAmount', 'retentionAmount', 'adjustmentNote', 'adjustmentAmount', 'netAmount', 'p1Pct', 'p1Mon', 'p2Pct', 'p2Mon', 'tempBankCode', 'tempAccount', 'tempOwner'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.value = "";
        });
        document.getElementById('isTaxInclusiveRetention').checked = false;
        document.getElementById('processFormula').innerHTML = "è«‹è¼¸å…¥è³‡æ–™...";
        document.getElementById('paymentDetail').innerHTML = "";
        if (keptBaseDate) document.getElementById('baseDate').value = keptBaseDate;
        else initBaseDate();
        if (keptDocType) setDocType(keptDocType);
        if (keptTaxMode) setTaxMode(keptTaxMode);
    }

    function toggleSort(field) {
        currentSortOrder = (currentSortOrder === 'asc') ? 'desc' : 'asc';
        db.sort((a, b) => {
            let valA = a[field] || "";
            let valB = b[field] || "";
            return currentSortOrder === 'asc' ? valA.localeCompare(valB, 'zh-TW') : valB.localeCompare(valA, 'zh-TW');
        });
        renderTable();
    }

    function toggleItem(id, isChecked) {
        if (isChecked) checkedIds.add(id);
        else checkedIds.delete(id);
        updateSummary();
    }

    function toggleSelectAll(el) {
        const checkboxes = document.querySelectorAll('.item-check');
        checkboxes.forEach(cb => {
            cb.checked = el.checked;
            toggleItem(cb.dataset.id, el.checked);
        });
    }

    function updateSummary() {
        const filterComp = document.getElementById('filterCompany').value;
        const filterMon = document.getElementById('filterMonth').value;
        const filterDateVal = document.getElementById('filterDate').value.trim();
        
        const filtered = db.filter(item => {
            const matchComp = (filterComp === "å…¨éƒ¨" || item.company === filterComp);
            const matchMon = (filterMon === "å…¨éƒ¨" || item.saveMonth === filterMon);
            const matchDate = (!filterDateVal || item.date.includes(filterDateVal));
            return matchComp && matchMon && matchDate;
        });
        
        let filteredSum = 0;
        let checkedSum = 0;
        filtered.forEach(i => {
            filteredSum += i.amount;
            if (checkedIds.has(i.id)) checkedSum += i.amount;
        });
        document.getElementById('filteredTotal').innerText = '$' + fmt.format(filteredSum);
        document.getElementById('checkedTotal').innerText = '$' + fmt.format(checkedSum);
    }

    function renderTable() {
        const filterComp = document.getElementById('filterCompany').value;
        const filterMon = document.getElementById('filterMonth').value;
        const filterDateVal = document.getElementById('filterDate').value.trim();
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        let counter = 1;
        
        const filtered = db.filter(item => {
            const matchComp = (filterComp === "å…¨éƒ¨" || item.company === filterComp);
            const matchMon = (filterMon === "å…¨éƒ¨" || item.saveMonth === filterMon);
            const matchDate = (!filterDateVal || item.date.includes(filterDateVal));
            return matchComp && matchMon && matchDate;
        });

        filtered.forEach(item => {
            if (!checkedIds.has(item.id) && document.getElementById('selectAll').checked) {
                checkedIds.add(item.id);
            }
            const tr = document.createElement('tr');
            tr.className = "draggable-row";
            tr.dataset.id = item.id;
            tr.innerHTML = `
                <td style="text-align:center;"><input type="checkbox" class="item-check" data-id="${item.id}" ${checkedIds.has(item.id) ? 'checked' : ''} onchange="toggleItem('${item.id}', this.checked)"></td>
                <td style="text-align:center; color:#555; font-weight:bold;" class="drag-handle" onmousedown="enableDrag(this)" onmouseup="disableDrag(this)">${counter++}</td>
                <td><span class="editable" onblur="updateField('${item.id}', 'date', this.innerText)" contenteditable="true">${item.date}</span></td>
                <td class="col-desc"><span class="editable" onblur="updateField('${item.id}', 'desc', this.innerText)" contenteditable="true">${item.desc}</span></td>
                <td class="amount-cell"><span class="editable" onblur="updateAmountField('${item.id}', this)" contenteditable="true">${fmt.format(item.amount)}</span></td>
                <td class="col-bank"><span class="editable" onblur="updateField('${item.id}', 'bank', this.innerText)" contenteditable="true">${item.bank || ''}</span></td>
                <td class="col-acc"><span class="editable" onblur="updateField('${item.id}', 'acc', this.innerText)" contenteditable="true">${item.acc || ''}</span></td>
                <td><span class="editable" onblur="updateField('${item.id}', 'owner', this.innerText)" contenteditable="true">${item.owner || ''}</span></td>
                <td><span class="editable" onblur="updateField('${item.id}', 'company', this.innerText)" contenteditable="true">${item.company || ''}</span></td>
                <td class="action-cell">
                    <button class="btn-calc" onclick="showFormula('${item.id}')" title="æŸ¥çœ‹è¨ˆç®—éç¨‹">ç®—</button>
                    <button class="btn-del" onclick="deleteRecord('${item.id}')">Ã—</button>
                </td>
            `;
            tr.ondragstart = (e) => { e.dataTransfer.setData('text/plain', item.id); e.target.classList.add('dragging'); };
            tr.ondragend = (e) => { e.target.classList.remove('dragging'); tr.draggable = false; removeDragOverStyles(); };
            tr.ondragover = (e) => { e.preventDefault(); tr.classList.add('drag-over'); };
            tr.ondragleave = (e) => { tr.classList.remove('drag-over'); };
            tr.ondrop = (e) => { e.preventDefault(); handleDrop(e.dataTransfer.getData('text/plain'), item.id); };
            tbody.appendChild(tr);
        });
        updateSummary();
    }

    function enableDrag(el) { el.parentElement.draggable = true; }
    function disableDrag(el) { el.parentElement.draggable = false; }
    function removeDragOverStyles() { document.querySelectorAll('.draggable-row').forEach(row => row.classList.remove('drag-over')); }
    function handleDrop(draggedId, targetId) {
        if (draggedId === targetId) return;
        const dragIdx = db.findIndex(i => i.id === draggedId);
        const targetIdx = db.findIndex(i => i.id === targetId);
        const [draggedItem] = db.splice(dragIdx, 1);
        db.splice(targetIdx, 0, draggedItem);
        localStorage.setItem('paymentRecords', JSON.stringify(db));
        renderTable();
    }
    function showFormula(id) {
        const record = db.find(i => i.id === id);
        if(record) { document.getElementById('modalBody').innerHTML = record.formula; document.getElementById('infoModal').style.display = 'flex'; }
    }
    function updateField(id, field, value) {
        const idx = db.findIndex(i => i.id === id);
        if(idx !== -1) { db[idx][field] = value.trim(); localStorage.setItem('paymentRecords', JSON.stringify(db)); }
    }
    function updateAmountField(id, el) {
        const idx = db.findIndex(i => i.id === id);
        if(idx !== -1) {
            let val = parseInt(el.innerText.replace(/,/g, '')) || 0;
            db[idx].amount = val; localStorage.setItem('paymentRecords', JSON.stringify(db));
            el.innerText = fmt.format(val);
            updateSummary();
        }
    }
    function deleteRecord(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { db = db.filter(i => i.id !== id); checkedIds.delete(id); localStorage.setItem('paymentRecords', JSON.stringify(db)); renderTable(); } }
    function clearData() { if(confirm("ã€è­¦å‘Šã€‘ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰çš„ä»˜æ¬¾æ’ç¨‹è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œä¸å¯é‚„åŸã€‚")) { db = []; checkedIds.clear(); localStorage.removeItem('paymentRecords'); renderTable(); } }
    
    function copyToClipboard(type, btn) {
        const filterComp = document.getElementById('filterCompany').value;
        const filterMon = document.getElementById('filterMonth').value;
        const filterDateVal = document.getElementById('filterDate').value.trim();
        
        const filtered = db.filter(item => {
            const matchComp = (filterComp === "å…¨éƒ¨" || item.company === filterComp);
            const matchMon = (filterMon === "å…¨éƒ¨" || item.saveMonth === filterMon);
            const matchDate = (!filterDateVal || item.date.includes(filterDateVal));
            return matchComp && matchMon && matchDate && checkedIds.has(item.id);
        });
        
        if (filtered.length === 0) return;
        
        let text = "";
        if (type === 'claim') {
            text = filtered.map(i => `${i.date}\t${i.desc}\t${i.amount}`).join('\n');
        } else if (type === 'bank') {
            text = filtered.map(i => `${i.date}\t${i.bank}\t${i.acc}\t${i.owner}\t${i.amount}`).join('\n');
        }

        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            // æŒ‰éˆ•è¦–è¦ºè®ŠåŒ–æ›¿ä»£ Alert
            const originalText = btn.innerText;
            btn.innerText = "âœ… å·²æˆåŠŸè¤‡è£½";
            btn.style.background = "#1b5e20"; 
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.background = ""; 
            }, 2000);
        } catch (err) {}
        document.body.removeChild(textArea);
    }

    function initMonthFilter() {
        const months = new Set();
        db.forEach(item => { if(item.saveMonth) months.add(item.saveMonth); });
        const now = new Date();
        const currentLabel = `${now.getFullYear()}.${(now.getMonth()+1).toString().padStart(2, '0')}`;
        months.add(currentLabel);
        const sorted = Array.from(months).sort().reverse();
        document.getElementById('filterMonth').innerHTML = `<option value="å…¨éƒ¨">å…¨éƒ¨æœˆä»½</option>` + sorted.map(m => `<option value="${m}">${m}</option>`).join('');
        document.getElementById('filterMonth').value = currentLabel;
    }
    function initBaseDate() {
        const now = new Date();
        const y = now.getFullYear() - 1911;
        const m = (now.getMonth() + 1).toString().padStart(2, '0');
        const d = now.getDate().toString().padStart(2, '0');
        document.getElementById('baseDate').value = `${y}${m}${d}`;
    }
    document.addEventListener('click', e => { if (!e.target.closest('.col')) document.getElementById('searchResults').style.display = 'none'; });
    window.onload = () => { db.forEach(i => checkedIds.add(i.id)); initMonthFilter(); initBaseDate(); };
</script>

</body>
</html>
