<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅遊費用分算 - 自然有機版</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: '#FDFCF8', // Rice Paper
                        foreground: '#2C2C24', // Deep Loam
                        primary: '#5D7052', // Moss Green
                        'primary-foreground': '#F3F4F1',
                        secondary: '#C18C5D', // Terracotta
                        'secondary-foreground': '#FFFFFF',
                        accent: '#E6DCCD', // Sand
                        muted: '#F0EBE5', // Stone
                        'muted-foreground': '#78786C', // Dried Grass
                        border: '#DED8CF', // Raw Timber
                        destructive: '#A85448', // Burnt Sienna
                    },
                    fontFamily: {
                        serif: ['Fraunces', 'serif'],
                        sans: ['Nunito', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(93, 112, 82, 0.15)',
                        'float': '0 10px 40px -10px rgba(193, 140, 93, 0.2)',
                        'inner-organic': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.05)',
                    },
                    borderRadius: {
                        'organic': '2rem',
                    }
                }
            }
        }
    </script>

    <style>
        /* 全域設定 */
        html {
            font-size: 100%;
        }
        
        body {
            font-family: "Nunito", "Microsoft JhengHei", sans-serif;
            background-color: #FDFCF8;
            color: #2C2C24;
            -webkit-font-smoothing: antialiased;
            position: relative;
        }

        /* 紙張紋理 (Noise Texture) */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0.04;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            mix-blend-mode: multiply;
        }

        h1, h2, h3, h4, .font-serif {
            font-family: "Fraunces", "Microsoft JhengHei", serif;
        }

        /* 移除預設 outline，改用柔和 focus */
        input:focus, select:focus, button:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(93, 112, 82, 0.3);
            border-color: #5D7052 !important;
        }

        .loader {
            border: 3px solid #E6DCCD;
            border-top: 3px solid #5D7052;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .scale-up-center {
            animation: scale-up-center 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
        }
        @keyframes scale-up-center {
            0% { transform: scale(0.9) translateY(10px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        /* 自定義有機形狀 */
        .shape-blob {
            border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
        }
        .shape-stone {
            border-radius: 2rem 2.5rem 2rem 3rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- Firebase 設定 (維持不變) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDXPngTQ57pSYkct6omI0BEvUIlN-uMqys",
            authDomain: "travelledger-fa981.firebaseapp.com",
            projectId: "travelledger-fa981",
            storageBucket: "travelledger-fa981.firebasestorage.app",
            messagingSenderId: "575807326202",
            appId: "1:575807326202:web:c69bff9eef548b5d0bc643",
            measurementId: "G-T6NKH0R274"
        };

        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
                if (firebase.analytics) firebase.analytics();
            } catch (e) {
                console.error("Firebase 初始化失敗", e);
                console.warn("Firebase 初始化失敗，請檢查網路連線或 Console 錯誤訊息。");
            }
        }
        const db = firebase.firestore();
        // --- Firebase 設定結束 ---

        const { useState, useEffect, useMemo } = React;
        
        const Icon = ({ name, className = "w-5 h-5" }) => {
            return <i data-lucide={name} className={className}></i>;
        };

        const CURRENCIES = [
            { code: 'TWD', name: '台幣', symbol: 'TWD' },
            { code: 'USD', name: '美金', symbol: 'USD' },
            { code: 'JPY', name: '日圓', symbol: '¥' },
            { code: 'KRW', name: '韓元', symbol: '₩' },
            { code: 'CNY', name: '人民幣', symbol: 'CNY' },
            { code: 'EUR', name: '歐元', symbol: 'EUR' },
            { code: 'HKD', name: '港幣', symbol: 'HKD' },
            { code: 'GBP', name: '英鎊', symbol: 'GBP' },
            { code: 'AUD', name: '澳幣', symbol: 'AUD' },
            { code: 'SGD', name: '新加坡幣', symbol: 'SGD' },
            { code: 'THB', name: '泰銖', symbol: 'THB' },
        ];

        // --- 登入頁面組件 (Style Refactored) ---
        const LoginScreen = ({ onJoin }) => {
            const [tripId, setTripId] = useState('');
            const [history, setHistory] = useState([]);

            useEffect(() => {
                const stored = localStorage.getItem('trip_history');
                if (stored) {
                    try {
                        setHistory(JSON.parse(stored));
                    } catch (e) { console.error("History parse error", e); }
                }
            }, []);
            
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            const handleJoin = (idToJoin) => {
                const targetId = idToJoin || tripId;
                if (!targetId) return;
                const newHistory = [targetId, ...history.filter(h => h !== targetId)].slice(0, 5);
                setHistory(newHistory);
                localStorage.setItem('trip_history', JSON.stringify(newHistory));
                onJoin(targetId);
            };

            const removeHistoryItem = (e, idToRemove) => {
                e.stopPropagation();
                const newHistory = history.filter(h => h !== idToRemove);
                setHistory(newHistory);
                localStorage.setItem('trip_history', JSON.stringify(newHistory));
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center p-6 relative overflow-hidden bg-background">
                    {/* 背景 Blob 裝飾 */}
                    <div className="absolute top-[-10%] left-[-10%] w-96 h-96 bg-primary/10 blur-3xl rounded-full mix-blend-multiply opacity-70 animate-pulse"></div>
                    <div className="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-secondary/10 blur-3xl rounded-full mix-blend-multiply opacity-70"></div>

                    <div className="relative bg-white/60 backdrop-blur-sm p-8 rounded-[2.5rem] shadow-float max-w-sm w-full border border-white/50 space-y-6 text-center z-10">
                        <div className="bg-primary/10 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-2 text-primary shape-blob">
                            <Icon name="cloud" className="w-10 h-10" />
                        </div>
                        <div>
                            <h1 className="text-3xl font-serif font-bold text-foreground tracking-tight">Travel Ledger</h1>
                            <p className="text-muted-foreground text-sm mt-2 font-medium">輸入旅程代碼，同步彼此的足跡。</p>
                        </div>
                        
                        <div className="space-y-4">
                            <input 
                                type="text" 
                                value={tripId} 
                                onChange={e => setTripId(e.target.value)}
                                onKeyDown={e => {
                                    if (e.key === 'Enter' && tripId) handleJoin();
                                }}
                                placeholder="例如：TOKYO2026" 
                                className="w-full px-6 py-4 bg-white/80 border border-border rounded-full text-center text-lg font-bold uppercase tracking-widest placeholder:normal-case placeholder:tracking-normal placeholder:font-normal placeholder:text-muted-foreground/50 transition-all focus:bg-white"
                            />
                            
                            <button 
                                onClick={() => handleJoin()}
                                className="w-full bg-primary text-primary-foreground py-4 rounded-full text-lg shadow-soft font-bold hover:scale-[1.02] hover:shadow-[0_6px_24px_-4px_rgba(93,112,82,0.25)] active:scale-95 transition-all duration-300"
                            >
                                進入記帳
                            </button>
                        </div>

                        {history.length > 0 && (
                            <div className="pt-6 border-t border-border/50 mt-4">
                                <p className="text-xs text-muted-foreground mb-4 font-bold tracking-widest uppercase">最近足跡</p>
                                <div className="flex flex-wrap gap-2 justify-center">
                                    {history.map(h => (
                                        <div 
                                            key={h}
                                            className="inline-flex items-center bg-white/50 rounded-full border border-border/60 overflow-hidden shadow-sm hover:shadow-md transition-all group"
                                        >
                                            <span 
                                                onClick={() => handleJoin(h)}
                                                className="px-4 py-2 text-primary text-sm font-bold cursor-pointer hover:bg-muted/50 transition-colors border-r border-border/30"
                                            >
                                                {h}
                                            </span>
                                            <button 
                                                onClick={(e) => removeHistoryItem(e, h)}
                                                className="px-3 py-2 text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-colors flex items-center justify-center outline-none"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                    <polyline points="3 6 5 6 21 6"></polyline>
                                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 主程式組件 ---
        function App() {
            // 狀態管理 (維持不變)
            const [tripId, setTripId] = useState(localStorage.getItem('my_trip_id') || null);
            const [loading, setLoading] = useState(false);
            
            const [members, setMembers] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [rates, setRates] = useState({ TWD: 1 });
            
            // UI 狀態
            const [newMemberName, setNewMemberName] = useState('');
            const [loadingRates, setLoadingRates] = useState(false);
            const [showClearConfirm, setShowClearConfirm] = useState(false);
            const [deleteTargetId, setDeleteTargetId] = useState(null); 
            const [showLogoutConfirm, setShowLogoutConfirm] = useState(false); 
            const [toast, setToast] = useState(null);
            const [form, setForm] = useState({ item: '', amount: '', currency: 'TWD', payer: '', participants: [] });

            // 1. 初始化與監聽 Firebase 資料
            useEffect(() => {
                if (!tripId) return;

                setLoading(true);
                const unsubscribe = db.collection('trips').doc(tripId).onSnapshot((doc) => {
                    setLoading(false);
                    if (doc.exists) {
                        const data = doc.data();
                        setMembers(data.members || []);
                        setExpenses(data.expenses || []);
                    } else {
                        db.collection('trips').doc(tripId).set({
                            members: [],
                            expenses: [],
                            createdAt: new Date()
                        });
                    }
                }, (error) => {
                    console.error("Firebase Sync Error:", error);
                    setLoading(false);
                    showToast("同步失敗：請檢查網路連線");
                });

                localStorage.setItem('my_trip_id', tripId);
                fetchRates();

                return () => unsubscribe();
            }, [tripId]);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            // --- 功能函數 (維持不變) ---

            const handleLogout = () => {
                setShowLogoutConfirm(true); 
            };

            const confirmLogout = () => {
                localStorage.removeItem('my_trip_id');
                setTripId(null);
                setMembers([]);
                setExpenses([]);
                setShowLogoutConfirm(false);
            };

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 3000);
            };

            const fetchRates = async () => {
                setLoadingRates(true);
                try {
                    const res = await fetch(`https://open.er-api.com/v6/latest/TWD`);
                    const data = await res.json();
                    if (data && data.rates) {
                        const newRates = { TWD: 1 };
                        CURRENCIES.forEach(curr => {
                            if (curr.code === 'TWD') return;
                            if (data.rates[curr.code]) {
                                newRates[curr.code] = (1 / data.rates[curr.code] * 1.02).toFixed(4);
                            }
                        });
                        setRates(newRates);
                    }
                } catch (error) {
                    console.error("匯率更新失敗", error);
                    showToast("匯率更新失敗，使用快取");
                } finally {
                    setLoadingRates(false);
                }
            };

            const updateMembersInCloud = (newMembers) => {
                db.collection('trips').doc(tripId).update({ members: newMembers })
                    .catch(err => showToast("更新成員失敗"));
            };

            const addMember = () => {
                const trimmed = newMemberName.trim();
                if (!trimmed || members.includes(trimmed)) return;
                const newMembers = [...members, trimmed];
                setMembers(newMembers); 
                updateMembersInCloud(newMembers);
                setNewMemberName('');
            };

            const removeMember = (name) => {
                const newMembers = members.filter(m => m !== name);
                if (form.payer === name) setForm({ ...form, payer: '' });
                setForm(prev => ({ ...prev, participants: prev.participants.filter(p => p !== name) }));
                updateMembersInCloud(newMembers);
            };

            const updateExpensesInCloud = (newExpenses) => {
                db.collection('trips').doc(tripId).update({ expenses: newExpenses })
                    .catch(err => showToast("更新支出失敗"));
            };

            const submitExpense = () => {
                const { item, amount, currency, payer, participants } = form;
                if (!item || !amount || !payer || participants.length === 0) return;
                
                const totalAmount = parseFloat(amount);
                const count = participants.length;
                const baseSplit = Math.round(totalAmount / count);
                const lastSplit = totalAmount - (baseSplit * (count - 1));
                const splits = {};
                participants.forEach((name, index) => { splits[name] = index === count - 1 ? lastSplit : baseSplit; });

                const newExpense = {
                    id: Date.now(),
                    item, amount: totalAmount, currency, rate: parseFloat(rates[currency] || 1),
                    payer, splits,
                    timestamp: new Date().toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                };

                const newExpenses = [...expenses, newExpense];
                updateExpensesInCloud(newExpenses);
                
                setForm({ ...form, item: '', amount: '', participants: [] });
                showToast("支出已儲存至雲端");
            };

            const confirmDeleteExpense = () => {
                if (deleteTargetId) {
                    const newExpenses = expenses.filter(e => e.id !== deleteTargetId);
                    updateExpensesInCloud(newExpenses);
                    setDeleteTargetId(null);
                    showToast("已刪除該筆支出");
                }
            };

            const clearAllData = () => {
                db.collection('trips').doc(tripId).update({
                    members: [],
                    expenses: []
                }).then(() => {
                    setShowClearConfirm(false);
                    showToast("雲端紀錄已全數清除");
                });
            };

            const toggleParticipant = (name) => {
                setForm(prev => {
                    const isIncluded = prev.participants.includes(name);
                    return { ...prev, participants: isIncluded ? prev.participants.filter(p => p !== name) : [...prev.participants, name] };
                });
            };

            const formatNum = (num) => new Intl.NumberFormat('en-US').format(Math.round(num));

            const settlement = useMemo(() => {
                const balances = {}; 
                let totalTWD = 0;
                members.forEach(m => balances[m] = 0);

                const currencyCounts = {};
                expenses.forEach(e => {
                    if (e.currency !== 'TWD') {
                        currencyCounts[e.currency] = (currencyCounts[e.currency] || 0) + 1;
                    }
                });
                const primaryCode = Object.keys(currencyCounts).reduce((a, b) => currencyCounts[a] > currencyCounts[b] ? a : b, null);
                const primaryRate = primaryCode ? (rates[primaryCode] || 1) : 1;

                expenses.forEach(exp => {
                    const amountTWD = exp.amount * exp.rate;
                    totalTWD += amountTWD;
                    
                    if (balances[exp.payer] !== undefined) {
                        balances[exp.payer] += amountTWD;
                    }
                    
                    Object.entries(exp.splits).forEach(([name, splitAmt]) => { 
                        if (balances[name] !== undefined) {
                            balances[name] -= (splitAmt * exp.rate); 
                        }
                    });
                });

                const debtors = [], creditors = [];
                Object.entries(balances).forEach(([name, bal]) => {
                    if (bal < -1) debtors.push({ name, amount: Math.abs(bal) });
                    else if (bal > 1) creditors.push({ name, amount: bal });
                });

                const transactions = [];
                let dIdx = 0, cIdx = 0;
                const td = JSON.parse(JSON.stringify(debtors)), tc = JSON.parse(JSON.stringify(creditors));
                
                while (dIdx < td.length && cIdx < tc.length) {
                    const amt = Math.min(td[dIdx].amount, tc[cIdx].amount);
                    if (amt > 0) transactions.push({ from: td[dIdx].name, to: tc[cIdx].name, amount: amt });
                    
                    td[dIdx].amount -= amt; 
                    tc[cIdx].amount -= amt;
                    
                    if (td[dIdx].amount <= 0.1) dIdx++;
                    if (tc[cIdx].amount <= 0.1) cIdx++;
                }

                return { totalTWD, transactions, primaryCode, primaryRate };
            }, [expenses, members, rates]);

            const copyToClipboard = () => {
                let text = `【${tripId} 費用結算清單】\n`;
                
                let hasPrepaid = false;
                members.forEach(m => {
                    const paidItems = expenses.filter(e => e.payer === m);
                    if (paidItems.length > 0) {
                        hasPrepaid = true;
                        text += `\n${m} 預付：`;
                        const itemsStr = paidItems.map(e => {
                            const sym = CURRENCIES.find(c => c.code === e.currency)?.symbol || '$';
                            return `${e.item} ${sym}${formatNum(e.amount)}`;
                        }).join(' + ');
                        
                        const totalPrepaidTWD = paidItems.reduce((sum, e) => sum + (e.amount * e.rate), 0);
                        text += `${itemsStr} = 總共預付 `;

                        if (settlement.primaryCode && settlement.primaryCode !== 'TWD') {
                            const approxForeign = totalPrepaidTWD / settlement.primaryRate;
                            const sym = CURRENCIES.find(c => c.code === settlement.primaryCode).symbol;
                            text += `約 ${sym} ${formatNum(approxForeign)} (TWD ${formatNum(totalPrepaidTWD)})`;
                        } else {
                            text += `TWD ${formatNum(totalPrepaidTWD)}`;
                        }
                    }
                });
                
                if (hasPrepaid) text += `\n`;

                text += `━━━━\n\n`;

                members.forEach(member => {
                    const involved = expenses.filter(e => e.splits[member] !== undefined);
                    if (involved.length > 0) {
                        text += `［${member}］\n`;
                        involved.forEach(e => {
                            const splitAmt = e.splits[member];
                            const twd = Math.round(splitAmt * e.rate);
                            const sym = CURRENCIES.find(c => c.code === e.currency)?.symbol || '$';
                            text += ` - ${e.item}：${sym} ${formatNum(splitAmt)}${e.currency === 'TWD' ? '' : ` (TWD ${formatNum(twd)})`}\n`;
                        });
                        text += `\n`;
                    }
                });
                text += `━━━━\n【最終收付】(建議以台幣結算)\n`;
                if (settlement.transactions.length === 0) text += `目前的帳目已結清。\n`;
                else {
                    settlement.transactions.forEach(t => {
                        text += `◆ ${t.from} → ${t.to}：`;
                        if (settlement.primaryCode && settlement.primaryCode !== 'TWD') {
                            const foreignAmt = Math.round(t.amount / settlement.primaryRate);
                            const sym = CURRENCIES.find(c => c.code === settlement.primaryCode).symbol;
                            text += `約 ${sym} ${formatNum(foreignAmt)} (TWD ${formatNum(t.amount)})`;
                        } else {
                            text += `TWD ${formatNum(t.amount)}`;
                        }
                        text += `\n`;
                    });
                }
                const el = document.createElement('textarea');
                el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
                showToast("已複製詳細清單至剪貼簿");
            };

            // 如果沒有 tripId，顯示登入畫面
            if (!tripId) {
                return <LoginScreen onJoin={(id) => setTripId(id)} />;
            }

            // 如果正在載入資料
            if (loading && members.length === 0) {
                 return (
                    <div className="min-h-screen flex items-center justify-center bg-background flex-col gap-6">
                        <div className="loader"></div>
                        <p className="text-primary tracking-[0.2em] text-xs uppercase font-bold animate-pulse">Syncing with Nature...</p>
                    </div>
                 );
            }

            return (
                <div className="min-h-screen pb-32">
                    {/* Header: Organic & Glassmorphism */}
                    <header className="fixed top-4 left-0 right-0 max-w-xl mx-auto z-40 px-4">
                        <div className="bg-white/70 backdrop-blur-md border border-border/50 rounded-full px-6 py-3 shadow-soft flex justify-between items-center transition-all hover:bg-white/80">
                            <div>
                                <h1 className="text-lg flex items-center gap-2 text-primary font-serif font-bold tracking-tight">
                                    <Icon name="cloud-sun" className="w-5 h-5 text-secondary" /> {tripId}
                                </h1>
                            </div>
                            <div className="flex gap-1">
                                 <button onClick={fetchRates} className={`p-2 rounded-full text-muted-foreground hover:text-primary hover:bg-primary/10 transition-colors ${loadingRates ? 'animate-spin' : ''}`}>
                                    <Icon name="refresh-cw" className="w-4 h-4" />
                                </button>
                                <button onClick={handleLogout} className="p-2 rounded-full text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition-colors" title="登出">
                                    <Icon name="log-out" className="w-4 h-4" />
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-xl mx-auto p-4 pt-24 space-y-8">
                        {/* 1. 同行夥伴 */}
                        <section className="bg-[#FEFEFA] rounded-organic border border-border/50 p-6 shadow-soft relative overflow-hidden group">
                             <div className="absolute top-0 right-0 w-32 h-32 bg-accent/30 rounded-full blur-2xl translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
                            
                            <h2 className="text-xl font-serif font-bold mb-6 flex items-center gap-3 text-foreground">
                                <div className="p-2 bg-primary/10 rounded-xl text-primary"><Icon name="users" className="w-5 h-5" /></div> 同行夥伴
                            </h2>
                            <div className="flex gap-2 mb-6">
                                <input type="text" value={newMemberName} onChange={e => setNewMemberName(e.target.value)} onKeyPress={e => e.key === 'Enter' && addMember()} placeholder="輸入夥伴姓名..." className="flex-1 min-w-0 px-6 py-3 bg-white border border-border rounded-full outline-none text-base placeholder:text-muted-foreground/60 focus:bg-white/80 transition-all" />
                                <button onClick={addMember} className="bg-primary text-primary-foreground w-12 h-12 rounded-full shadow-lg flex items-center justify-center hover:scale-105 active:scale-95 transition-all"><Icon name="plus" /></button>
                            </div>
                            <div className="flex flex-wrap gap-3">
                                {members.length === 0 ? (
                                    <p className="text-sm text-muted-foreground italic pl-2">加入朋友，開始這段旅程...</p>
                                ) : members.map(m => (
                                    <span key={m} className="bg-muted text-foreground px-5 py-2.5 rounded-full flex items-center gap-3 text-sm font-bold shadow-sm border border-transparent hover:border-border transition-all">
                                        {m} <button onClick={() => removeMember(m)} className="text-muted-foreground/70 hover:text-destructive transition-colors"><Icon name="x" className="w-3.5 h-3.5" /></button>
                                    </span>
                                ))}
                            </div>
                        </section>

                        {/* 2. 紀錄支出 */}
                        <section className="bg-[#FEFEFA] rounded-organic border border-border/50 p-6 shadow-soft space-y-6 relative overflow-hidden">
                             <div className="absolute bottom-0 left-0 w-40 h-40 bg-primary/5 rounded-full blur-3xl -translate-x-1/2 translate-y-1/2 pointer-events-none"></div>

                            <h2 className="text-xl font-serif font-bold flex items-center gap-3 text-foreground">
                                <div className="p-2 bg-secondary/10 rounded-xl text-secondary"><Icon name="coffee" className="w-5 h-5" /></div> 紀錄足跡
                            </h2>
                            
                            <div className="space-y-4 relative z-10">
                                <div className="relative group">
                                    <label className="text-xs font-bold text-muted-foreground ml-4 mb-1 block uppercase tracking-wider">項目</label>
                                    <input type="text" value={form.item} onChange={e => setForm({...form, item: e.target.value})} placeholder="例如：山間小食、車票..." className="w-full px-6 py-3 bg-white/50 border border-border rounded-full outline-none text-base transition-all focus:bg-white" />
                                </div>
                                
                                <div className="flex gap-3">
                                    <div className="w-[40%]">
                                        <label className="text-xs font-bold text-muted-foreground ml-4 mb-1 block uppercase tracking-wider">幣別</label>
                                        <div className="relative">
                                            <select value={form.currency} onChange={e => setForm({...form, currency: e.target.value})} className="w-full px-5 py-3 bg-white/50 border border-border rounded-full text-base outline-none appearance-none focus:bg-white transition-all">
                                                {CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.code}</option>)}
                                            </select>
                                            <Icon name="chevron-down" className="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground pointer-events-none" />
                                        </div>
                                    </div>
                                    <div className="flex-1 relative">
                                        <label className="text-xs font-bold text-muted-foreground ml-4 mb-1 block uppercase tracking-wider">金額</label>
                                        <span className="absolute left-5 top-[2.2rem] text-muted-foreground text-sm">{CURRENCIES.find(c => c.code === form.currency)?.symbol}</span>
                                        <input type="text" value={form.amount} onChange={e => /^\d*\.?\d*$/.test(e.target.value) && setForm({...form, amount: e.target.value})} placeholder="0" className="w-full pl-12 pr-6 py-3 bg-white/50 border border-border rounded-full text-xl font-bold outline-none text-right focus:bg-white transition-all text-primary" />
                                    </div>
                                </div>

                                <div className="bg-muted/30 px-5 py-3 rounded-2xl border border-border/30 flex justify-between items-center text-sm text-muted-foreground">
                                    <span className="flex items-center gap-2"><Icon name="trending-up" className="w-3 h-3" /> 匯率</span>
                                    <span className="font-mono text-xs font-bold">1 {form.currency} ≈ {rates[form.currency] || '1.00'} TWD</span>
                                </div>
                            </div>

                            <div className="space-y-3 relative z-10">
                                <label className="text-xs font-bold text-muted-foreground ml-1 uppercase tracking-wider">由誰預付</label>
                                <div className="flex flex-wrap gap-2">
                                    {members.map(m => (
                                        <button key={m} onClick={() => setForm({...form, payer: m})} 
                                            className={`px-5 py-2 rounded-full text-sm font-bold transition-all duration-300 ${form.payer === m ? 'bg-primary text-primary-foreground shadow-lg scale-105' : 'bg-white border border-border text-muted-foreground hover:border-primary/50'}`}>
                                            {m}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="space-y-3 relative z-10">
                                <label className="text-xs font-bold text-muted-foreground ml-1 uppercase tracking-wider">誰要分攤</label>
                                <div className="flex flex-wrap gap-2">
                                    {members.map(m => (
                                        <button key={m} onClick={() => toggleParticipant(m)} 
                                            className={`px-5 py-2 rounded-full text-sm font-bold transition-all duration-300 ${form.participants.includes(m) ? 'bg-secondary text-white shadow-md' : 'bg-white border border-border text-muted-foreground hover:border-secondary/50'}`}>
                                            {m}
                                        </button>
                                    ))}
                                    <button onClick={() => setForm({...form, participants: [...members]})} className="text-xs text-primary font-bold px-3 hover:underline underline-offset-4 decoration-wavy decoration-primary/30">全選</button>
                                </div>
                            </div>

                            <button onClick={submitExpense} disabled={!form.item || !form.amount || !form.payer || form.participants.length === 0} 
                                className="w-full bg-primary text-primary-foreground py-4 rounded-full text-lg shadow-soft font-bold disabled:opacity-50 disabled:cursor-not-allowed hover:scale-[1.02] hover:shadow-lg active:scale-95 transition-all duration-300 tracking-wide mt-4">
                                記錄並同步
                            </button>
                        </section>

                        {/* 累計看板 */}
                        <section className="bg-primary rounded-[2.5rem] p-8 shadow-float text-center text-primary-foreground relative overflow-hidden group">
                            {/* 裝飾圓圈 */}
                            <div className="absolute top-[-20%] left-[-10%] w-40 h-40 bg-white/10 rounded-full blur-xl"></div>
                            <div className="absolute bottom-[-20%] right-[-10%] w-40 h-40 bg-white/10 rounded-full blur-xl"></div>
                            
                            <h3 className="text-xs text-primary-foreground/70 font-bold tracking-[0.2em] uppercase mb-2">Total Trip Expenditure</h3>
                            
                            <div className="text-5xl font-serif font-bold flex items-center justify-center gap-2 mb-2">
                                <span className="text-2xl opacity-60 font-sans tracking-tight">
                                    {settlement.primaryCode && settlement.primaryCode !== 'TWD' ? CURRENCIES.find(c => c.code === settlement.primaryCode)?.symbol : 'TWD'}
                                </span> 
                                {formatNum(settlement.primaryCode && settlement.primaryCode !== 'TWD' ? settlement.totalTWD / settlement.primaryRate : settlement.totalTWD)}
                            </div>
                            
                            {settlement.primaryCode && settlement.primaryCode !== 'TWD' && (
                                <div className="inline-block bg-black/10 backdrop-blur-sm px-4 py-1.5 rounded-full text-sm font-medium border border-white/10">
                                    ≈ TWD {formatNum(settlement.totalTWD)}
                                </div>
                            )}

                            <div className="mt-6 flex justify-center">
                                <div className="bg-white/20 backdrop-blur-md px-5 py-2 rounded-full flex items-center gap-2 text-sm font-bold border border-white/20">
                                    <Icon name="scroll" className="w-4 h-4" /> {expenses.length} 筆回憶
                                </div>
                            </div>
                        </section>

                        {/* 3. 支出明細 */}
                        <section className="space-y-6">
                            <div className="flex justify-between items-center px-4">
                                <h2 className="text-xl font-serif font-bold flex items-center gap-3 text-foreground"><Icon name="history" className="text-muted-foreground" /> 明細</h2>
                                <button onClick={() => setShowClearConfirm(true)} className="flex items-center gap-1.5 text-xs font-bold text-muted-foreground hover:text-destructive transition-colors px-3 py-1.5 hover:bg-destructive/10 rounded-full">
                                    <Icon name="trash-2" className="w-3.5 h-3.5" /> 清除
                                </button>
                            </div>
                            <div className="space-y-4">
                                {expenses.length === 0 ? (
                                    <div className="py-16 text-center">
                                        <div className="text-muted-foreground/30 mb-2"><Icon name="leaf" className="w-12 h-12 mx-auto" /></div>
                                        <p className="text-muted-foreground font-serif text-lg">尚未有紀錄</p>
                                    </div>
                                ) : expenses.map((exp, idx) => {
                                    return (
                                        <div key={exp.id} className="bg-white rounded-[2rem] p-5 shadow-sm border border-border/40 hover:border-primary/30 hover:shadow-soft transition-all duration-300 group">
                                            <div className="flex justify-between items-start mb-4">
                                                <div className="flex items-start gap-4">
                                                    <div className="bg-muted w-10 h-10 rounded-full flex items-center justify-center text-muted-foreground font-serif font-bold text-lg shrink-0 group-hover:bg-primary group-hover:text-primary-foreground transition-colors">
                                                        {idx + 1}
                                                    </div>
                                                    <div>
                                                        <h3 className="text-lg font-bold text-foreground leading-tight">{exp.item}</h3>
                                                        <div className="text-xs text-muted-foreground mt-1 flex items-center gap-2">
                                                            <span>{exp.timestamp}</span>
                                                            {exp.currency !== 'TWD' && <span className="bg-muted/50 px-1.5 py-0.5 rounded text-[10px]">Ex: {exp.rate}</span>}
                                                        </div>
                                                    </div>
                                                </div>
                                                <button onClick={() => setDeleteTargetId(exp.id)} className="text-border hover:text-destructive p-2 transition-colors"><Icon name="x-circle" className="w-5 h-5" /></button>
                                            </div>

                                            <div className="pl-14">
                                                <div className="flex items-baseline gap-2 mb-3">
                                                    <span className="text-sm text-muted-foreground">由 <strong className="text-primary">{exp.payer}</strong> 支付</span>
                                                    <span className="text-xl font-serif font-bold text-foreground">
                                                        {CURRENCIES.find(c => c.code === exp.currency)?.symbol} {formatNum(exp.amount)}
                                                    </span>
                                                </div>

                                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                                    {Object.entries(exp.splits).map(([name, amt]) => (
                                                        <div key={name} className="flex justify-between items-center bg-[#FDFCF8] px-4 py-2 rounded-xl border border-border/30 text-sm">
                                                            <span className="text-muted-foreground font-medium">{name}</span>
                                                            <span className="font-bold text-foreground/80">{CURRENCIES.find(c => c.code === exp.currency)?.symbol} {formatNum(amt)}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </section>

                        {/* 4. 結算統計 */}
                        <section className="space-y-6">
                            <div className="flex justify-between items-center px-4">
                                <h2 className="text-xl font-serif font-bold flex items-center gap-3 text-foreground"><Icon name="check-circle-2" className="text-primary" /> 最終結算</h2>
                                <button onClick={copyToClipboard} className="flex items-center gap-2 text-xs font-bold text-primary-foreground bg-primary px-5 py-2.5 rounded-full hover:bg-primary/90 shadow-lg active:scale-95 transition-all"><Icon name="copy" className="w-3.5 h-3.5" /> 複製文字</button>
                            </div>
                            
                            <div className="bg-[#FEFEFA] rounded-[2.5rem] border border-border/60 shadow-float overflow-hidden relative">
                                <div className="absolute top-0 w-full h-1 bg-gradient-to-r from-primary via-secondary to-primary opacity-50"></div>
                                <div className="p-6 sm:p-8 space-y-6">
                                    <div className="text-center pb-6 border-b border-dashed border-border/60">
                                        <h4 className="text-sm text-primary font-bold tracking-[0.2em] uppercase">Settlement Plan</h4>
                                        <p className="text-xs text-muted-foreground mt-1">Happy Travel • Fair Sharing</p>
                                    </div>

                                    {settlement.transactions.map((t, i) => (
                                        <div key={i} className="flex flex-col sm:flex-row items-center justify-between p-5 bg-white rounded-3xl border border-border/40 gap-4 shadow-sm hover:shadow-md transition-all">
                                            <div className="flex items-center gap-3 w-full sm:w-auto justify-center">
                                                <div className="text-center">
                                                    <div className="text-sm font-bold text-foreground bg-muted/30 px-4 py-1.5 rounded-full border border-border/20">{t.from}</div>
                                                </div>
                                                <Icon name="arrow-right" className="text-muted-foreground/50" />
                                                <div className="text-center">
                                                    <div className="text-sm font-bold text-foreground bg-muted/30 px-4 py-1.5 rounded-full border border-border/20">{t.to}</div>
                                                </div>
                                            </div>

                                            <div className="flex flex-col items-center sm:items-end">
                                                <div className="text-2xl font-serif font-bold text-secondary flex items-baseline gap-1">
                                                    <span className="text-sm font-sans font-medium opacity-60">
                                                         {settlement.primaryCode && settlement.primaryCode !== 'TWD' ? CURRENCIES.find(c => c.code === settlement.primaryCode)?.symbol : 'TWD'}
                                                    </span> 
                                                    {formatNum(settlement.primaryCode && settlement.primaryCode !== 'TWD' ? t.amount / settlement.primaryRate : t.amount)}
                                                </div>
                                                {settlement.primaryCode && settlement.primaryCode !== 'TWD' && (
                                                    <span className="text-xs text-muted-foreground mt-0.5">≈ TWD {formatNum(t.amount)}</span>
                                                )}
                                            </div>
                                        </div>
                                    ))}

                                    {settlement.transactions.length === 0 && (
                                        <div className="text-center py-8 text-muted-foreground font-serif italic bg-muted/20 rounded-3xl">所有帳目均已結清</div>
                                    )}
                                </div>
                            </div>
                        </section>
                    </main>

                    {/* Toast 訊息 */}
                    {toast && (
                        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-foreground text-background px-8 py-3 rounded-full shadow-2xl z-[150] font-bold text-sm tracking-wide animate-bounce border border-white/10">
                            {toast}
                        </div>
                    )}

                    {/* 刪除確認視窗 */}
                    {deleteTargetId && (
                        <div className="fixed inset-0 bg-background/80 backdrop-blur-sm z-[100] flex items-center justify-center p-6">
                            <div className="bg-white rounded-[2.5rem] p-8 max-w-sm w-full shadow-float border border-border scale-up-center text-center">
                                <div className="w-16 h-16 bg-destructive/10 rounded-full flex items-center justify-center mx-auto mb-4 text-destructive">
                                    <Icon name="alert-triangle" />
                                </div>
                                <h3 className="text-xl font-serif font-bold text-foreground mb-2">確認刪除？</h3>
                                <p className="text-muted-foreground text-sm mb-8">這筆紀錄將會永久移除。</p>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setDeleteTargetId(null)} className="py-3 text-muted-foreground font-bold hover:bg-muted/50 rounded-2xl transition-colors">取消</button>
                                    <button onClick={confirmDeleteExpense} className="py-3 bg-destructive text-white font-bold rounded-2xl hover:shadow-lg hover:scale-105 transition-all">刪除</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 登出確認視窗 */}
                    {showLogoutConfirm && (
                        <div className="fixed inset-0 bg-background/80 backdrop-blur-sm z-[100] flex items-center justify-center p-6">
                            <div className="bg-white rounded-[2.5rem] p-8 max-w-sm w-full shadow-float border border-border scale-up-center text-center">
                                <h3 className="text-xl font-serif font-bold text-primary mb-2">暫時離開？</h3>
                                <p className="text-muted-foreground text-sm mb-8">資料已安全保存在雲端，隨時可以回來。</p>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setShowLogoutConfirm(false)} className="py-3 text-muted-foreground font-bold hover:bg-muted/50 rounded-2xl transition-colors">取消</button>
                                    <button onClick={confirmLogout} className="py-3 bg-primary text-primary-foreground font-bold rounded-2xl hover:shadow-lg hover:scale-105 transition-all">登出</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 清除全部確認 */}
                    {showClearConfirm && (
                        <div className="fixed inset-0 bg-background/80 backdrop-blur-sm z-[100] flex items-center justify-center p-6">
                            <div className="bg-white rounded-[2.5rem] p-8 max-w-sm w-full shadow-float border border-border scale-up-center text-center">
                                <h3 className="text-xl font-serif font-bold text-destructive mb-2">清空所有紀錄？</h3>
                                <p className="text-muted-foreground text-sm mb-8">此操作無法復原，請確保所有人都已經完成對帳。</p>
                                <div className="flex flex-col gap-3">
                                    <button onClick={clearAllData} className="w-full py-4 bg-destructive text-white font-bold rounded-2xl shadow-lg hover:scale-105 transition-all">確認清空</button>
                                    <button onClick={() => setShowClearConfirm(false)} className="w-full py-3 text-muted-foreground font-bold hover:bg-muted/50 rounded-2xl transition-colors">取消</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>