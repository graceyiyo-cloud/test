<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的雲端書櫃</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        paper: '#f2f0e9',
                        ink: '#373a36',
                        sub: '#6b705c',
                        wood: {
                            100: '#e9e7da', 200: '#dad7cd', 300: '#a3b18a', 400: '#588157', 500: '#3a5a40', 600: '#344e41',
                        },
                        sage: {
                            50: '#f0f4ef', 100: '#e0e9e1', 200: '#c5d5c5', 500: '#84a59d', 600: '#6b8a82', text: '#4a5d5a'
                        },
                        dried: {
                            50: '#f7f2f2', 100: '#ede0e0', 200: '#d9bfbf', 500: '#b5838d', 600: '#a0717a', text: '#6d4c51'
                        },
                        stone: {
                            50: '#f5f5f4', 100: '#e7e7e2', 200: '#dcdcc6', 400: '#a7a797', 500: '#7f7f6f', 600: '#5f5f54', text: '#4a4a40'
                        },
                        gold: { 400: '#d4a373', 500: '#bc8a5f' }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-down { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-modal-in { animation: modalIn 0.2s ease-out forwards; }
        html { font-size: 90%; background-color: #f2f0e9; }
        @media (max-width: 768px) {
            html { font-size: 120%; }
            input, select, textarea { padding-top: 0.6rem; padding-bottom: 0.6rem; }
        }
        input, textarea, select { font-size: 1rem !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .soft-shadow { box-shadow: 0 4px 12px -2px rgba(58, 90, 64, 0.08); }
    </style>
</head>
<body class="bg-paper text-ink selection:bg-wood-200 selection:text-ink pb-10">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            BookOpen, Search, Plus, Trash2, CheckCircle, BookX, 
            Calendar, User, LogIn, RefreshCw, TrendingUp, Link as LinkIcon, FileText, PenTool, Trophy, Hourglass, Star, X, Tag, RotateCcw, AlertTriangle, Filter, LogOut, MessageSquare, Edit3, FileUp
        } from 'https://esm.sh/lucide-react@0.344.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, serverTimestamp, writeBatch } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDX1-Lwc5_u_fwV9P25xh32dVF8uVNT0QU",
            authDomain: "my-reading-tracker-58f69.firebaseapp.com",
            projectId: "my-reading-tracker-58f69",
            storageBucket: "my-reading-tracker-58f69.firebasestorage.app",
            messagingSenderId: "370802674969",
            appId: "1:370802674969:web:efb1c045e0028925154988",
            measurementId: "G-52EWLNG7ST"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "my-reading-app"; 

        const DEFAULT_CATEGORIES = ["玄幻", "奇幻", "武俠", "仙俠", "都市", "言情", "古代", "架空", "科幻", "懸疑", "推理", "驚悚", "恐怖", "冒險", "耽美 (BL)", "百合 (GL)", "穿越", "重生", "系統", "快穿", "無限流", "末世", "種田", "宅鬥", "宮鬥", "娛樂圈", "電競", "校園", "職場", "先婚後愛", "破鏡重圓", "青梅竹馬", "異能", "空間", "甜寵", "虐戀", "爽文", "升級流", "治癒", "輕鬆", "沙雕"];

        const CategoryPicker = ({ selectedCategories, onToggle, allCategories, onAddNew, onDelete }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [filterText, setFilterText] = useState('');
            const filtered = useMemo(() => allCategories.filter(c => c.toLowerCase().includes(filterText.toLowerCase())), [allCategories, filterText]);
            const handleSelect = (cat) => { onToggle(cat); setFilterText(''); };
            return (
                <div className="w-full">
                    <div className="flex flex-wrap gap-2 items-center min-h-[40px] p-2 border-b border-wood-200">
                        {selectedCategories.map(cat => (
                            <span key={cat} className="bg-wood-400 text-white text-xs px-2 py-1 rounded-full flex items-center gap-1 shadow-sm">
                                {cat} <X size={12} className="cursor-pointer hover:text-wood-200" onClick={(e) => { e.stopPropagation(); onToggle(cat); }}/>
                            </span>
                        ))}
                        <button type="button" onClick={() => setIsOpen(!isOpen)} className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full transition-colors ${isOpen ? 'bg-wood-200 text-wood-600' : 'text-wood-500 hover:bg-wood-100'}`}><Plus size={12}/> {isOpen ? '收起' : '選擇分類'}</button>
                    </div>
                    {isOpen && (
                        <div className="mt-2 p-3 bg-stone-50 rounded-xl border border-stone-200 shadow-sm animate-fade-in relative z-10">
                            <input type="text" placeholder="搜尋或建立..." value={filterText} onChange={e => setFilterText(e.target.value)} className="w-full mb-3 p-2 bg-white rounded-lg text-sm outline-none border border-stone-200 focus:ring-1 focus:ring-wood-300" />
                            <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto no-scrollbar content-start">
                                {filterText && !allCategories.includes(filterText) && (
                                    <button type="button" onClick={() => { onAddNew(filterText); setFilterText(''); }} className="bg-wood-500 text-white text-xs px-3 py-1.5 rounded-full hover:bg-wood-600 transition shadow-sm flex items-center gap-1"><Plus size={12}/> 建立「{filterText}」</button>
                                )}
                                {filtered.map(cat => !selectedCategories.includes(cat) && (
                                    <div key={cat} className="group relative">
                                        <button type="button" onClick={() => handleSelect(cat)} className="bg-stone-100 text-stone-600 border border-stone-200 text-xs px-3 py-1.5 rounded-full hover:bg-stone-200 transition">{cat}</button>
                                        <button type="button" onClick={(e) => onDelete(cat, e)} className="absolute -top-1 -right-1 bg-white text-stone-300 hover:text-dried-500 rounded-full p-0.5 shadow-sm border border-stone-100 opacity-0 group-hover:opacity-100 transition-opacity"><X size={10} strokeWidth={3} /></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        function ReadingTracker() {
            const [user, setUser] = useState(null);
            const [books, setBooks] = useState([]);
            const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
            const [loading, setLoading] = useState(true);
            const [customId, setCustomId] = useState('');
            const [isLoginMode, setIsLoginMode] = useState(true);
            const [isAuthChecking, setIsAuthChecking] = useState(true);
            const [toast, setToast] = useState(null); 
            const [searchTerm, setSearchTerm] = useState('');
            const fileInputRef = useRef(null);

            const [newBook, setNewBook] = useState({ title: '', author: '', wordCount: '', isWordCountManual: false, addDate: new Date().toISOString().split('T')[0], reviewUrl: '', synopsis: '', category: [] });
            const [isSearching, setIsSearching] = useState(false);
            const [activeBookId, setActiveBookId] = useState(null);
            const [modalType, setModalType] = useState(null); 
            const [modalData, setModalData] = useState({});
            const [expandedBooks, setExpandedBooks] = useState({});

            useEffect(() => {
                signInAnonymously(auth).catch(e => console.error(e));
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        const savedId = localStorage.getItem('reading_tracker_custom_id');
                        if (savedId) { setCustomId(savedId); setIsLoginMode(false); }
                    }
                    setIsAuthChecking(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !customId) { setLoading(false); return; }
                setLoading(true);
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`);
                return onSnapshot(colRef, (snapshot) => {
                    const fetchedBooks = [];
                    let fetchedCats = [...DEFAULT_CATEGORIES];
                    snapshot.docs.forEach(doc => {
                        if (doc.id === 'settings') { if (doc.data().categories) fetchedCats = doc.data().categories; }
                        else fetchedBooks.push({ id: doc.id, ...doc.data() });
                    });
                    fetchedBooks.sort((a, b) => (a.status === 'reading' ? -1 : 1) || new Date(b.addDate || 0) - new Date(a.addDate || 0));
                    setBooks(fetchedBooks); setCategories(fetchedCats); setLoading(false);
                });
            }, [user, customId]);

            const showToast = (message, type = 'info') => { setToast({ message, type }); setTimeout(() => setToast(null), 3000); };
            const handleLogin = (e) => { e.preventDefault(); if (customId.trim().length < 3) return showToast("ID 太短囉", "error"); localStorage.setItem('reading_tracker_custom_id', customId); setIsLoginMode(false); };
            const handleLogout = () => setModalType('logout');

            // --- 重新修正的匯入邏輯 ---
            const handleImportCSV = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const text = event.target.result;
                    const lines = text.split(/\r?\n/).filter(l => l.trim());
                    if (lines.length <= 1) return;

                    const batch = writeBatch(db);
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`);
                    let importCount = 0;
                    let sysCats = new Set([...categories]);

                    for (let i = 1; i < lines.length; i++) {
                        // 使用更強大的正則表達式解析 CSV，正確處理引號內的逗號
                        const regex = /(".*?"|[^",\s]+)(?=\s*,|\s*$)/g;
                        const row = lines[i];
                        let cols = [];
                        let m;
                        while ((m = regex.exec(row)) !== null) {
                            cols.push(m[1].replace(/^"|"$/g, '').trim());
                        }

                        // 如果正則解析失敗，退回普通切割
                        if (cols.length < 2) cols = row.split(',').map(c => c.trim().replace(/^"|"$/g, ''));

                        // A書名0, B作者1, C心得2, D大綱3, E字數4, F完讀日5, G狀態6, H評分7, I類型8
                        const [title, author, review, synopsis, wordCount, finishDate, statusRaw, ratingRaw, typeRaw] = cols;
                        if (!title) continue;

                        const bookCats = typeRaw ? typeRaw.split(/[，,]/).map(t => t.trim()).filter(t => t) : [];
                        bookCats.forEach(c => sysCats.add(c));

                        const bookData = {
                            title,
                            author: author || '',
                            review: review || '',
                            synopsis: synopsis || '',
                            wordCount: wordCount || '',
                            addDate: new Date().toISOString().split('T')[0],
                            createdAt: serverTimestamp(),
                            category: bookCats
                        };

                        // 狀態判斷
                        if (statusRaw === '棄文') {
                            bookData.status = 'dropped';
                            bookData.dropDate = finishDate || bookData.addDate;
                            bookData.dropChapter = '未知';
                        } else if (statusRaw === '完讀' || finishDate) {
                            bookData.status = 'finished';
                            bookData.finishDate = finishDate || bookData.addDate;
                            const score = parseFloat(ratingRaw);
                            bookData.rating = !isNaN(score) ? Math.min(5, Math.max(0, score / 2)) : 0;
                        } else {
                            bookData.status = 'reading';
                        }

                        batch.set(doc(colRef), bookData);
                        importCount++;
                    }

                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`, 'settings'), { categories: Array.from(sysCats) }, { merge: true });
                        await batch.commit();
                        showToast(`成功匯入 ${importCount} 本書籍！`);
                    } catch (err) { showToast("匯入失敗", "error"); }
                    e.target.value = null;
                };
                reader.readAsText(file);
            };

            const searchBookInfo = async () => {
                if (!newBook.title) return; setIsSearching(true);
                try {
                    const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=intitle:${newBook.title}${newBook.author ? `+inauthor:${newBook.author}` : ''}&maxResults=1`);
                    const data = await res.json();
                    if (data.items?.length > 0) {
                        const info = data.items[0].volumeInfo;
                        setNewBook(prev => ({ ...prev, author: prev.author || info.authors?.[0] || '', wordCount: (info.pageCount || 0) * 350, synopsis: info.description || '' }));
                        showToast("找到資料！");
                    } else showToast("找不到資料", "error");
                } catch (e) { showToast("搜尋失敗", "error"); } finally { setIsSearching(false); }
            };

            const addBook = async (e) => {
                e.preventDefault(); if (!newBook.title || !customId) return;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`), { ...newBook, status: 'reading', createdAt: serverTimestamp() });
                    setNewBook({ title: '', author: '', wordCount: '', isWordCountManual: false, addDate: new Date().toISOString().split('T')[0], reviewUrl: '', synopsis: '', category: [] });
                    showToast("新增成功！");
                } catch (e) { showToast("新增失敗", "error"); }
            };

            const handleModalAction = async () => {
                if (!modalType) return;
                try {
                    if (modalType === 'logout') { localStorage.removeItem('reading_tracker_custom_id'); setCustomId(''); setBooks([]); setIsLoginMode(true); }
                    else if (modalType === 'deleteCategory') { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`, 'settings'), { categories: categories.filter(c => c !== modalData.category) }, { merge: true }); }
                    else if (activeBookId) {
                        const ref = doc(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`, activeBookId);
                        if (modalType === 'delete') await deleteDoc(ref);
                        else if (modalType === 'edit') await updateDoc(ref, { title: modalData.title, author: modalData.author, category: modalData.category, wordCount: modalData.wordCount, addDate: modalData.addDate, synopsis: modalData.synopsis });
                        else {
                            const up = {};
                            if (modalType === 'finish') { up.status = 'finished'; up.finishDate = modalData.date; up.rating = modalData.rating; up.review = modalData.review || ''; }
                            else if (modalType === 'drop') { up.status = 'dropped'; up.dropChapter = modalData.chapter; up.dropDate = modalData.date; }
                            else if (modalType === 'reset') { up.status = 'reading'; up.finishDate = null; up.dropChapter = null; up.dropDate = null; up.rating = null; up.review = null; }
                            await updateDoc(ref, up);
                        }
                    }
                    closeModal();
                } catch (e) { showToast("操作失敗", "error"); }
            };

            const openModal = (book, type, e) => { e?.stopPropagation(); setActiveBookId(book.id); setModalType(type); setModalData(type === 'edit' ? { ...book } : { date: new Date().toISOString().split('T')[0], chapter: '', rating: 0, review: book.review || '' }); };
            const closeModal = () => { setActiveBookId(null); setModalType(null); setModalData({}); };
            const StarRating = ({ rating, setRating, interactive = false }) => (
                <div className="flex gap-1">
                    {[1, 2, 3, 4, 5].map((idx) => (
                        <div key={idx} className={`relative ${interactive ? 'cursor-pointer active:scale-90' : ''}`} onClick={(e) => { if (interactive) { const r = e.currentTarget.getBoundingClientRect(); setRating((e.clientX - r.left) < r.width / 2 ? idx - 0.5 : idx); } }}>
                            <Star size={interactive ? 32 : 16} className="text-stone-200"/>
                            <div className="absolute top-0 left-0 overflow-hidden" style={{ width: rating >= idx ? '100%' : rating >= idx - 0.5 ? '50%' : '0%' }}><Star size={interactive ? 32 : 16} className="fill-gold-400 text-gold-400"/></div>
                        </div>
                    ))}
                </div>
            );

            if (isAuthChecking) return <div className="min-h-screen flex items-center justify-center bg-paper"><RefreshCw className="animate-spin text-wood-400" /></div>;
            if (isLoginMode) return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-paper">
                    <div className="bg-white/60 p-8 rounded-3xl shadow-lg border border-stone-200 w-full max-w-md text-center">
                        <BookOpen size={56} className="mx-auto mb-6 text-wood-400" />
                        <h1 className="text-3xl font-bold mb-3">雲端書櫃</h1>
                        <form onSubmit={handleLogin} className="space-y-5">
                            <input value={customId} onChange={e=>setCustomId(e.target.value)} placeholder="使用者 ID" className="w-full p-3 bg-white/50 border-b-2 border-stone-200 text-center text-lg rounded-t-lg outline-none focus:border-wood-300" />
                            <button type="submit" className="w-full bg-wood-400 text-white py-3 rounded-xl font-bold shadow-md"><LogIn className="inline mr-2"/> 開啟書櫃</button>
                        </form>
                    </div>
                </div>
            );

            const stats = {
                reading: books.filter(b => b.status === 'reading').length,
                finished: books.filter(b => b.status === 'finished').length,
                dropped: books.filter(b => b.status === 'dropped').length
            };

            return (
                <div className="min-h-screen bg-paper relative">
                    {toast && <div className={`fixed top-20 md:top-4 left-1/2 -translate-x-1/2 px-4 py-3 rounded-xl shadow-xl z-50 animate-fade-in-down text-white text-sm font-bold flex items-center gap-2 ${toast.type === 'error' ? 'bg-dried-500' : 'bg-wood-400'}`}>{toast.type === 'error' ? <AlertTriangle size={16}/> : <CheckCircle size={16}/>}{toast.message}</div>}
                    <header className="bg-paper/80 backdrop-blur sticky top-0 z-20 border-b border-stone-200">
                        <div className="max-w-3xl mx-auto px-4 py-4 flex justify-between items-center font-bold">
                            <div className="flex items-center gap-3 text-xl tracking-widest"><BookOpen className="text-wood-400" /><span>閱讀手帳</span></div>
                            <div className="flex items-center gap-3"><div className="text-xs text-sub bg-stone-100 px-3 py-1 rounded-full">ID: {customId}</div><button onClick={handleLogout} className="text-stone-400 hover:text-ink"><LogOut size={20}/></button></div>
                        </div>
                    </header>
                    <main className="max-w-3xl mx-auto px-4 py-6 space-y-8">
                        <section className="grid grid-cols-2 gap-3 md:gap-4">
                            <div className="bg-white/50 p-4 rounded-2xl border border-stone-200 soft-shadow relative overflow-hidden"><Hourglass className="absolute right-0 top-0 p-3 opacity-5 text-wood-500" size={40}/><div className="text-xs text-sub mb-1">待讀/未讀</div><div className="text-3xl font-bold text-stone-600">{stats.reading} <span className="text-xs font-normal">本</span></div></div>
                            <div className="bg-sage-50 p-4 rounded-2xl border border-sage-100 soft-shadow relative overflow-hidden"><Trophy className="absolute right-0 top-0 p-3 opacity-10 text-wood-500" size={40}/><div className="text-xs text-wood-400 mb-1">完食累積</div><div className="text-3xl font-bold text-ink">{stats.finished} <span className="text-xs font-normal">本</span></div>{stats.dropped > 0 && <div className="text-[10px] text-dried-500 text-right">棄書 {stats.dropped}</div>}</div>
                        </section>
                        <section className="bg-white/80 rounded-2xl border border-stone-200 p-5 md:p-8 soft-shadow">
                            <div className="flex justify-between items-center mb-6 font-bold"><h2 className="text-lg border-l-4 border-wood-300 pl-3">紀錄新書</h2><button onClick={() => fileInputRef.current?.click()} className="text-xs flex items-center gap-1.5 px-3 py-1.5 bg-stone-100 text-stone-500 hover:bg-stone-200 rounded-lg"><FileUp size={14} /> 匯入 Excel (CSV)</button><input type="file" ref={fileInputRef} onChange={handleImportCSV} accept=".csv" className="hidden" /></div>
                            <form onSubmit={addBook} className="grid grid-cols-1 md:grid-cols-12 gap-4">
                                <div className="md:col-span-5"><input placeholder="書名" value={newBook.title} onChange={e=>setNewBook({...newBook, title:e.target.value})} className="w-full p-2 bg-transparent border-b border-stone-200 outline-none focus:border-wood-300" required /></div>
                                <div className="md:col-span-4"><input placeholder="作者" value={newBook.author} onChange={e=>setNewBook({...newBook, author:e.target.value})} className="w-full p-2 bg-transparent border-b border-stone-200 outline-none focus:border-wood-300" /></div>
                                <div className="md:col-span-3"><button type="button" onClick={searchBookInfo} disabled={isSearching || !newBook.title} className="w-full h-full text-wood-500 bg-stone-100 hover:bg-stone-200 rounded-lg text-sm py-2">{isSearching ? <RefreshCw className="animate-spin w-4 h-4 mx-auto" /> : "搜尋資料"}</button></div>
                                <div className="md:col-span-12"><CategoryPicker selectedCategories={newBook.category} onToggle={(cat) => setNewBook(prev => ({ ...prev, category: prev.category.includes(cat) ? prev.category.filter(c => c !== cat) : [...prev.category, cat] }))} allCategories={categories} onAddNew={async (n) => { const name = n.trim(); if(name && !categories.includes(name)) { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`, 'settings'), { categories: [...categories, name] }, { merge: true }); setNewBook(p => ({ ...p, category: [...p.category, name] })); } }} onDelete={(cat, e) => { e.stopPropagation(); setModalData({ category: cat }); setModalType('deleteCategory'); }} /></div>
                                <div className="md:col-span-12 flex justify-end"><button type="submit" className="w-full md:w-auto bg-wood-400 text-white px-8 py-2.5 rounded-xl font-medium shadow-md">+ 加入書櫃</button></div>
                            </form>
                        </section>
                        <section className="space-y-4">
                            <div className="flex items-center gap-2 bg-white/60 px-3 py-2 rounded-xl border border-stone-200 soft-shadow"><Filter size={16} className="text-stone-400" /><input type="text" placeholder="搜尋書名、作者、類型..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="bg-transparent outline-none w-full text-sm" /></div>
                            <div className="grid grid-cols-1 gap-4">
                                {books.filter(b => b.title.toLowerCase().includes(searchTerm.toLowerCase()) || b.author.toLowerCase().includes(searchTerm.toLowerCase()) || b.category?.some(c => c.toLowerCase().includes(searchTerm.toLowerCase()))).map(book => (
                                    <div key={book.id} className="group bg-white p-4 md:p-6 rounded-2xl border border-stone-200 soft-shadow flex flex-col md:flex-row gap-4 relative overflow-hidden animate-fade-in">
                                        <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${book.status==='finished'?'bg-sage-500': book.status==='dropped'?'bg-dried-500': 'bg-stone-300'}`}></div>
                                        <div className="flex-1 pl-3 md:pl-0">
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <div className="flex flex-wrap gap-2 mb-1">{book.category?.map((cat, idx) => (<span key={idx} className="text-[10px] text-stone-500 bg-stone-100 px-2 py-0.5 rounded-sm">{cat}</span>))}<span className={`px-2 py-0.5 rounded-full text-[10px] ${book.status==='finished'?'bg-sage-100 text-sage-text': book.status==='dropped'?'bg-dried-100 text-dried-text': 'bg-stone-100 text-stone-500'}`}>{book.status==='finished'?'已完食':book.status==='dropped'?'棄書':'待讀'}</span></div>
                                                    <h3 className="font-bold text-lg text-ink">{book.title}</h3>
                                                </div>
                                                {book.status === 'finished' && book.rating > 0 && <StarRating rating={book.rating} />}
                                            </div>
                                            <div className="text-sm text-sub space-y-2">
                                                <div className="flex gap-4 text-xs opacity-70"><span><User size={12} className="inline mr-1"/>{book.author||'佚名'}</span><span><TrendingUp size={12} className="inline mr-1"/>{book.wordCount ? `${Number(book.wordCount).toLocaleString()}字` : '字數未知'}</span></div>
                                                {book.status === 'finished' && <div className="bg-sage-50/50 p-3 rounded-lg border border-sage-100 text-xs"><p className="text-sage-text font-medium flex items-center gap-2"><CheckCircle size={14}/> 完食日期: {book.finishDate}</p>{book.review && <p className="text-sage-600 mt-1 pl-5 border-l-2 border-sage-200">{book.review}</p>}</div>}
                                                {book.status === 'dropped' && <div className="text-dried-text bg-dried-50/50 p-2 rounded-lg border border-dried-100 text-xs font-medium"><BookX size={14} className="inline mr-2"/>棄書紀錄: {book.dropDate}</div>}
                                                {book.synopsis && <div className="mt-2 pt-2 border-t border-stone-100 border-dashed"><button onClick={()=>toggleSynopsis(book.id)} className="flex items-center gap-1.5 text-xs text-stone-400 py-1"><FileText size={12}/> {expandedBooks[book.id] ? '收起大綱' : '展開大綱'}</button>{expandedBooks[book.id] && <p className="text-xs text-sub leading-relaxed bg-stone-50/50 p-3 rounded-lg whitespace-pre-wrap">{book.synopsis}</p>}</div>}
                                            </div>
                                        </div>
                                        <div className="flex flex-row md:flex-col gap-2 shrink-0 md:w-32">
                                            {book.status === 'reading' ? (<><button onClick={()=>openModal(book, 'finish')} className="flex-1 py-2 bg-sage-100 text-sage-600 rounded-lg text-xs font-medium border border-sage-200">完食</button><button onClick={()=>openModal(book, 'drop')} className="flex-1 py-2 bg-dried-100 text-dried-600 rounded-lg text-xs font-medium border border-dried-200">棄書</button></>) : (<button onClick={()=>openModal(book, 'reset')} className="flex-1 py-2 bg-stone-100 text-stone-600 rounded-lg text-xs font-medium border border-stone-200">重設</button>)}
                                            <div className="flex gap-2 flex-1 md:w-full"><button onClick={()=>openModal(book, 'edit')} className="flex-1 py-2 bg-white text-stone-400 border border-stone-200 rounded-lg flex items-center justify-center"><Edit3 size={16} /></button><button onClick={()=>openModal(book, 'delete')} className="flex-1 py-2 bg-white text-stone-300 border border-stone-200 rounded-lg flex items-center justify-center"><Trash2 size={16} /></button></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                        {(activeBookId || modalType === 'logout' || modalType === 'deleteCategory') && (
                            <div className="fixed inset-0 bg-stone-800/20 backdrop-blur-sm flex items-end md:items-center justify-center z-50 p-0 md:p-4" onClick={closeModal}>
                                <div className="bg-paper rounded-t-3xl md:rounded-3xl w-full max-w-sm p-6 shadow-2xl animate-modal-in overflow-y-auto no-scrollbar" onClick={e => e.stopPropagation()}>
                                    <h3 className="text-xl font-bold mb-4 text-center border-b pb-4">{modalType === 'finish' ? '紀錄完食' : modalType === 'drop' ? '紀錄棄書' : modalType === 'reset' ? '重設狀態' : modalType === 'delete' ? '刪除書籍' : modalType === 'logout' ? '登出確認' : modalType === 'deleteCategory' ? '刪除分類' : '編輯書籍'}</h3>
                                    <div className="mb-6">
                                        {modalType === 'edit' && (<div className="space-y-4"><input placeholder="書名" value={modalData.title} onChange={e=>setModalData({...modalData, title:e.target.value})} className="w-full p-2 bg-white/50 border-b outline-none" /><input placeholder="作者" value={modalData.author} onChange={e=>setModalData({...modalData, author:e.target.value})} className="w-full p-2 bg-white/50 border-b outline-none" /><textarea placeholder="大綱" value={modalData.synopsis} onChange={e=>setModalData({...modalData, synopsis:e.target.value})} className="w-full p-3 bg-white/50 rounded-lg h-24 resize-none border" /></div>)}
                                        {modalType === 'finish' && (<div className="bg-white/50 p-4 rounded-xl space-y-5 text-center"><input type="date" value={modalData.date} onChange={e=>setModalData({...modalData, date:e.target.value})} className="w-full bg-transparent border-b p-2" /><StarRating rating={modalData.rating} setRating={(r) => setModalData({...modalData, rating: r})} interactive={true} /><textarea placeholder="心得..." value={modalData.review} onChange={e=>setModalData({...modalData, review:e.target.value})} className="w-full p-2 mt-4 border h-20 text-sm rounded-lg" /></div>)}
                                        {modalType === 'drop' && (<div className="bg-white/50 p-4 rounded-xl space-y-4"><input type="date" value={modalData.date} onChange={e=>setModalData({...modalData, date:e.target.value})} className="w-full bg-transparent border-b p-2 text-center" /></div>)}
                                        {['reset', 'delete', 'logout', 'deleteCategory'].includes(modalType) && (<div className="text-center p-4 font-bold"><p>{modalData.category || books.find(b=>b.id===activeBookId)?.title}</p><p className="text-sm font-normal text-sub mt-2">確定執行此操作？</p></div>)}
                                    </div>
                                    <div className="flex gap-4"><button onClick={closeModal} className="flex-1 py-3 text-sub hover:bg-stone-100 rounded-xl transition">取消</button><button onClick={handleModalAction} className={`flex-1 py-3 text-white rounded-xl shadow-md font-medium ${['finish', 'edit'].includes(modalType)?'bg-sage-500': ['reset', 'logout'].includes(modalType)?'bg-wood-400': 'bg-dried-500'}`}>確認</button></div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }
        createRoot(document.getElementById('root')).render(<ReadingTracker />);
    </script>
</body>
</html>
