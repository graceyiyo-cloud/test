<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅遊費用分算紀錄</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif;
            background-color: #f9f7f2;
            color: #4a4a4a;
            -webkit-font-smoothing: antialiased;
            letter-spacing: 0.03em;
            font-weight: 700 !important;
            line-height: 1.3;
        }
        *, *::before, *::after { font-weight: 700 !important; font-style: normal !important; }
        input, select, button { font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif !important; }
        input:focus, select:focus { outline: none; border-color: #5c6b53 !important; box-shadow: 0 0 0 4px rgba(92, 107, 83, 0.08); }
        select { -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23a8a297' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; background-size: 16px; }
        ::placeholder { font-weight: 700; opacity: 0.5; }
        @keyframes scaleUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .scale-up-center { animation: scaleUp 0.2s ease-out forwards; }
    </style>
</head>
<body class="leading-tight">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const Icon = ({ name, className = "w-5 h-5" }) => <i data-lucide={name} className={className}></i>;
        const APP_ID = 'travel-expense-splitter-v1';
        const CURRENCIES = [
            { code: 'TWD', name: '台幣', symbol: 'TWD' }, { code: 'USD', name: '美金', symbol: 'USD' },
            { code: 'JPY', name: '日圓', symbol: '¥' }, { code: 'KRW', name: '韓元', symbol: '₩' },
            { code: 'CNY', name: '人民幣', symbol: 'CNY' }, { code: 'EUR', name: '歐元', symbol: 'EUR' },
            { code: 'HKD', name: '港幣', symbol: 'HKD' }, { code: 'GBP', name: '英鎊', symbol: 'GBP' },
            { code: 'AUD', name: '澳幣', symbol: 'AUD' }, { code: 'SGD', name: '新加坡幣', symbol: 'SGD' },
            { code: 'THB', name: '泰銖', symbol: 'THB' },
        ];

        function App() {
            const [members, setMembers] = useState([]);
            const [memberBankInfo, setMemberBankInfo] = useState({});
            const [newMemberName, setNewMemberName] = useState('');
            const [expenses, setExpenses] = useState([]);
            const [rates, setRates] = useState({ TWD: 1 });
            const [loadingRates, setLoadingRates] = useState(false);
            const [showClearConfirm, setShowClearConfirm] = useState(false);
            const [expenseToDelete, setExpenseToDelete] = useState(null);
            const [editingId, setEditingId] = useState(null);
            const [editForm, setEditForm] = useState(null);
            const [bankModalMember, setBankModalMember] = useState(null);
            const [tempBankInfo, setTempBankInfo] = useState('');
            const [toast, setToast] = useState(null);
            const [form, setForm] = useState({ item: '', amount: '', currency: 'TWD', payer: '', participants: [] });

            useEffect(() => {
                const savedData = localStorage.getItem(APP_ID);
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    setMembers(parsed.members || []);
                    setExpenses(parsed.expenses || []);
                    setMemberBankInfo(parsed.memberBankInfo || {});
                }
                fetchRates();
            }, []);

            useEffect(() => {
                localStorage.setItem(APP_ID, JSON.stringify({ members, expenses, memberBankInfo }));
                if (window.lucide) window.lucide.createIcons();
            }, [members, expenses, rates, showClearConfirm, expenseToDelete, editingId, bankModalMember, memberBankInfo]);

            const showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };
            const fetchRates = async () => {
                setLoadingRates(true);
                try {
                    const res = await fetch(`https://open.er-api.com/v6/latest/TWD`);
                    const data = await res.json();
                    if (data && data.rates) {
                        const newRates = { TWD: 1 };
                        CURRENCIES.forEach(curr => {
                            if (curr.code !== 'TWD' && data.rates[curr.code]) {
                                newRates[curr.code] = (1 / data.rates[curr.code] * 1.02).toFixed(4);
                            }
                        });
                        setRates(newRates);
                    }
                } catch (e) { console.error(e); } finally { setLoadingRates(false); }
            };

            const addMember = () => {
                const trimmed = newMemberName.trim();
                if (!trimmed || members.includes(trimmed)) return;
                setMembers([...members, trimmed]);
                setNewMemberName('');
            };

            const toggleParticipant = (name, isEdit = false) => {
                const targetForm = isEdit ? editForm : form;
                const setTargetForm = isEdit ? setEditForm : setForm;
                const isIncluded = targetForm.participants.includes(name);
                setTargetForm({ ...targetForm, participants: isIncluded ? targetForm.participants.filter(p => p !== name) : [...targetForm.participants, name] });
            };

            const calculateSplits = (amount, participants) => {
                const totalAmount = parseFloat(amount);
                const count = participants.length;
                if (count === 0) return {};
                const baseSplit = Math.round(totalAmount / count);
                const lastSplit = totalAmount - (baseSplit * (count - 1));
                const splits = {};
                participants.forEach((name, index) => { splits[name] = index === count - 1 ? lastSplit : baseSplit; });
                return splits;
            };

            const submitExpense = () => {
                const { item, amount, currency, payer, participants } = form;
                if (!item || !amount || !payer || participants.length === 0) return;
                const newExpense = {
                    id: Date.now(), item, amount: parseFloat(amount), currency, rate: parseFloat(rates[currency] || 1),
                    payer, splits: calculateSplits(amount, participants),
                    timestamp: new Date().toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                };
                setExpenses([...expenses, newExpense]);
                setForm({ ...form, item: '', amount: '', participants: [] });
                showToast("支出已記錄");
            };

            const startEditing = (exp) => {
                setEditingId(exp.id);
                setEditForm({ item: exp.item, amount: exp.amount, currency: exp.currency, payer: exp.payer, participants: Object.keys(exp.splits) });
            };

            const saveEdit = () => {
                const { item, amount, currency, payer, participants } = editForm;
                setExpenses(expenses.map(e => e.id === editingId ? { ...e, item, amount: parseFloat(amount), currency, payer, rate: parseFloat(rates[currency] || 1), splits: calculateSplits(amount, participants) } : e));
                setEditingId(null); setEditForm(null); showToast("已更新明細");
            };

            const settlement = useMemo(() => {
                const balances = {}; let totalTWD = 0;
                members.forEach(m => balances[m] = 0);
                const currencyCounts = {};
                expenses.forEach(e => { if (e.currency !== 'TWD') currencyCounts[e.currency] = (currencyCounts[e.currency] || 0) + 1; });
                const primaryCode = Object.keys(currencyCounts).reduce((a, b) => currencyCounts[a] > currencyCounts[b] ? a : b, null);
                const primaryRate = primaryCode ? (rates[primaryCode] || 1) : 1;
                expenses.forEach(exp => {
                    const amountTWD = exp.amount * exp.rate; totalTWD += amountTWD;
                    balances[exp.payer] += amountTWD;
                    Object.entries(exp.splits).forEach(([name, splitAmt]) => { balances[name] -= (splitAmt * exp.rate); });
                });
                const debtors = [], creditors = [];
                Object.entries(balances).forEach(([name, bal]) => {
                    if (bal < -1) debtors.push({ name, amount: Math.abs(bal) });
                    else if (bal > 1) creditors.push({ name, amount: bal });
                });
                const transactions = []; let dIdx = 0, cIdx = 0;
                const td = JSON.parse(JSON.stringify(debtors)), tc = JSON.parse(JSON.stringify(creditors));
                while (dIdx < td.length && cIdx < tc.length) {
                    const amt = Math.min(td[dIdx].amount, tc[cIdx].amount);
                    if (amt > 0) transactions.push({ from: td[dIdx].name, to: tc[cIdx].name, amount: amt });
                    td[dIdx].amount -= amt; tc[cIdx].amount -= amt;
                    if (td[dIdx].amount <= 0.1) dIdx++; if (tc[cIdx].amount <= 0.1) cIdx++;
                }
                return { totalTWD, transactions, primaryCode, primaryRate };
            }, [expenses, members, rates]);

            const formatNum = (num) => new Intl.NumberFormat('en-US').format(Math.round(num));

            return (
                <div className="min-h-screen pb-20 font-bold">
                    <header className="bg-white/90 backdrop-blur-md border-b border-[#e5e1d8] p-3 sticky top-0 z-40 flex justify-between items-center shadow-sm">
                        <div>
                            <h1 className="text-xl sm:text-2xl flex items-center gap-2 text-[#5c6b53] font-bold"><Icon name="map" className="w-5 h-5 sm:w-6 sm:h-6" /> 旅遊費用分算紀錄</h1>
                        </div>
                        <button onClick={fetchRates} className={`p-2 rounded-full text-[#a8a297] ${loadingRates ? 'animate-spin' : ''}`}><Icon name="refresh-cw" className="w-4 h-4" /></button>
                    </header>

                    <main className="max-w-xl mx-auto p-4 space-y-6">
                        {/* 夥伴設定區 */}
                        <section className="bg-white rounded-2xl border border-[#e5e1d8] p-4 shadow-sm">
                            <h2 className="text-lg font-bold mb-3 flex items-center gap-2 text-[#8d775f]"><Icon name="users" className="w-5 h-5"/> 同行夥伴</h2>
                            <div className="flex gap-2 mb-4">
                                <input type="text" value={newMemberName} onChange={e => setNewMemberName(e.target.value)} placeholder="輸入夥伴姓名..." className="flex-1 px-4 py-2.5 bg-[#fdfaf5] border border-[#e5e1d8] rounded-xl outline-none" />
                                <button onClick={addMember} className="bg-[#5c6b53] text-white px-4 rounded-xl shadow-md"><Icon name="user-plus" className="w-5 h-5" /></button>
                            </div>
                            <div className="flex flex-wrap gap-2">
                                {members.map(m => (
                                    <span key={m} className="bg-[#f3f0e9] text-[#5c6b53] px-3 py-2 rounded-lg flex items-center gap-2 text-sm shadow-sm">
                                        {m} 
                                        <button onClick={() => { setBankModalMember(m); setTempBankInfo(memberBankInfo[m] || ''); }} className={memberBankInfo[m] ? 'text-blue-500' : 'text-[#a8a297]'}><Icon name="landmark" className="w-4 h-4" /></button>
                                        <button onClick={() => setMembers(members.filter(x => x !== m))} className="text-[#a8a297]"><Icon name="x" className="w-3 h-3" /></button>
                                    </span>
                                ))}
                            </div>
                        </section>

                        {/* 紀錄支出區 */}
                        <section className="bg-white rounded-2xl border border-[#e5e1d8] p-5 shadow-sm space-y-5">
                            <h2 className="text-lg font-bold flex items-center gap-2 text-[#8d775f]"><Icon name="coffee" className="w-5 h-5"/> 紀錄一筆支出</h2>
                            <input type="text" value={form.item} onChange={e => setForm({...form, item: e.target.value})} placeholder="明細（如：午餐）" className="w-full px-4 py-2.5 bg-[#fdfaf5] border border-[#e5e1d8] rounded-xl outline-none" />
                            <div className="flex gap-2">
                                <select value={form.currency} onChange={e => setForm({...form, currency: e.target.value})} className="w-1/3 px-3 py-2.5 bg-[#fdfaf5] border border-[#e5e1d8] rounded-xl">
                                    {CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.name}</option>)}
                                </select>
                                <input type="text" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} placeholder="金額" className="flex-1 px-4 py-2.5 bg-[#fdfaf5] border border-[#e5e1d8] rounded-xl text-right" />
                            </div>
                            <div className="space-y-2">
                                <p className="text-xs text-[#a8a297] px-1">由誰預付</p>
                                <div className="flex flex-wrap gap-2">
                                    {members.map(m => <button key={m} onClick={() => setForm({...form, payer: m})} className={`px-3 py-2 rounded-xl border text-sm ${form.payer === m ? 'bg-[#5c6b53] text-white' : 'bg-white'}`}>{m}</button>)}
                                </div>
                            </div>
                            <div className="space-y-2">
                                <p className="text-xs text-[#a8a297] px-1">分攤成員</p>
                                <div className="flex flex-wrap gap-2">
                                    {members.map(m => <button key={m} onClick={() => toggleParticipant(m)} className={`px-3 py-2 rounded-xl border text-sm ${form.participants.includes(m) ? 'bg-[#f3f0e9] text-[#5c6b53]' : 'bg-white'}`}>{m}</button>)}
                                </div>
                            </div>
                            <button onClick={submitExpense} className="w-full bg-[#5c6b53] text-white py-3 rounded-2xl shadow-lg">記錄支出</button>
                        </section>

                        {/* 支出明細列表 - 重點修正區域 */}
                        <section className="space-y-4">
                            <h2 className="text-lg font-bold px-2 text-[#5c6b53]">支出明細</h2>
                            <div className="bg-white rounded-3xl border border-[#e5e1d8] p-4 sm:p-6 space-y-8 shadow-sm">
                                {expenses.map((exp, idx) => (
                                    <div key={exp.id} className="relative pl-6 border-l-4 border-[#5c6b53]/20 pb-2">
                                        <div className="absolute left-[-10px] top-1 bg-[#5c6b53] rounded-full w-4 h-4 border-4 border-white shadow-sm" />
                                        
                                        {/* 明細內容佈局 */}
                                        <div className="flex flex-col w-full">
                                            {/* 第一行：標題、匯率、按鈕 */}
                                            <div className="flex justify-between items-start w-full gap-2">
                                                <div className="text-lg font-black text-[#4a4a4a]">{idx + 1}. {exp.item}</div>
                                                <div className="flex items-center gap-3">
                                                    {exp.currency !== 'TWD' && <span className="text-[10px] text-[#a8a297] font-mono whitespace-nowrap">匯率: {exp.rate}</span>}
                                                    <button onClick={() => startEditing(exp)} className="text-[#a8a297] hover:text-[#5c6b53]"><Icon name="pencil" className="w-4 h-4" /></button>
                                                    <button onClick={() => setExpenseToDelete(exp.id)} className="text-[#e5e1d8] hover:text-red-500"><Icon name="trash" className="w-4 h-4" /></button>
                                                </div>
                                            </div>

                                            {/* 第二行：日期時間 (向右橫向延伸) */}
                                            <div className="text-[11px] text-[#a8a297] tracking-wider mt-1 w-full block">
                                                {exp.timestamp}
                                            </div>

                                            {/* 第三行：預付資訊 (向右橫向延伸，不截斷) */}
                                            <div className="text-sm text-[#7a746a] mt-1 font-bold w-full block">
                                                <span className="text-[#5c6b53] font-black">{exp.payer}</span> 預付 
                                                <span className="text-[#5c6b53] font-black ml-1">
                                                    {CURRENCIES.find(c => c.code === exp.currency).symbol} {formatNum(exp.amount)}
                                                    {exp.currency !== 'TWD' && ` (≈ TWD ${formatNum(exp.amount * exp.rate)})`}
                                                </span>
                                            </div>

                                            {/* 分算明細卡片 */}
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-4">
                                                {Object.entries(exp.splits).map(([name, amt]) => (
                                                    <div key={name} className="bg-[#fdfaf5] px-4 py-2 rounded-xl border border-[#e5e1d8]/60 flex items-center justify-between shadow-sm">
                                                        <div className="text-[#a8a297] font-black text-xs uppercase">{name}</div>
                                                        <div className="text-right">
                                                            <div className="text-[#5c6b53] font-black text-sm">
                                                                {CURRENCIES.find(c => c.code === exp.currency).symbol} {formatNum(amt)}
                                                            </div>
                                                            {exp.currency !== 'TWD' && <div className="text-[10px] text-[#8d775f] font-black">≈ TWD {formatNum(amt * exp.rate)}</div>}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>

                        {/* 結算區 */}
                        <section className="space-y-4">
                            <h2 className="text-lg font-bold px-2 text-[#5c6b53]">最終結算</h2>
                            <div className="bg-white rounded-[2rem] border border-[#e5e1d8] overflow-hidden shadow-md p-6 space-y-4">
                                {settlement.transactions.map((t, i) => (
                                    <div key={i} className="p-4 bg-[#fdfaf5] rounded-2xl border border-[#e5e1d8]/50 flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <span className="bg-white px-3 py-1 rounded-lg border text-sm">{t.from}</span>
                                            <Icon name="arrow-right" className="w-4 h-4 text-[#5c6b53]" />
                                            <span className="bg-white px-3 py-1 rounded-lg border text-sm">{t.to}</span>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-lg font-black text-[#5c6b53]">TWD {formatNum(t.amount)}</div>
                                            {memberBankInfo[t.to] && <div className="text-[10px] text-[#8d775f] mt-1">資料: {memberBankInfo[t.to]}</div>}
                                        </div>
                                    </div>
                                ))}
                                {settlement.transactions.length === 0 && <div className="text-center py-6 text-[#a8a297]">目前帳目已結清</div>}
                            </div>
                        </section>
                    </main>

                    {/* 銀行資料 Modal */}
                    {bankModalMember && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-[100] flex items-center justify-center p-6">
                            <div className="bg-white rounded-[2.5rem] p-8 max-w-sm w-full scale-up-center shadow-2xl">
                                <h3 className="text-xl font-black mb-4">設定 {bankModalMember} 匯款資料</h3>
                                <textarea value={tempBankInfo} onChange={e => setTempBankInfo(e.target.value)} placeholder="銀行代碼、帳號..." className="w-full h-32 p-4 bg-[#fdfaf5] border border-[#e5e1d8] rounded-2xl outline-none mb-6 font-bold" />
                                <button onClick={() => { setMemberBankInfo({...memberBankInfo, [bankModalMember]: tempBankInfo}); setBankModalMember(null); showToast("儲存成功"); }} className="w-full py-4 bg-[#5c6b53] text-white rounded-2xl shadow-lg">儲存資料</button>
                                <button onClick={() => setBankModalMember(null)} className="w-full py-3 text-[#a8a297] text-xs font-black uppercase mt-2">取消</button>
                            </div>
                        </div>
                    )}

                    {toast && <div className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-[#4a4a4a] text-white px-6 py-3 rounded-2xl shadow-2xl z-[150] font-black text-xs animate-bounce">{toast}</div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
