<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的雲端書櫃</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // 護眼配色方案：低飽和、低對比
                        paper: '#f2f0e9', // 暖米色背景，減少藍光刺激
                        ink: '#373a36',   // 深炭灰文字，比純黑更柔和
                        sub: '#6b705c',   // 苔蘚綠灰，用於次要文字
                        wood: {
                            100: '#e9e7da',
                            200: '#dad7cd', // 橄欖灰
                            300: '#a3b18a', // 鼠尾草綠
                            400: '#588157', // 深綠
                            500: '#3a5a40', // 森林綠
                            600: '#344e41',
                        },
                        sage: {
                            50: '#f0f4ef',
                            100: '#e0e9e1',
                            200: '#c5d5c5',
                            500: '#84a59d', // 低飽和綠
                            600: '#6b8a82',
                            text: '#4a5d5a'
                        },
                        dried: {
                            50: '#f7f2f2',
                            100: '#ede0e0',
                            200: '#d9bfbf',
                            500: '#b5838d', // 乾燥玫瑰色，柔和的提醒
                            600: '#a0717a',
                            text: '#6d4c51'
                        },
                        stone: {
                            50: '#f5f5f5',
                            100: '#e7e7e2',
                            200: '#dcdcc6',
                            400: '#a7a797',
                            500: '#7f7f6f',
                            600: '#5f5f54',
                            text: '#4a4a40'
                        },
                        gold: { 
                            400: '#d4a373', // 琥珀色星星，比純金更護眼
                            500: '#bc8a5f',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-modal-in {
            animation: modalIn 0.2s ease-out forwards;
        }

        html {
            font-size: 90%;
            background-color: #f2f0e9; /* 防止閃爍 */
        }

        @media (max-width: 768px) {
            html {
                font-size: 120%; 
            }
            input, select, textarea {
                padding-top: 0.6rem;
                padding-bottom: 0.6rem;
            }
        }

        input, textarea, select {
            font-size: 1rem !important; 
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* 柔和的陰影 */
        .soft-shadow {
            box-shadow: 0 4px 12px -2px rgba(58, 90, 64, 0.08);
        }
    </style>
</head>
<body class="bg-paper text-ink selection:bg-wood-200 selection:text-ink pb-10">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            BookOpen, Search, Plus, Trash2, CheckCircle, BookX, 
            Calendar, User, LogIn, RefreshCw, TrendingUp, Link as LinkIcon, FileText, PenTool, Trophy, Hourglass, Star, X, Tag, RotateCcw, AlertTriangle, Filter, LogOut, MessageSquare, Edit3, FileUp
        } from 'https://esm.sh/lucide-react@0.344.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, serverTimestamp, writeBatch } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDX1-Lwc5_u_fwV9P25xh32dVF8uVNT0QU",
            authDomain: "my-reading-tracker-58f69.firebaseapp.com",
            projectId: "my-reading-tracker-58f69",
            storageBucket: "my-reading-tracker-58f69.firebasestorage.app",
            messagingSenderId: "370802674969",
            appId: "1:370802674969:web:efb1c045e0028925154988",
            measurementId: "G-52EWLNG7ST"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "my-reading-app"; 
        const ESTIMATE_WORDS_PER_PAGE = 350;

        const DEFAULT_CATEGORIES = [
            "玄幻", "奇幻", "武俠", "仙俠", "都市", "言情", "古代", "架空", 
            "科幻", "懸疑", "推理", "驚悚", "恐怖", "冒險", "耽美 (BL)", "百合 (GL)", 
            "穿越", "重生", "系統", "快穿", "無限流", "末世", "種田", "宅鬥", "宮鬥", 
            "娛樂圈", "電競", "校園", "職場", "先婚後愛", "破鏡重圓", "青梅竹馬", 
            "異能", "空間", "甜寵", "虐戀", "爽文", "升級流", "治癒", "輕鬆", "沙雕"
        ];

        const CategoryPicker = ({ selectedCategories, onToggle, allCategories, onAddNew, onDelete }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [filterText, setFilterText] = useState('');

            const filtered = useMemo(() => {
                const term = filterText.toLowerCase();
                return allCategories.filter(c => c.toLowerCase().includes(term));
            }, [allCategories, filterText]);

            const handleSelect = (cat) => {
                onToggle(cat);
                setFilterText(''); 
            };

            return (
                <div className="w-full">
                    <div className="flex flex-wrap gap-2 items-center min-h-[40px] p-2 border-b border-wood-200">
                        {selectedCategories.map(cat => (
                            <span key={cat} className="bg-wood-400 text-white text-xs px-2 py-1 rounded-full flex items-center gap-1 shadow-sm">
                                {cat}
                                <X size={12} className="cursor-pointer hover:text-wood-200" onClick={(e) => { e.stopPropagation(); onToggle(cat); }}/>
                            </span>
                        ))}
                        <button 
                            type="button" 
                            onClick={() => setIsOpen(!isOpen)} 
                            className={`text-xs flex items-center gap-1 px-2 py-1 rounded-full transition-colors ${isOpen ? 'bg-wood-200 text-wood-600' : 'text-wood-500 hover:bg-wood-100'}`}
                        >
                            <Plus size={12}/> {isOpen ? '收起' : '選擇分類'}
                        </button>
                    </div>

                    {isOpen && (
                        <div className="mt-2 p-3 bg-stone-50 rounded-xl border border-stone-200 shadow-sm animate-fade-in relative z-10">
                            <input 
                                type="text" 
                                placeholder="搜尋或建立新分類..." 
                                value={filterText}
                                onChange={e => setFilterText(e.target.value)}
                                className="w-full mb-3 p-2 bg-white rounded-lg text-sm outline-none focus:ring-1 focus:ring-wood-300 border border-stone-200"
                                autoFocus
                            />
                            
                            <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto no-scrollbar content-start">
                                {filterText && !allCategories.includes(filterText) && (
                                    <button 
                                        type="button" 
                                        onClick={() => { onAddNew(filterText); setFilterText(''); }}
                                        className="bg-wood-500 text-white text-xs px-3 py-1.5 rounded-full hover:bg-wood-600 transition shadow-sm flex items-center gap-1"
                                    >
                                        <Plus size={12}/> 建立「{filterText}」
                                    </button>
                                )}
                                
                                {filtered.map(cat => {
                                    const isSelected = selectedCategories.includes(cat);
                                    if (isSelected) return null;
                                    return (
                                        <div key={cat} className="group relative">
                                            <button 
                                                type="button" 
                                                onClick={() => handleSelect(cat)}
                                                className="bg-stone-100 text-stone-600 border border-stone-200 text-xs px-3 py-1.5 rounded-full hover:bg-stone-200 hover:border-stone-400 transition"
                                            >
                                                {cat}
                                            </button>
                                            <button 
                                                type="button"
                                                onClick={(e) => onDelete(cat, e)}
                                                className="absolute -top-1 -right-1 bg-white text-stone-300 hover:text-dried-500 rounded-full p-0.5 shadow-sm border border-stone-100 opacity-0 group-hover:opacity-100 transition-opacity"
                                                title="刪除分類"
                                            >
                                                <X size={10} strokeWidth={3} />
                                            </button>
                                        </div>
                                    )
                                })}
                                {filtered.length === 0 && !filterText && <span className="text-xs text-stone-400 py-1">無符合分類</span>}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        function ReadingTracker() {
            const [user, setUser] = useState(null);
            const [books, setBooks] = useState([]);
            const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
            const [loading, setLoading] = useState(true);
            const [customId, setCustomId] = useState('');
            const [isLoginMode, setIsLoginMode] = useState(true);
            const [isAuthChecking, setIsAuthChecking] = useState(true);
            const [toast, setToast] = useState(null); 

            const [searchTerm, setSearchTerm] = useState('');
            const fileInputRef = useRef(null);

            const [newBook, setNewBook] = useState({
                title: '', author: '', wordCount: '', isWordCountManual: false,
                addDate: new Date().toISOString().split('T')[0],
                reviewUrl: '', synopsis: '', category: [] 
            });
            const [isSearching, setIsSearching] = useState(false);
            const [activeBookId, setActiveBookId] = useState(null);
            
            const [modalType, setModalType] = useState(null); 
            const [modalData, setModalData] = useState({});
            const [expandedBooks, setExpandedBooks] = useState({});

            useEffect(() => {
                signInAnonymously(auth).catch((error) => console.error("Auth Error", error));
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        const savedId = localStorage.getItem('reading_tracker_custom_id');
                        if (savedId) {
                            setCustomId(savedId);
                            setIsLoginMode(false);
                        } else {
                            setIsLoginMode(true);
                        }
                    }
                    setIsAuthChecking(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !customId) {
                    setLoading(false);
                    return;
                }
                setLoading(true);
                const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`);
                
                const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
                    const fetchedBooks = [];
                    let fetchedCategories = [...DEFAULT_CATEGORIES];

                    snapshot.docs.forEach(doc => {
                        if (doc.id === 'settings') {
                            if (doc.data().categories && Array.isArray(doc.data().categories)) {
                                fetchedCategories = doc.data().categories;
                            }
                        } else {
                            fetchedBooks.push({ id: doc.id, ...doc.data() });
                        }
                    });
                    
                    fetchedBooks.sort((a, b) => {
                        const isReadingA = a.status === 'reading';
                        const isReadingB = b.status === 'reading';
                        if (isReadingA && !isReadingB) return -1;
                        if (!isReadingA && isReadingB) return 1;
                        return new Date(b.addDate || 0) - new Date(a.addDate || 0);
                    });
                    
                    setBooks(fetchedBooks);
                    setCategories(fetchedCategories);
                    setLoading(false);
                }, (error) => {
                    console.error("Error", error);
                    setLoading(false);
                    showToast("資料讀取失敗", "error");
                });
                return () => unsubscribe();
            }, [user, customId]);

            const showToast = (message, type = 'info') => {
                setToast({ message, type });
                setTimeout(() => setToast(null), 3000);
            };

            const handleLogin = (e) => {
                e.preventDefault();
                if (customId.trim().length < 3) return showToast("ID 太短囉", "error");
                localStorage.setItem('reading_tracker_custom_id', customId);
                setIsLoginMode(false);
            };

            const handleLogout = () => {
                setModalType('logout');
            };

            const searchBookInfo = async () => {
                if (!newBook.title) return;
                setIsSearching(true);
                try {
                    const q = `intitle:${newBook.title}${newBook.author ? `+inauthor:${newBook.author}` : ''}`;
                    const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${q}&maxResults=1`);
                    const data = await res.json();
                    if (data.items && data.items.length > 0) {
                        const info = data.items[0].volumeInfo;
                        setNewBook(prev => ({
                            ...prev,
                            author: prev.author || info.authors?.[0] || '',
                            wordCount: (info.pageCount || 0) * ESTIMATE_WORDS_PER_PAGE,
                            isWordCountManual: false,
                            synopsis: info.description || ''
                        }));
                        showToast("找到書籍資料！");
                    } else {
                        showToast("找不到書籍資料", "error");
                    }
                } catch (error) {
                    showToast("搜尋失敗", "error");
                } finally {
                    setIsSearching(false);
                }
            };

            const addBook = async (e) => {
                e.preventDefault();
                if (!newBook.title || !customId) return;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`), {
                        ...newBook,
                        status: 'reading',
                        createdAt: serverTimestamp()
                    });
                    setNewBook({
                        title: '', author: '', wordCount: '', isWordCountManual: false,
                        addDate: new Date().toISOString().split('T')[0], reviewUrl: '', synopsis: '', category: []
                    });
                    showToast("新增成功！");
                } catch (error) {
                    showToast("新增失敗", "error");
                }
            };

            // CSV 匯入邏輯
            const handleImportCSV = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const text = event.target.result;
                    const lines = text.split(/\r?\n/);
                    if (lines.length <= 1) return;

                    const batch = writeBatch(db);
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`);
                    let importCount = 0;

                    // 假設格式：已讀完日期, 書名, 作者, 評價
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        
                        // 處理 CSV 逗號分割，簡單處理雙引號
                        const cols = lines[i].split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                        if (cols.length < 2) continue;

                        const [finishDate, title, author, ratingRaw] = cols;
                        if (!title) continue;

                        const bookData = {
                            title,
                            author: author || '',
                            addDate: new Date().toISOString().split('T')[0],
                            createdAt: serverTimestamp(),
                            category: []
                        };

                        if (!finishDate) {
                            bookData.status = 'reading';
                        } else if (ratingRaw === '棄文') {
                            bookData.status = 'dropped';
                            bookData.dropDate = finishDate;
                            bookData.dropChapter = '未知';
                        } else {
                            bookData.status = 'finished';
                            bookData.finishDate = finishDate;
                            // 10分制轉5星制
                            const score = parseFloat(ratingRaw);
                            bookData.rating = !isNaN(score) ? Math.min(5, Math.max(0, score / 2)) : 0;
                        }

                        const newDocRef = doc(colRef);
                        batch.set(newDocRef, bookData);
                        importCount++;
                    }

                    try {
                        await batch.commit();
                        showToast(`成功匯入 ${importCount} 本書籍！`);
                    } catch (err) {
                        showToast("匯入失敗", "error");
                    }
                    e.target.value = null;
                };
                reader.readAsText(file);
            };

            const updateCategoriesInDb = async (newCats) => {
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`, 'settings'), {
                        categories: newCats
                    }, { merge: true });
                } catch (err) {
                    showToast("更新分類失敗", "error");
                }
            };

            const addNewCategory = async (catName) => {
                if (!catName.trim()) return;
                const name = catName.trim();
                if (categories.includes(name)) {
                    showToast("分類已存在", "error");
                    return;
                }
                const updatedCats = [...categories, name];
                await updateCategoriesInDb(updatedCats);
                showToast(`已新增分類「${name}」`);
                return name; 
            };

            const handleDeleteCategory = async (catToDelete, e) => {
                e.stopPropagation();
                setModalData({ category: catToDelete });
                setModalType('deleteCategory');
            };

            const toggleNewBookCategory = (cat) => {
                setNewBook(prev => {
                    const currentCats = Array.isArray(prev.category) ? prev.category : [];
                    if (currentCats.includes(cat)) {
                        return { ...prev, category: currentCats.filter(c => c !== cat) };
                    } else {
                        return { ...prev, category: [...currentCats, cat] };
                    }
                });
            };
            
            const toggleEditBookCategory = (cat) => {
                setModalData(prev => {
                    const currentCats = Array.isArray(prev.category) ? prev.category : [];
                    if (currentCats.includes(cat)) {
                        return { ...prev, category: currentCats.filter(c => c !== cat) };
                    } else {
                        return { ...prev, category: [...currentCats, cat] };
                    }
                });
            };

            const handleAddNewCategoryWrapper = async (name, targetStateSetter) => {
                 const newName = await addNewCategory(name);
                 if(newName && targetStateSetter) {
                     targetStateSetter(prev => ({
                         ...prev,
                         category: [...(prev.category || []), newName]
                     }));
                 }
            };

            const handleModalAction = async () => {
                if (!modalType) return;
                try {
                    if (modalType === 'logout') {
                        localStorage.removeItem('reading_tracker_custom_id');
                        setCustomId('');
                        setBooks([]);
                        setIsLoginMode(true);
                        closeModal();
                        return;
                    }
                    if (modalType === 'deleteCategory') {
                        const catToDelete = modalData.category;
                        const updatedCats = categories.filter(c => c !== catToDelete);
                        await updateCategoriesInDb(updatedCats);
                        showToast(`已刪除分類「${catToDelete}」`);
                        closeModal();
                        return;
                    }
                    if (!activeBookId) return;
                    const bookRef = doc(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`, activeBookId);
                    if (modalType === 'delete') {
                        await deleteDoc(bookRef);
                        showToast("已刪除書籍");
                    } else if (modalType === 'edit') {
                        await updateDoc(bookRef, {
                            title: modalData.title,
                            author: modalData.author,
                            category: modalData.category,
                            wordCount: modalData.wordCount,
                            addDate: modalData.addDate,
                            reviewUrl: modalData.reviewUrl,
                            synopsis: modalData.synopsis
                        });
                        showToast("書籍資料已更新");
                    } else {
                        const updates = {};
                        if (modalType === 'finish') {
                            updates.status = 'finished';
                            updates.finishDate = modalData.date;
                            updates.rating = modalData.rating;
                            updates.review = modalData.review || '';
                        } else if (modalType === 'drop') {
                            updates.status = 'dropped';
                            updates.dropChapter = modalData.chapter;
                            updates.dropDate = modalData.date;
                        } else if (modalType === 'reset') {
                            updates.status = 'reading';
                            updates.finishDate = null; updates.dropChapter = null; updates.dropDate = null; updates.rating = null; updates.review = null;
                        }
                        await updateDoc(bookRef, updates);
                        showToast("狀態已更新");
                    }
                    closeModal();
                } catch (error) {
                    showToast("操作失敗，請稍後再試", "error");
                }
            };

            const toggleSynopsis = (id) => setExpandedBooks(prev => ({...prev, [id]: !prev[id]}));

            const openModal = (book, type, e) => {
                if (e) e.stopPropagation();
                setActiveBookId(book.id);
                setModalType(type);
                if (type === 'edit') {
                    setModalData({ ...book });
                } else {
                    setModalData({ 
                        date: new Date().toISOString().split('T')[0], 
                        chapter: type === 'drop' ? '' : undefined,
                        rating: type === 'finish' ? 0 : undefined,
                        review: type === 'finish' ? (book.review || '') : undefined
                    });
                }
            };

            const closeModal = () => { setActiveBookId(null); setModalType(null); setModalData({}); };

            const activeBook = useMemo(() => books.find(b => b.id === activeBookId), [books, activeBookId]);

            const filteredBooks = useMemo(() => {
                if (!searchTerm.trim()) return books;
                const term = searchTerm.toLowerCase();
                return books.filter(b => (
                    b.title?.toLowerCase().includes(term) ||
                    b.author?.toLowerCase().includes(term) ||
                    (b.category && b.category.some(c => c.toLowerCase().includes(term)))
                ));
            }, [books, searchTerm]);
            
            const stats = useMemo(() => {
                const yearStats = {};
                let totalFinished = 0, totalDropped = 0, totalReading = 0;
                const activeYears = new Set();
                books.forEach(b => {
                    let y = null;
                    if (b.status === 'reading') totalReading++;
                    else if (b.status === 'finished' && b.finishDate) {
                        y = new Date(b.finishDate).getFullYear(); totalFinished++;
                    } else if (b.status === 'dropped' && b.dropDate) {
                        y = new Date(b.dropDate).getFullYear(); totalDropped++;
                    }
                    if (y && !isNaN(y)) {
                        activeYears.add(y);
                        if (!yearStats[y]) yearStats[y] = { finished: 0, dropped: 0 };
                        if (b.status === 'finished') yearStats[y].finished++;
                        if (b.status === 'dropped') yearStats[y].dropped++;
                    }
                });
                return { 
                    years: Array.from(activeYears).sort((a, b) => b - a), 
                    data: yearStats, 
                    total: { finished: totalFinished, dropped: totalDropped, reading: totalReading } 
                };
            }, [books]);

            const StarRating = ({ rating, setRating, interactive = false }) => (
                <div className="flex gap-1">
                    {[1, 2, 3, 4, 5].map((index) => {
                        const filled = rating >= index;
                        const half = rating >= index - 0.5 && !filled;
                        return (
                            <div key={index} className={`relative ${interactive ? 'cursor-pointer transition-transform active:scale-90' : ''}`}
                                onClick={(e) => {
                                    if (interactive) {
                                        const rect = e.currentTarget.getBoundingClientRect();
                                        setRating((e.clientX - rect.left) < rect.width / 2 ? index - 0.5 : index);
                                    }
                                }}>
                                <Star size={interactive ? 32 : 16} className="text-stone-200"/>
                                <div className="absolute top-0 left-0 overflow-hidden" style={{ width: filled ? '100%' : half ? '50%' : '0%' }}>
                                    <Star size={interactive ? 32 : 16} className="fill-gold-400 text-gold-400"/>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );

            if (isAuthChecking) return <div className="min-h-screen flex items-center justify-center bg-paper"><RefreshCw className="animate-spin text-wood-400" /></div>;

            if (isLoginMode) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-paper relative">
                        {toast && (
                            <div className={`fixed top-4 left-1/2 -translate-x-1/2 px-4 py-3 rounded-xl shadow-xl z-50 animate-fade-in-down text-white text-sm font-bold flex items-center gap-2 ${toast.type === 'error' ? 'bg-dried-500' : 'bg-wood-400'}`}>
                                {toast.type === 'error' ? <AlertTriangle size={16}/> : <CheckCircle size={16}/>}
                                {toast.message}
                            </div>
                        )}
                        <div className="bg-white/60 p-8 rounded-3xl shadow-lg border border-stone-200 w-full max-w-md backdrop-blur-sm">
                            <div className="flex justify-center mb-6 text-wood-400"><BookOpen size={56} strokeWidth={1.5} /></div>
                            <h1 className="text-3xl font-bold text-center mb-3 text-ink tracking-widest">雲端書櫃</h1>
                            <p className="text-sub text-center mb-8 text-sm">溫和配色，舒適紀錄你的閱讀時光。</p>
                            <form onSubmit={handleLogin} className="space-y-5">
                                <input value={customId} onChange={e=>setCustomId(e.target.value)} placeholder="例如: alex2026" className="w-full p-3 bg-white/50 border-b-2 border-stone-200 focus:border-wood-300 outline-none text-center text-lg placeholder-stone-300 rounded-t-lg" />
                                <button type="submit" className="w-full bg-wood-400 text-white py-3 rounded-xl font-bold flex justify-center gap-2 hover:bg-wood-500 transition shadow-md tracking-widest"><LogIn size={20} strokeWidth={1.5}/> 開啟</button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-paper relative">
                    {toast && (
                        <div className={`fixed top-20 md:top-4 left-1/2 -translate-x-1/2 px-4 py-3 rounded-xl shadow-xl z-50 animate-fade-in-down text-white text-sm font-bold flex items-center gap-2 ${toast.type === 'error' ? 'bg-dried-500' : 'bg-wood-400'}`}>
                            {toast.type === 'error' ? <AlertTriangle size={16}/> : <CheckCircle size={16}/>}
                            {toast.message}
                        </div>
                    )}

                    <header className="bg-paper/80 backdrop-blur sticky top-0 z-20 border-b border-stone-200">
                        <div className="max-w-3xl mx-auto px-4 py-4 md:px-6 md:py-5 flex justify-between items-center">
                            <div className="flex items-center gap-3 text-ink font-bold text-xl md:text-2xl tracking-widest">
                                <BookOpen className="text-wood-400" strokeWidth={1.5} />
                                <span>閱讀手帳</span>
                            </div>
                            <div className="flex items-center gap-3 md:gap-4 flex-1 justify-end min-w-0">
                                <div className="text-xs text-sub bg-stone-100 px-3 py-1 rounded-full truncate max-w-[120px]">ID: {customId}</div>
                                <button onClick={handleLogout} className="text-stone-400 hover:text-ink transition"><LogOut size={20} strokeWidth={1.5}/></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-3xl mx-auto px-4 py-6 md:px-6 md:py-8 space-y-8">
                        <section className="space-y-4">
                            <div className="grid grid-cols-2 gap-3 md:gap-4">
                                <div className="bg-white/50 p-4 md:p-5 rounded-2xl border border-stone-200 flex flex-col justify-between relative overflow-hidden soft-shadow">
                                    <div className="absolute right-0 top-0 p-3 opacity-5 text-wood-500"><Hourglass size={40}/></div>
                                    <div className="text-xs md:text-sm text-sub font-medium mb-1">未讀</div>
                                    <div className="text-3xl md:text-4xl font-bold text-stone-600 flex items-baseline gap-1 md:gap-2">
                                        {stats.total.reading} <span className="text-xs md:text-sm font-normal text-stone-400">本</span>
                                    </div>
                                </div>
                                <div className="bg-sage-50 p-4 md:p-5 rounded-2xl border border-sage-100 flex flex-col justify-between relative overflow-hidden soft-shadow">
                                    <div className="absolute right-0 top-0 p-3 opacity-10 text-wood-500"><Trophy size={40}/></div>
                                    <div className="text-xs md:text-sm text-wood-400 font-medium mb-1">生涯累積完食</div>
                                    <div className="text-3xl md:text-4xl font-bold text-ink flex items-baseline gap-1 md:gap-2">
                                        {stats.total.finished} <span className="text-xs md:text-sm font-normal text-sub">本</span>
                                    </div>
                                    {stats.total.dropped > 0 && <div className="text-[10px] md:text-xs text-dried-500 text-right mt-1">累積棄書 {stats.total.dropped}</div>}
                                </div>
                            </div>
                            {stats.years.length > 0 && (
                                <div className="grid gap-3 grid-cols-2 md:grid-cols-3">
                                    {stats.years.map(y => (
                                        <div key={y} className="bg-white/40 p-3 md:p-4 rounded-xl border border-stone-100 flex flex-col items-center">
                                            <span className="text-xs md:text-sm font-bold text-wood-400 mb-2">{y}</span>
                                            <div className="flex gap-4 md:gap-6 w-full justify-center items-center">
                                                <div className="text-center"><div className="text-sage-500 font-medium text-lg md:text-xl">{stats.data[y].finished}</div><div className="text-[10px] text-sub">完食</div></div>
                                                <div className="h-6 w-[1px] bg-stone-200"></div>
                                                <div className="text-center"><div className="text-dried-500 font-medium text-lg md:text-xl">{stats.data[y].dropped}</div><div className="text-[10px] text-sub">棄書</div></div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </section>

                        <section className="bg-white/80 rounded-2xl md:rounded-3xl border border-stone-200 p-5 md:p-8 soft-shadow">
                            <div className="flex justify-between items-center mb-4 md:mb-6">
                                <h2 className="text-lg md:text-xl font-bold flex items-center gap-2 text-ink border-l-4 border-wood-300 pl-3">
                                    <PenTool className="text-wood-400 w-5 h-5" /> 紀錄新書
                                </h2>
                                <button 
                                    onClick={() => fileInputRef.current?.click()}
                                    className="text-xs flex items-center gap-1.5 px-3 py-1.5 bg-stone-100 text-stone-500 hover:bg-stone-200 rounded-lg transition"
                                >
                                    <FileUp size={14} /> 匯入 CSV
                                </button>
                                <input type="file" ref={fileInputRef} onChange={handleImportCSV} accept=".csv" className="hidden" />
                            </div>
                            <form onSubmit={addBook} className="grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-5">
                                <div className="md:col-span-5"><input placeholder="書名" value={newBook.title} onChange={e=>setNewBook({...newBook, title:e.target.value})} className="w-full p-2 bg-transparent border-b border-stone-200 focus:border-wood-300 outline-none placeholder-stone-300" required /></div>
                                <div className="md:col-span-4"><input placeholder="作者" value={newBook.author} onChange={e=>setNewBook({...newBook, author:e.target.value})} className="w-full p-2 bg-transparent border-b border-stone-200 focus:border-wood-300 outline-none placeholder-stone-300" /></div>
                                <div className="md:col-span-3"><button type="button" onClick={searchBookInfo} disabled={isSearching || !newBook.title} className="w-full h-full text-wood-500 bg-stone-100 hover:bg-stone-200 rounded-lg transition flex items-center justify-center gap-1 text-sm font-medium disabled:opacity-50 py-3 md:py-2">{isSearching ? <RefreshCw className="animate-spin w-4 h-4" /> : <Search className="w-4 h-4" />} 搜尋</button></div>
                                
                                <div className="md:col-span-12 relative">
                                    <CategoryPicker selectedCategories={newBook.category} onToggle={toggleNewBookCategory} allCategories={categories} onAddNew={(name) => handleAddNewCategoryWrapper(name, setNewBook)} onDelete={handleDeleteCategory} />
                                </div>

                                <div className="md:col-span-4"><div className="relative"><input type="number" placeholder="字數/頁數" value={newBook.wordCount} onChange={e=>setNewBook({...newBook, wordCount:e.target.value, isWordCountManual:true})} className="w-full p-2 bg-transparent border-b border-stone-200 focus:border-wood-300 outline-none placeholder-stone-300" />{!newBook.isWordCountManual && newBook.wordCount && <span className="absolute right-0 top-2 text-[10px] text-stone-400 bg-stone-50 px-1 rounded">估算</span>}</div></div>
                                <div className="md:col-span-4"><input type="date" value={newBook.addDate} onChange={e=>setNewBook({...newBook, addDate:e.target.value})} className="w-full p-2 bg-transparent border-b border-stone-200 text-sub focus:border-wood-300 outline-none" /></div>
                                <div className="md:col-span-4"><input type="url" placeholder="推薦網址" value={newBook.reviewUrl} onChange={e=>setNewBook({...newBook, reviewUrl:e.target.value})} className="w-full p-2 bg-transparent border-b border-stone-200 focus:border-wood-300 outline-none placeholder-stone-300" /></div>
                                <div className="md:col-span-12"><textarea placeholder="故事大綱..." value={newBook.synopsis} onChange={e=>setNewBook({...newBook, synopsis:e.target.value})} className="w-full p-3 bg-stone-50/50 rounded-xl border border-stone-200 focus:border-stone-300 outline-none h-24 placeholder-stone-300 resize-none text-base" /></div>
                                <div className="md:col-span-12 flex justify-end"><button type="submit" className="w-full md:w-auto bg-wood-400 text-white px-8 py-3 md:py-2.5 rounded-xl font-medium hover:bg-wood-500 transition shadow-md flex items-center justify-center gap-2"><Plus size={18} /> 加入書櫃</button></div>
                            </form>
                        </section>

                        <section className="space-y-4">
                            <div className="flex flex-col md:flex-row md:items-center gap-3 mb-2 px-2">
                                <h2 className="text-lg md:text-xl font-bold text-ink">書單列表</h2>
                                {loading && <RefreshCw className="animate-spin text-stone-400 w-4 h-4" />}
                                <div className="flex-1 flex items-center gap-2 bg-white/60 px-3 py-2 rounded-xl border border-stone-200 soft-shadow">
                                    <Filter size={16} className="text-stone-400" />
                                    <input type="text" placeholder="搜尋書名、作者或分類..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="bg-transparent border-none outline-none w-full text-sm text-ink placeholder-stone-300" />
                                    {searchTerm && <button onClick={() => setSearchTerm('')}><X size={14} className="text-stone-400"/></button>}
                                </div>
                            </div>
                            
                            {!loading && filteredBooks.length === 0 && (
                                <div className="text-center py-10 text-stone-400 bg-white/30 rounded-2xl border border-dashed border-stone-200">
                                    <BookOpen className="mx-auto mb-2 opacity-30 w-10 h-10" />
                                    <p className="text-sm">書櫃空蕩蕩，選個安靜的午後開始閱讀吧。</p>
                                </div>
                            )}

                            <div className="grid grid-cols-1 gap-4 md:gap-6">
                                {filteredBooks.map(book => (
                                    <div key={book.id} className="group bg-white p-4 md:p-6 rounded-2xl border border-stone-200 hover:border-wood-200 transition-all duration-300 animate-fade-in soft-shadow flex flex-col md:flex-row gap-4 relative overflow-hidden">
                                        <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${book.status==='finished'?'bg-sage-500': book.status==='dropped'?'bg-dried-500': 'bg-stone-300'}`}></div>
                                        <div className="flex-1 pl-3 md:pl-0">
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <div className="flex flex-wrap gap-2 items-center mb-1">
                                                        {book.category && (Array.isArray(book.category) ? book.category : [book.category]).map((cat, idx) => (
                                                            <span key={idx} className="text-[10px] md:text-xs text-stone-500 bg-stone-100 px-2 py-0.5 rounded-sm">{cat}</span>
                                                        ))}
                                                        <span className={`px-2 py-0.5 rounded-full text-[10px] md:text-xs ${book.status==='finished'?'bg-sage-100 text-sage-text': book.status==='dropped'?'bg-dried-100 text-dried-text': 'bg-stone-100 text-stone-500'}`}>{book.status==='finished'?'已完食':book.status==='dropped'?'棄書':'未讀'}</span>
                                                    </div>
                                                    <h3 className="font-bold text-lg md:text-xl text-ink leading-relaxed">{book.title}</h3>
                                                </div>
                                                {book.status === 'finished' && book.rating > 0 && <StarRating rating={book.rating} />}
                                            </div>
                                            <div className="text-sm text-sub space-y-2">
                                                <div className="flex flex-wrap gap-4 text-xs opacity-70">
                                                    <span className="flex items-center gap-1"><User size={12}/> {book.author||'佚名'}</span>
                                                    <span className="flex items-center gap-1"><TrendingUp size={12}/> {book.wordCount ? `${Number(book.wordCount).toLocaleString()}字` : '未知'}</span>
                                                    <span className="flex items-center gap-1"><Calendar size={12}/> {book.addDate}</span>
                                                </div>
                                                {book.status === 'finished' && (
                                                    <div className="mt-2 bg-sage-50/50 p-3 rounded-lg border border-sage-100">
                                                        <p className="text-sage-text flex items-center gap-2 text-xs md:text-sm font-medium"><CheckCircle size={14}/> 完食於 {book.finishDate}</p>
                                                        {book.review && <p className="text-sage-600 text-xs mt-1 pl-5 border-l-2 border-sage-200 ml-0.5">{book.review}</p>}
                                                    </div>
                                                )}
                                                {book.status === 'dropped' && <div className="text-dried-text mt-2 bg-dried-50/50 p-2 rounded-lg border border-dried-100 text-xs md:text-sm"><p className="flex items-center gap-2 font-medium"><BookX size={14}/> 第{book.dropChapter}章棄書</p>{book.dropDate && <p className="text-xs opacity-60 mt-1 ml-6">日期: {book.dropDate}</p>}</div>}
                                                {book.reviewUrl && <div className="mt-2"><a href={book.reviewUrl} target="_blank" className="inline-flex items-center gap-1 text-wood-400 hover:text-wood-600 hover:underline transition text-xs"><LinkIcon size={12}/> 閱讀推薦文章</a></div>}
                                                {book.synopsis && <div className="mt-2 pt-2 border-t border-stone-100 border-dashed"><button onClick={()=>toggleSynopsis(book.id)} className="flex items-center gap-1.5 text-xs text-stone-400 hover:text-stone-600 transition mb-1 py-1"><FileText size={12}/> {expandedBooks[book.id] ? '收起大綱' : '查看故事大綱'}</button>{expandedBooks[book.id] && <p className="text-xs text-sub leading-relaxed bg-stone-50/50 p-3 rounded-lg whitespace-pre-wrap">{book.synopsis}</p>}</div>}
                                            </div>
                                        </div>
                                        <div className="flex flex-row md:flex-col gap-2 mt-3 pt-3 border-t border-stone-100 md:mt-0 md:pt-0 md:border-t-0 md:border-l md:pl-4 md:w-32 shrink-0">
                                            {book.status === 'reading' ? (
                                                <>
                                                   <button onClick={(e)=>openModal(book, 'finish', e)} className="flex-1 md:w-full py-2 px-3 bg-sage-100 text-sage-600 hover:bg-sage-200 rounded-lg text-xs font-medium transition flex items-center justify-center gap-1.5 border border-sage-200"><CheckCircle size={14} /> 完食</button>
                                                   <button onClick={(e)=>openModal(book, 'drop', e)} className="flex-1 md:w-full py-2 px-3 bg-dried-100 text-dried-600 hover:bg-dried-200 rounded-lg text-xs font-medium transition flex items-center justify-center gap-1.5 border border-dried-200"><BookX size={14} /> 棄書</button>
                                                </>
                                            ) : (
                                                <button onClick={(e)=>openModal(book, 'reset', e)} className="flex-1 md:w-full py-2 px-3 bg-stone-100 text-stone-600 hover:bg-stone-200 rounded-lg text-xs font-medium transition flex items-center justify-center gap-1.5 border border-stone-200"><RotateCcw size={14} /> 重設</button>
                                            )}
                                            <div className="hidden md:block w-full h-px bg-stone-100 my-1"></div>
                                            <div className="flex gap-2 flex-1 md:w-full">
                                                <button onClick={(e)=>openModal(book, 'edit', e)} className="flex-1 py-2 bg-white text-stone-400 hover:text-stone-600 rounded-lg transition flex items-center justify-center border border-stone-200" title="編輯"><Edit3 size={16} /></button>
                                                <button onClick={(e)=>openModal(book, 'delete', e)} className="flex-1 py-2 bg-white text-stone-300 hover:text-dried-500 rounded-lg transition flex items-center justify-center border border-stone-200" title="刪除"><Trash2 size={16} /></button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>

                        {(activeBookId || modalType === 'logout' || modalType === 'deleteCategory') && (
                            <div className="fixed inset-0 bg-stone-800/20 backdrop-blur-sm flex items-end md:items-center justify-center z-50 p-0 md:p-4" onClick={closeModal}>
                                <div className="bg-paper rounded-t-3xl md:rounded-3xl w-full max-w-sm p-6 md:p-8 shadow-2xl border border-stone-200 animate-modal-in max-h-[90vh] overflow-y-auto no-scrollbar" onClick={e => e.stopPropagation()}>
                                    <div className="w-10 h-1 bg-stone-200 rounded-full mx-auto mb-6 md:hidden"></div>
                                    <h3 className="text-xl font-bold mb-4 text-center text-ink border-b border-stone-200 pb-4">
                                        {modalType === 'finish' ? '紀錄完食' : modalType === 'drop' ? '紀錄棄書' : modalType === 'reset' ? '重設狀態' : modalType === 'delete' ? '刪除書籍' : modalType === 'logout' ? '登出確認' : modalType === 'deleteCategory' ? '刪除分類' : '編輯書籍'}
                                    </h3>
                                    <div className="mb-6">
                                        {modalType === 'edit' && (
                                            <div className="space-y-4">
                                                <input placeholder="書名" value={modalData.title} onChange={e=>setModalData({...modalData, title:e.target.value})} className="w-full p-2 bg-white/50 border-b border-stone-200 outline-none" />
                                                <input placeholder="作者" value={modalData.author} onChange={e=>setModalData({...modalData, author:e.target.value})} className="w-full p-2 bg-white/50 border-b border-stone-200 outline-none" />
                                                <CategoryPicker selectedCategories={modalData.category} onToggle={toggleEditBookCategory} allCategories={categories} onAddNew={(name) => handleAddNewCategoryWrapper(name, setModalData)} onDelete={handleDeleteCategory} />
                                                <div className="flex gap-2">
                                                    <input type="number" placeholder="字數" value={modalData.wordCount} onChange={e=>setModalData({...modalData, wordCount:e.target.value})} className="w-1/2 p-2 bg-white/50 border-b border-stone-200 outline-none" />
                                                    <input type="date" value={modalData.addDate} onChange={e=>setModalData({...modalData, addDate:e.target.value})} className="w-1/2 p-2 bg-white/50 border-b border-stone-200 outline-none" />
                                                </div>
                                                <input placeholder="推薦網址" value={modalData.reviewUrl} onChange={e=>setModalData({...modalData, reviewUrl:e.target.value})} className="w-full p-2 bg-white/50 border-b border-stone-200 outline-none" />
                                                <textarea placeholder="大綱" value={modalData.synopsis} onChange={e=>setModalData({...modalData, synopsis:e.target.value})} className="w-full p-3 bg-white/50 rounded-lg outline-none h-24 resize-none border border-stone-200" />
                                            </div>
                                        )}
                                        {modalType === 'finish' && (
                                            <div className="bg-white/50 p-4 rounded-xl space-y-5 border border-stone-200">
                                                <input type="date" value={modalData.date} onChange={e=>setModalData({...modalData, date:e.target.value})} className="w-full bg-transparent border-b border-stone-300 outline-none p-2 text-center" />
                                                <div className="flex flex-col items-center gap-2">
                                                    <label className="text-xs text-sub">給這本書一個評價吧</label>
                                                    <StarRating rating={modalData.rating} setRating={(r) => setModalData({...modalData, rating: r})} interactive={true} />
                                                </div>
                                                <textarea placeholder="寫點什麼紀錄一下心情..." value={modalData.review} onChange={e=>setModalData({...modalData, review:e.target.value})} className="w-full p-2 bg-white rounded-lg border border-stone-200 h-20 text-sm" />
                                            </div>
                                        )}
                                        {modalType === 'drop' && (
                                            <div className="bg-white/50 p-4 rounded-xl space-y-4 border border-stone-200">
                                                <div className="space-y-1"><label className="text-xs text-sub block">棄書日期</label><input type="date" value={modalData.date} onChange={e=>setModalData({...modalData, date:e.target.value})} className="w-full bg-transparent border-b border-stone-300 outline-none p-2 text-center" /></div>
                                                <div className="space-y-1"><label className="text-xs text-sub block">進度紀錄</label><input placeholder="在哪個章節停下了？" value={modalData.chapter} onChange={e=>setModalData({...modalData, chapter:e.target.value})} className="w-full bg-transparent border-b border-stone-300 outline-none p-2 text-center" /></div>
                                            </div>
                                        )}
                                        {['reset', 'delete', 'logout', 'deleteCategory'].includes(modalType) && (
                                            <div className="text-center p-4">
                                                <p className="mb-2 font-bold text-ink">{modalData.category || activeBook?.title}</p>
                                                <p className="text-sm text-sub">確定執行此操作嗎？</p>
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex gap-4">
                                        <button onClick={closeModal} className="flex-1 py-3 text-sub hover:bg-stone-100 rounded-xl transition text-sm">取消</button>
                                        <button onClick={handleModalAction} className={`flex-1 py-3 text-white rounded-xl shadow-md text-sm font-medium ${['finish', 'edit'].includes(modalType)?'bg-sage-500': ['reset', 'logout'].includes(modalType)?'bg-wood-400': 'bg-dried-500'}`}>確認</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<ReadingTracker />);
    </script>
</body>
</html>
