<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的雲端書櫃</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        paper: '#f2f0e9', ink: '#373a36', sub: '#6b705c',
                        wood: { 100: '#e9e7da', 200: '#dad7cd', 300: '#a3b18a', 400: '#588157', 500: '#3a5a40', 600: '#344e41' },
                        sage: { 50: '#f0f4ef', 100: '#e0e9e1', 200: '#c5d5c5', 500: '#84a59d', 600: '#6b8a82', text: '#4a5d5a' },
                        dried: { 50: '#f7f2f2', 100: '#ede0e0', 200: '#d9bfbf', 500: '#b5838d', 600: '#a0717a', text: '#6d4c51' },
                        stone: { 50: '#f5f5f4', 100: '#e7e7e2', 200: '#dcdcc6', 400: '#a7a797', 500: '#7f7f6f', 600: '#5f5f54', text: '#4a4a40' },
                        gold: { 400: '#d4a373', 500: '#bc8a5f' }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-down { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-modal-in { animation: modalIn 0.2s ease-out forwards; }
        html { font-size: 90%; background-color: #f2f0e9; }
        @media (max-width: 768px) {
            html { font-size: 110%; }
            .mobile-edge-to-edge { padding-left: 0.5rem !important; padding-right: 0.5rem !important; }
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .soft-shadow { box-shadow: 0 4px 12px -2px rgba(58, 90, 64, 0.08); }
        .snap-x { scroll-snap-type: x mandatory; }
        .snap-start { scroll-snap-align: start; }
    </style>
</head>
<body class="bg-paper text-ink pb-10">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            BookOpen, Search, Plus, Trash2, CheckCircle, BookX, Calendar, User, LogIn, 
            RefreshCw, TrendingUp, Link as LinkIcon, FileText, PenTool, Trophy, Hourglass, 
            Star, X, RotateCcw, AlertTriangle, Filter, LogOut, Edit3, ChevronDown, ExternalLink 
        } from 'https://esm.sh/lucide-react@0.344.0';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDX1-Lwc5_u_fwV9P25xh32dVF8uVNT0QU",
            authDomain: "my-reading-tracker-58f69.firebaseapp.com",
            projectId: "my-reading-tracker-58f69",
            storageBucket: "my-reading-tracker-58f69.firebasestorage.app",
            messagingSenderId: "370802674969",
            appId: "1:370802674969:web:efb1c045e0028925154988",
            measurementId: "G-52EWLNG7ST"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "my-reading-app"; 
        const ESTIMATE_WORDS_PER_PAGE = 350;
        const DEFAULT_CATEGORIES = ["玄幻", "奇幻", "武俠", "仙俠", "都市", "言情", "古代", "架空", "科幻", "懸疑", "推理", "驚悚", "恐怖", "冒險", "耽美 (BL)", "百合 (GL)", "穿越", "重生", "系統", "快穿", "無限流", "末世", "種田", "宅鬥", "宮鬥", "娛樂圈", "電競", "校園", "職場", "先婚後愛", "破鏡重圓", "青梅竹馬", "異能", "空間", "甜寵", "虐戀", "爽文", "升級流", "治癒", "輕鬆", "沙雕"];

        const CategoryPicker = ({ selectedCategories, onToggle, allCategories, onAddNew, onDelete }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [filterText, setFilterText] = useState('');
            const filtered = useMemo(() => allCategories.filter(c => c.toLowerCase().includes(filterText.toLowerCase())), [allCategories, filterText]);
            return (
                <div className="w-full">
                    <div className="flex flex-wrap gap-2 items-center min-h-[40px] p-2 border-b border-wood-200">
                        {selectedCategories.map(cat => (
                            <span key={cat} className="bg-wood-400 text-white text-xs px-2 py-1 rounded-full flex items-center gap-1 shadow-sm">
                                {cat} <X size={12} className="cursor-pointer" onClick={(e) => { e.stopPropagation(); onToggle(cat); }}/>
                            </span>
                        ))}
                        <button type="button" onClick={() => setIsOpen(!isOpen)} className="text-xs flex items-center gap-1 px-2 py-1 rounded-full text-wood-500 hover:bg-wood-100">{isOpen ? '收起' : '選擇分類'}</button>
                    </div>
                    {isOpen && (
                        <div className="mt-2 p-3 bg-stone-50 rounded-xl border border-stone-200 shadow-sm relative z-10">
                            <input type="text" placeholder="搜尋或建立..." value={filterText} onChange={e => setFilterText(e.target.value)} className="w-full mb-3 p-2 bg-white rounded-lg text-sm outline-none border border-stone-200 focus:ring-1 focus:ring-wood-300" />
                            <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto no-scrollbar">
                                {filterText && !allCategories.includes(filterText) && (
                                    <button type="button" onClick={() => { onAddNew(filterText); setFilterText(''); }} className="bg-wood-500 text-white text-xs px-3 py-1.5 rounded-full flex items-center gap-1"><Plus size={12}/> 建立「{filterText}」</button>
                                )}
                                {filtered.map(cat => !selectedCategories.includes(cat) && (
                                    <div key={cat} className="group relative">
                                        <button type="button" onClick={() => { onToggle(cat); setFilterText(''); }} className="bg-stone-100 text-stone-600 border border-stone-200 text-xs px-3 py-1.5 rounded-full hover:bg-stone-200 transition">{cat}</button>
                                        <button type="button" onClick={(e) => onDelete(cat, e)} className="absolute -top-1 -right-1 bg-white text-stone-300 hover:text-dried-500 rounded-full p-0.5 shadow-sm border opacity-0 group-hover:opacity-100"><X size={10}/></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [books, setBooks] = useState([]);
            const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
            const [loading, setLoading] = useState(true);
            const [customId, setCustomId] = useState('');
            const [isLoginMode, setIsLoginMode] = useState(true);
            const [isAuthChecking, setIsAuthChecking] = useState(true);
            const [toast, setToast] = useState(null); 
            const [searchTerm, setSearchTerm] = useState('');
            const [statusFilter, setStatusFilter] = useState('all'); 
            const [ratingFilter, setRatingFilter] = useState(0); 
            const [isRatingMenuOpen, setIsRatingMenuOpen] = useState(false);
            const [newBook, setNewBook] = useState({ title: '', author: '', wordCount: '', isWordCountManual: false, addDate: new Date().toISOString().split('T')[0], reviewUrl: '', synopsis: '', category: [] });
            const [activeBookId, setActiveBookId] = useState(null);
            const [modalType, setModalType] = useState(null); 
            const [modalData, setModalData] = useState({});
            const [expandedBooks, setExpandedBooks] = useState({});

            useEffect(() => {
                signInAnonymously(auth).catch(e => console.error(e));
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        const savedId = localStorage.getItem('reading_tracker_custom_id');
                        if (savedId) { setCustomId(savedId); setIsLoginMode(false); }
                    }
                    setIsAuthChecking(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !customId) { setLoading(false); return; }
                setLoading(true);
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`);
                const unsubscribe = onSnapshot(colRef, (snap) => {
                    const b = []; let c = [...DEFAULT_CATEGORIES];
                    snap.docs.forEach(doc => {
                        if (doc.id === 'settings') { if (doc.data()?.categories) c = doc.data().categories; }
                        else b.push({ id: doc.id, ...doc.data() });
                    });
                    b.sort((x, y) => {
                        if (x.status === 'reading' && y.status !== 'reading') return -1;
                        if (x.status !== 'reading' && y.status === 'reading') return 1;
                        return new Date(y.addDate || 0) - new Date(x.addDate || 0);
                    });
                    setBooks(b); setCategories(c); setLoading(false);
                }, () => setLoading(false));
                return () => unsubscribe();
            }, [user, customId]);

            const showToast = (m, t = 'info') => { setToast({ message: m, type: t }); setTimeout(() => setToast(null), 3000); };
            const handleLogin = (e) => { e.preventDefault(); if (!customId.trim()) return; localStorage.setItem('reading_tracker_custom_id', customId.trim()); setIsLoginMode(false); };
            const handleLogout = () => setModalType('logout');

            const handleModalAction = async () => {
                if (!modalType) return;
                try {
                    if (modalType === 'logout') { localStorage.removeItem('reading_tracker_custom_id'); setCustomId(''); setBooks([]); setIsLoginMode(true); closeModal(); return; }
                    if (modalType === 'deleteCategory') { const nc = categories.filter(c => c !== modalData.category); await setDoc(doc(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`, 'settings'), { categories: nc }, { merge: true }); closeModal(); return; }
                    const bRef = doc(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`, activeBookId || modalData.id);
                    if (modalType === 'delete') await deleteDoc(bRef);
                    else if (modalType === 'edit') await updateDoc(bRef, { title: modalData.title, author: modalData.author, category: modalData.category || [], wordCount: modalData.wordCount, addDate: modalData.addDate, reviewUrl: modalData.reviewUrl, synopsis: modalData.synopsis });
                    else {
                        const up = {};
                        if (modalType === 'finish') { up.status = 'finished'; up.finishDate = modalData.date; up.rating = modalData.rating; up.review = modalData.review || ''; }
                        else if (modalType === 'drop') { up.status = 'dropped'; up.dropChapter = modalData.chapter; up.dropDate = modalData.date; }
                        else if (modalType === 'reset') { up.status = 'reading'; up.finishDate = null; up.dropChapter = null; up.dropDate = null; up.rating = null; up.review = null; }
                        await updateDoc(bRef, up);
                    }
                    showToast("更新成功"); closeModal();
                } catch { showToast("失敗", "error"); }
            };

            const filteredBooks = useMemo(() => {
                let l = books || [];
                if (statusFilter !== 'all') l = l.filter(b => b.status === statusFilter);
                if (ratingFilter > 0) l = l.filter(b => (b.rating || 0) >= ratingFilter);
                if (searchTerm.trim()) {
                    const t = searchTerm.toLowerCase();
                    l = l.filter(b => (b.title || '').toLowerCase().includes(t) || (b.author || '').toLowerCase().includes(t) || (b.category || []).some(c => c.toLowerCase().includes(t)));
                }
                return l;
            }, [books, searchTerm, statusFilter, ratingFilter]);

            const stats = useMemo(() => {
                const ys = {}; let tf = 0, td = 0, tr = 0; const ay = new Set();
                books.forEach(b => {
                    if (b.status === 'reading') tr++;
                    else {
                        const date = b.status === 'finished' ? b.finishDate : b.dropDate;
                        if (date) {
                            const y = new Date(date).getFullYear();
                            if (y && !isNaN(y)) {
                                ay.add(y); if (!ys[y]) ys[y] = { finished: 0, dropped: 0 };
                                if (b.status === 'finished') { tf++; ys[y].finished++; } else { td++; ys[y].dropped++; }
                            }
                        }
                    }
                });
                return { years: Array.from(ay).sort((a,b) => b-a), data: ys, total: { finished: tf, dropped: td, reading: tr } };
            }, [books]);

            const openModal = (b, t, e) => { if (e) e.stopPropagation(); setActiveBookId(b.id); setModalType(t); setModalData(t === 'edit' ? { ...b } : { date: new Date().toISOString().split('T')[0], rating: 0 }); };
            const closeModal = () => { setActiveBookId(null); setModalType(null); setModalData({}); };

            if (isAuthChecking) return <div className="min-h-screen flex items-center justify-center bg-paper"><RefreshCw className="animate-spin text-wood-400" /></div>;

            if (isLoginMode) return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-paper">
                    <div className="bg-white/60 p-8 rounded-3xl shadow-lg border border-stone-200 w-full max-w-md">
                        <BookOpen size={56} className="text-wood-400 mx-auto mb-6" />
                        <h1 className="text-3xl font-bold text-center mb-3">雲端書櫃</h1>
                        <form onSubmit={handleLogin} className="space-y-5">
                            <input value={customId} onChange={e => setCustomId(e.target.value)} placeholder="ID" className="w-full p-3 bg-white/50 border-b-2 outline-none text-center" />
                            <button type="submit" className="w-full bg-wood-400 text-white py-3 rounded-xl font-bold">開啟</button>
                        </form>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-paper relative">
                    {toast && <div className="fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-xl z-50 bg-wood-400 text-white text-sm">{toast.message}</div>}
                    
                    <header className="bg-paper/80 backdrop-blur sticky top-0 z-20 border-b border-stone-200">
                        <div className="max-w-3xl mx-auto px-4 py-2 md:py-5 flex justify-between items-center">
                            <div className="flex items-center gap-2 font-bold text-lg md:text-2xl tracking-widest">
                                <BookOpen className="text-wood-400 w-5 h-5 md:w-6 md:h-6" /> <span>閱讀手帳</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="bg-stone-100 px-2 py-0.5 rounded-full text-[10px] md:text-xs">ID: {customId}</span>
                                <button onClick={handleLogout} className="text-stone-400 hover:text-ink"><LogOut size={18}/></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-3xl mx-auto px-4 py-4 space-y-4 mobile-edge-to-edge">
                        {/* 主統計框窄化 */}
                        <section className="grid grid-cols-2 gap-2">
                            <div className="bg-white/50 p-3 rounded-xl border border-stone-200 flex flex-col justify-center relative overflow-hidden">
                                <Hourglass className="absolute right-0 top-0 p-1 opacity-5 text-wood-500" size={30} />
                                <div className="text-[10px] text-sub">待讀</div>
                                <div className="text-xl md:text-3xl font-bold">{stats.total.reading} <span className="text-[10px] font-normal">本</span></div>
                            </div>
                            <div className="bg-sage-50 p-3 rounded-xl border border-sage-100 flex flex-col justify-center relative overflow-hidden">
                                <Trophy className="absolute right-0 top-0 p-1 opacity-10 text-wood-500" size={30} />
                                <div className="text-[10px] text-wood-400">生涯完食</div>
                                <div className="text-xl md:text-3xl font-bold">{stats.total.finished} <span className="text-[10px] font-normal">本</span></div>
                            </div>
                        </section>

                        {/* 年度統計橫向滑動 */}
                        {stats.years.length > 0 && (
                            <div className="flex gap-2 overflow-x-auto no-scrollbar snap-x py-1">
                                {stats.years.map(y => (
                                    <div key={y} className="flex-none w-[130px] md:w-1/3 snap-start bg-white/40 p-2 rounded-xl border border-stone-100 flex flex-col items-center">
                                        <span className="text-[10px] font-bold text-wood-400 mb-1">{y}</span>
                                        <div className="flex gap-3 items-center">
                                            <div className="text-center"><div className="text-sage-500 font-bold text-sm leading-none">{stats.data[y].finished}</div><div className="text-[8px] text-sub mt-1">完食</div></div>
                                            <div className="h-4 w-px bg-stone-200"></div>
                                            <div className="text-center"><div className="text-dried-500 font-bold text-sm leading-none">{stats.data[y].dropped}</div><div className="text-[8px] text-sub mt-1">棄書</div></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        <section className="bg-white/80 rounded-xl border border-stone-200 p-4 md:p-8 soft-shadow">
                            <h2 className="text-base font-bold mb-4 flex items-center gap-2 border-l-4 border-wood-300 pl-2"><PenTool size={18}/> 紀錄新書</h2>
                            <form onSubmit={(e) => { e.preventDefault(); if(!newBook.title) return; addDoc(collection(db, 'artifacts', appId, 'public', 'data', `reading_list_${customId}`), { ...newBook, status: 'reading', createdAt: serverTimestamp() }); setNewBook({...newBook, title:''}); showToast("已加入"); }} className="grid gap-3">
                                <input placeholder="書名" value={newBook.title} onChange={e => setNewBook({...newBook, title:e.target.value})} className="w-full p-2 border-b outline-none" required />
                                <div className="flex justify-end"><button type="submit" className="bg-wood-400 text-white px-6 py-2 rounded-xl text-sm">加入書櫃</button></div>
                            </form>
                        </section>

                        <section className="space-y-3">
                            <div className="flex flex-col gap-2">
                                <div className="flex justify-between items-center px-1">
                                    <h2 className="font-bold text-ink">書單列表</h2>
                                    <div className="relative">
                                        <button onClick={() => setIsRatingMenuOpen(!isRatingMenuOpen)} className="flex items-center gap-1 px-2 py-1 bg-white border rounded-lg text-[10px]">評分篩選 <ChevronDown size={12}/></button>
                                        {isRatingMenuOpen && <div className="absolute right-0 mt-1 w-24 bg-white border rounded shadow-xl z-30">{[0,4,3].map(v => <button key={v} onClick={()=>{setRatingFilter(v);setIsRatingMenuOpen(false)}} className="w-full p-2 text-left text-[10px] hover:bg-stone-50">{v===0?'全部':v+'星+'}</button>)}</div>}
                                    </div>
                                </div>
                                <div className="flex gap-1 overflow-x-auto no-scrollbar">
                                    {['all', 'reading', 'finished', 'dropped'].map(s => (
                                        <button key={s} onClick={() => setStatusFilter(s)} className={`px-3 py-1 rounded-full text-[10px] border ${statusFilter === s ? 'bg-wood-400 text-white' : 'bg-white text-stone-500'}`}>{s==='all'?'全部':s==='reading'?'待讀':s==='finished'?'完食':'棄書'}</button>
                                    ))}
                                </div>
                            </div>

                            <div className="grid gap-3">
                                {filteredBooks.map(b => (
                                    <div key={b.id} className="bg-white p-3 rounded-xl border border-stone-200 soft-shadow relative animate-fade-in-down">
                                        <div className={`absolute left-0 top-0 bottom-0 w-1 ${b.status==='finished'?'bg-sage-500': b.status==='dropped'?'bg-dried-500':'bg-stone-300'}`} />
                                        <div className="flex justify-between items-start">
                                            <div className="min-w-0 flex-1">
                                                <div className="flex items-center gap-1">
                                                    <h3 className="font-bold text-base">{b.title}</h3>
                                                    <button onClick={() => window.open(`https://www.google.com/search?q=${encodeURIComponent(b.title)}`, '_blank')} className="text-stone-300"><ExternalLink size={12}/></button>
                                                </div>
                                                <div className="text-[10px] text-sub">{b.author || '佚名'}</div>
                                            </div>
                                            <div className="flex flex-col gap-2 items-end">
                                                <div className="flex gap-1">
                                                    {b.status==='reading' ? (
                                                        <><button onClick={(e)=>openModal(b,'finish',e)} className="p-1 bg-sage-50 rounded text-sage-600"><CheckCircle size={14}/></button>
                                                        <button onClick={(e)=>openModal(b,'drop',e)} className="p-1 bg-dried-50 rounded text-dried-600"><BookX size={14}/></button></>
                                                    ) : <button onClick={(e)=>openModal(b,'reset',e)} className="p-1 bg-stone-50 rounded text-stone-400"><RotateCcw size={14}/></button>}
                                                    <button onClick={(e)=>openModal(b,'edit',e)} className="p-1 text-stone-300"><Edit3 size={14}/></button>
                                                    <button onClick={(e)=>openModal(b,'delete',e)} className="p-1 text-stone-300"><Trash2 size={14}/></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>

                        {modalType && (
                            <div className="fixed inset-0 bg-stone-800/20 backdrop-blur-sm flex items-end justify-center z-50 p-0 md:p-4" onClick={closeModal}>
                                <div className="bg-paper rounded-t-3xl w-full max-w-sm p-6 shadow-2xl animate-modal-in" onClick={e=>e.stopPropagation()}>
                                    <h3 className="text-center font-bold mb-4 border-b pb-2">{modalType === 'edit' ? '編輯書籍' : '確認操作'}</h3>
                                    <div className="space-y-4 mb-6">
                                        {modalType === 'edit' ? (
                                            <input value={modalData.title || ''} onChange={e=>setModalData({...modalData, title:e.target.value})} className="w-full p-2 border-b bg-transparent" placeholder="書名" />
                                        ) : <p className="text-center text-sm">確定要執行「{modalType}」嗎？</p>}
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={closeModal} className="flex-1 py-2 rounded-xl text-sub hover:bg-stone-100">取消</button>
                                        <button onClick={handleModalAction} className="flex-1 py-2 rounded-xl bg-wood-400 text-white">確認</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
