<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·¥ç¨‹éšå±¤çµç®—ç³»çµ±</title>
    <style>
        :root {
            --bg: #F7F6F2;
            --card: #FFFFFF;
            --primary: #8E9775;
            --accent: #AF8F6F;
            --text: #4A4A4A;
            --border: #E0DED7;
            --danger: #e74c3c;
        }

        body { background-color: var(--bg); color: var(--text); font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; width: 100%; max-width: 600px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #E0DED7; cursor: pointer; border-radius: 8px 8px 0 0; color: #777; font-weight: bold; transition: 0.3s; font-size: 0.9rem; }
        .tab-btn.active { background: var(--primary); color: white; }

        .page { display: none; width: 100%; max-width: 500px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card); width: 100%; padding: 25px; border-radius: 0 0 15px 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); box-sizing: border-box; margin-bottom: 20px; }
        .list-card { background: var(--card); width: 100%; max-width: 900px; padding: 25px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); box-sizing: border-box; }
        
        h2 { text-align: center; color: var(--primary); font-weight: 500; margin-bottom: 20px; letter-spacing: 1px; }
        .row { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; }
        .col { flex: 1; display: flex; flex-direction: column; }
        
        label { font-size: 0.8rem; margin-bottom: 5px; color: #999; }
        input, select { padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; outline: none; background: #FAFAFA; width: 100%; box-sizing: border-box; }
        input:focus, select:focus { border-color: var(--primary); background: #FFF; }
        
        /* æœå°‹å»ºè­°æ¡† */
        .search-container { position: relative; }
        .search-wrapper { display: flex; gap: 5px; }
        .btn-search { background: var(--primary); color: white; border: none; border-radius: 8px; width: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; z-index: 100; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .suggestion-item:hover { background: #f0f2eb; }

        #netAmount { font-weight: bold; color: var(--accent); background-color: #FFF9F3; border: 1px solid var(--accent); }
        .config-box { background: #F9F9F8; padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid #EEE; }
        .payment-box { border-top: 2px solid var(--primary); padding-top: 15px; margin-top: 20px; }
        
        .input-with-unit { position: relative; display: flex; align-items: center; }
        .unit-label { margin-left: 5px; font-size: 0.8rem; color: #999; white-space: nowrap; width: 20px; }

        .display-area { background: #FCFCFB; border: 1px solid #EEE; padding: 20px; border-radius: 10px; margin-top: 20px; min-height: 50px; }
        .section-title { font-size: 0.85rem; font-weight: bold; color: var(--primary); margin-bottom: 10px; border-left: 3px solid var(--primary); padding-left: 8px; }
        
        .formula { font-size: 0.9rem; margin-bottom: 12px; line-height: 1.6; color: #666; }
        .formula strong { color: #333; font-weight: 600; }
        .subtotal-line { background: #F0F2EB; padding: 4px 8px; border-radius: 4px; color: var(--primary) !important; }
        
        .payment-result { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #DDD; }
        .date-line { font-family: monospace; font-weight: bold; font-size: 1.1rem; color: var(--accent); margin-bottom: 5px; }

        .btn-save { width: 100%; padding: 12px; margin-top: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-excel { padding: 10px 20px; background: #217346; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 15px; }
        .btn-remit { padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 15px; margin-left: 5px; }
        .btn-reset { width: 100%; padding: 10px; margin-top: 10px; color: #BBB; border: 1px solid #EEE; background: none; cursor: pointer; border-radius: 8px; font-size: 0.8rem; }
        .btn-import { background: #6b7280; color: white; padding: 10px; border-radius: 8px; cursor: pointer; border: none; font-size: 0.8rem; }
        
        .check-label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .check-label input[type="checkbox"] { width: auto; margin: 0; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        th { background-color: #f8f8f8; color: var(--primary); }
        .editable { cursor: pointer; background-color: #fffdec; border-radius: 4px; padding: 2px 5px; display: inline-block; width: 90%; }
        .amount-cell { text-align: right; font-family: monospace; }
        .action-cell { text-align: center; width: 40px; }
        .btn-del { color: var(--danger); border: none; background: none; cursor: pointer; font-weight: bold; font-size: 1.3rem; }
        
        .filter-row { margin-bottom: 15px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px; justify-content: space-between; }
        .filter-group { display: flex; align-items: center; gap: 5px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 450px; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .close-modal { position: absolute; right: 15px; top: 15px; font-size: 1.5rem; cursor: pointer; color: #999; }
    </style>
</head>
<body>

<div class="tabs">
    <button class="tab-btn active" onclick="switchPage('calcPage', this)">è¨ˆç®—å·¥å…·</button>
    <button class="tab-btn" onclick="switchPage('listPage', this)">ä»˜æ¬¾æ¸…å–®</button>
    <button class="tab-btn" onclick="switchPage('vendorPage', this)">å» å•†ç®¡ç†</button>
</div>

<div id="calcPage" class="page active">
    <div class="card">
        <h2>å·¥ç¨‹çµç®—æ˜ç´°</h2>
        <div class="row">
            <div class="col">
                <label>ä»˜æ¬¾å…¬å¸</label>
                <select id="companySelect">
                    <option value="ç€å·">ç€å·</option>
                    <option value="è¿å·">è¿å·</option>
                    <option value="é•·å·">é•·å·</option>
                    <option value="ä¸Šå·">ä¸Šå·</option>
                </select>
            </div>
            <div class="col search-container">
                <label>æœå°‹å» å•† (è‡ªå‹•å¸¶å…¥åŒ¯æ¬¾è³‡æ–™)</label>
                <div class="search-wrapper">
                    <input type="text" id="vendorSearch" placeholder="è¼¸å…¥åç¨±é—œéµå­—" oninput="searchVendor(this.value)">
                    <button class="btn-search" onclick="searchVendor(document.getElementById('vendorSearch').value)">ğŸ”</button>
                </div>
                <div id="vendorSuggestions" class="suggestions"></div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>å·¥ç¨‹å…§å®¹ (æ˜ç´°)</label>
                <input type="text" id="workNote" placeholder="ä¾‹å¦‚ï¼šé ‚ç¾æ®µ-å¼˜é¾-æœ¨åœ°æ¿å·²å®Œæˆ54æˆ¶è«‹æ¬¾">
            </div>
        </div>

        <div id="vendorInfoDisplay" style="display:none; font-size: 0.75rem; color: var(--accent); margin-bottom: 10px; padding: 8px; background: #fdfaf5; border-radius: 5px;">
            <span id="vBank"></span> | <span id="vAccount"></span> | <span id="vName"></span>
        </div>

        <div class="row">
            <div class="col">
                <label>æœªç¨…é‡‘é¡</label>
                <input type="number" id="rawAmount" placeholder="è«‹è¼¸å…¥é‡‘é¡" oninput="calculate(false, false)">
            </div>
            <div class="col">
                <label>ç¨…é¡ (5%)</label>
                <input type="number" id="taxAmount" oninput="calculate(true, false)">
            </div>
        </div>

        <div class="config-box">
            <div class="row">
                <div class="col">
                    <label class="check-label"><input type="checkbox" id="cleanCheck" checked onchange="calculate(false, false)"> æ¸…æ½”ä¿éšª (%)</label>
                    <input type="number" id="cleanRate" value="0.5" step="0.1" oninput="calculate(false, false)">
                </div>
                <div class="col">
                    <label class="check-label"><input type="checkbox" id="retentionCheck" checked onchange="calculate(false, false)"> ä¿ç•™æ¬¾ (%)</label>
                    <input type="number" id="retentionRate" value="10" step="1" oninput="calculate(false, false)">
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label>ä¿ç•™æ¬¾é‡‘é¡ (å¯æ‰‹å‹•ä¿®æ”¹)</label>
                    <input type="number" id="retentionAmount" oninput="calculate(true, true)">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label>æœ€çµ‚æ·¨é¡ (å¯æ‰‹å‹•ä¿®æ”¹)</label>
                <input type="number" id="netAmount" oninput="renderDetail()">
            </div>
        </div>

        <div class="payment-box">
            <label>ä»˜æ¬¾æ¯”ä¾‹ / æœŸæ•¸ (æœˆ)</label>
            <div class="row">
                <div class="col"><div class="input-with-unit"><input type="number" id="p1Pct" placeholder="æ¯”ä¾‹" oninput="renderDetail()"><span class="unit-label">%</span></div></div>
                <div class="col"><div class="input-with-unit"><input type="number" id="p1Mon" placeholder="æœŸæ•¸" oninput="renderDetail()"><span class="unit-label">æœˆ</span></div></div>
            </div>
            <div class="row">
                <div class="col"><div class="input-with-unit"><input type="number" id="p2Pct" placeholder="æ¯”ä¾‹" oninput="renderDetail()"><span class="unit-label">%</span></div></div>
                <div class="col"><div class="input-with-unit"><input type="number" id="p2Mon" placeholder="æœŸæ•¸" oninput="renderDetail()"><span class="unit-label">æœˆ</span></div></div>
            </div>
        </div>

        <div class="display-area">
            <div class="section-title">éšå±¤è¨ˆç®—åˆ—ç¤º</div>
            <div id="processFormula" class="formula">è«‹è¼¸å…¥è³‡æ–™...</div>
            <div class="payment-result" id="paymentDetail"></div>
        </div>

        <button class="btn-save" onclick="saveData()">å„²å­˜æ­¤ç­†æ’ç¨‹</button>
        <button class="btn-reset" onclick="location.reload()">é‡æ–°æ•´ç†</button>
    </div>
</div>

<div id="listPage" class="page" style="max-width: 900px;">
    <div class="list-card">
        <div class="section-title">ä»˜æ¬¾æ¸…å–®æ˜ç´°</div>
        <div class="filter-row">
            <div class="filter-group">
                <label>æœˆä»½ï¼š</label>
                <select id="filterMonth" style="width: auto; padding: 5px;" onchange="renderTable()"></select>
            </div>
            <div class="filter-group">
                <label>å…¬å¸ï¼š</label>
                <select id="filterCompany" style="width: auto; padding: 5px;" onchange="renderTable()">
                    <option value="å…¨éƒ¨">å…¨éƒ¨é¡¯ç¤º</option>
                    <option value="ç€å·">ç€å·</option>
                    <option value="è¿å·">è¿å·</option>
                    <option value="é•·å·">é•·å·</option>
                    <option value="ä¸Šå·">ä¸Šå·</option>
                </select>
            </div>
            <div>
                <button class="btn-excel" onclick="exportToExcel()">åŒ¯å‡º Excel æ¸…å–®</button>
                <button class="btn-remit" onclick="exportRemittance()">åŒ¯å‡ºåŒ¯æ¬¾è³‡æ–™</button>
            </div>
        </div>
        <table id="recordTable">
            <thead>
                <tr>
                    <th style="width: 100px;">åŒ¯æ¬¾æ—¥æœŸ</th>
                    <th>æ˜ç´°</th>
                    <th style="width: 120px;">é‡‘é¡</th>
                    <th style="width: 40px;">åˆªé™¤</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <button class="btn-reset" onclick="clearData()" style="color: var(--danger);">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
    </div>
</div>

<div id="vendorPage" class="page" style="max-width: 600px;">
    <div class="card">
        <h2>å» å•†è³‡æ–™ç®¡ç†</h2>
        <div style="margin-bottom: 15px; padding: 10px; background: #fef3c7; border-radius: 8px; font-size: 0.8rem;">
            åŒ¯å…¥ CSV æ ¼å¼éœ€åŒ…å«ï¼š<strong>å» å•†åç¨±,è¡Œåº«ä»£è™Ÿ,è¡Œåº«å¸³è™Ÿ,æ”¶æ¬¾æˆ¶å</strong>
        </div>
        <div class="row">
            <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="importVendors(this)">
            <button class="btn-import" onclick="document.getElementById('csvFileInput').click()">åŒ¯å…¥å» å•† Excel (CSV)</button>
            <button class="btn-reset" style="margin:0; padding:10px; width:auto;" onclick="clearVendors()">æ¸…ç©ºå» å•†</button>
        </div>
        <div class="section-title">å» å•†æ¸…å–® (<span id="vendorCount">0</span>)</div>
        <div id="vendorListDisplay" style="max-height: 400px; overflow-y: auto; font-size: 0.85rem;">
            </div>
    </div>
</div>

<div id="infoModal" class="modal" onclick="document.getElementById('infoModal').style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="document.getElementById('infoModal').style.display='none'">&times;</span>
        <div class="section-title">è¨ˆç®—éç¨‹ç´€éŒ„</div>
        <div id="modalBody" class="formula"></div>
    </div>
</div>

<script>
    const fmt = new Intl.NumberFormat('zh-TW');
    let db = JSON.parse(localStorage.getItem('paymentRecords')) || [];
    let vendors = JSON.parse(localStorage.getItem('vendorDB')) || [];
    let selectedVendor = null;

    // åˆ†é åˆ‡æ›
    function switchPage(pageId, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        btn.classList.add('active');
        if(pageId === 'listPage') { initMonthFilter(); renderTable(); }
        if(pageId === 'vendorPage') { renderVendorList(); }
    }

    // å» å•†ç®¡ç†ç›¸é—œ
    function importVendors(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const rows = text.split('\n');
            const newVendors = [];
            rows.slice(1).forEach(row => {
                const cols = row.split(',').map(s => s.trim());
                if(cols.length >= 4 && cols[0]) {
                    newVendors.push({ name: cols[0], bank: cols[1], account: cols[2], payee: cols[3] });
                }
            });
            vendors = [...vendors, ...newVendors];
            localStorage.setItem('vendorDB', JSON.stringify(vendors));
            renderVendorList();
            alert('åŒ¯å…¥å®Œæˆï¼');
        };
        reader.readAsText(file, 'UTF-8');
    }

    function renderVendorList() {
        const display = document.getElementById('vendorListDisplay');
        document.getElementById('vendorCount').innerText = vendors.length;
        display.innerHTML = vendors.map(v => `
            <div style="border-bottom:1px solid #eee; padding:8px 0;">
                <strong>${v.name}</strong><br>
                <span style="color:#666; font-size:0.75rem;">${v.bank} | ${v.account} | ${v.payee}</span>
            </div>
        `).join('');
    }

    function clearVendors() { if(confirm('ç¢ºå®šè¦æ¸…ç©ºå» å•†è³‡æ–™åº«ï¼Ÿ')) { vendors = []; localStorage.removeItem('vendorDB'); renderVendorList(); } }

    function searchVendor(keyword) {
        const suggestions = document.getElementById('vendorSuggestions');
        if(!keyword) { suggestions.style.display = 'none'; return; }
        const matches = vendors.filter(v => v.name.includes(keyword));
        
        if(matches.length === 0) { 
            suggestions.style.display = 'none'; 
            return; 
        }
        
        suggestions.innerHTML = matches.map(v => `
            <div class="suggestion-item" onclick="selectVendor('${v.name}')">${v.name}</div>
        `).join('');
        suggestions.style.display = 'block';
    }

    function selectVendor(name) {
        selectedVendor = vendors.find(v => v.name === name);
        document.getElementById('vendorSearch').value = name;
        document.getElementById('vendorSuggestions').style.display = 'none';
        
        const display = document.getElementById('vendorInfoDisplay');
        display.style.display = 'block';
        document.getElementById('vBank').innerText = `è¡Œåº«ï¼š${selectedVendor.bank}`;
        document.getElementById('vAccount').innerText = `å¸³è™Ÿï¼š${selectedVendor.account}`;
        document.getElementById('vName').innerText = `æˆ¶åï¼š${selectedVendor.payee}`;
    }

    // è¨ˆç®—èˆ‡æ¸²æŸ“é‚è¼¯
    function calculate(isManualTax, isManualRetention) {
        const raw = parseFloat(document.getElementById('rawAmount').value) || 0;
        const taxInput = document.getElementById('taxAmount');
        const retentionInput = document.getElementById('retentionAmount');
        let tax = isManualTax ? (parseFloat(taxInput.value) || 0) : Math.round(raw * 0.05);
        if(!isManualTax) taxInput.value = tax || "";
        const total = raw + tax;
        const subtotal = total - (document.getElementById('cleanCheck').checked ? Math.round(total * (parseFloat(document.getElementById('cleanRate').value)/100)) : 0);
        let retention = document.getElementById('retentionCheck').checked ? (isManualRetention ? (parseFloat(retentionInput.value) || 0) : Math.round(subtotal * (parseFloat(document.getElementById('retentionRate').value)/100))) : 0;
        if(!isManualRetention) retentionInput.value = retention || "";
        const net = subtotal - retention;
        document.getElementById('processFormula').innerHTML = `
            <div>â‘  å…¨é¡ï¼š${fmt.format(raw)} + ç¨…${fmt.format(tax)} = <strong>${fmt.format(total)}</strong></div>
            <div class="subtotal-line">â‘¡ å°è¨ˆï¼š<strong>${fmt.format(subtotal)}</strong></div>
            <div>â‘¢ ä¿ç•™æ¬¾ï¼š<strong>${fmt.format(retention)}</strong></div>
            <div style="margin-top:5px; border-top:1px solid #EEE; padding-top:5px;">â‘£ æ·¨é¡ï¼š<strong>${fmt.format(net)}</strong></div>
        `;
        document.getElementById('netAmount').value = net;
        renderDetail();
    }

    function getMinguoDate(addMonths, useSlash = true) {
        let d = new Date();
        d.setMonth(d.getMonth() + (isNaN(addMonths) ? 0 : addMonths));
        const y = d.getFullYear() - 1911;
        const m = (d.getMonth() + 1).toString().padStart(2, '0');
        return useSlash ? `${y}/${m}/15` : `${y}${m}15`;
    }

    function renderDetail() {
        const net = parseFloat(document.getElementById('netAmount').value) || 0;
        const p1Pct = parseFloat(document.getElementById('p1Pct').value) || 0;
        const p1Mon = parseInt(document.getElementById('p1Mon').value) || 0;
        const pDetail = document.getElementById('paymentDetail');
        if(net <= 0 || isNaN(p1Pct)) { pDetail.innerHTML = ""; return; }
        const pay1 = Math.round(net * (p1Pct/100));
        let html = `<div class="section-title">ä»˜æ¬¾æ’ç¨‹ (é è¦½)</div>`;
        html += `<div class="formula">ç¬¬ä¸€æœŸ (${p1Pct}%)ï¼š<strong>${fmt.format(pay1)}</strong></div>`;
        html += `<div class="date-line">${getMinguoDate(p1Mon, true)}</div>`;
        if (p1Pct < 100) {
            html += `<div class="formula" style="margin-top:10px;">ç¬¬äºŒæœŸï¼š<strong>${fmt.format(net - pay1)}</strong></div>`;
            html += `<div class="date-line">${getMinguoDate(parseInt(document.getElementById('p2Mon').value)||0, true)}</div>`;
        }
        pDetail.innerHTML = html;
    }

    function saveData() {
        const net = parseFloat(document.getElementById('netAmount').value) || 0;
        const p1Pct = parseFloat(document.getElementById('p1Pct').value) || 0;
        if (net <= 0 || isNaN(p1Pct)) { alert("è«‹è¼¸å…¥é‡‘é¡èˆ‡æ¯”ä¾‹"); return; }
        
        const timestamp = Date.now();
        const now = new Date();
        const saveMonthLabel = `${now.getFullYear()}.${(now.getMonth()+1).toString().padStart(2, '0')}`;
        const pay1 = Math.round(net * (p1Pct/100));
        
        const vendorText = selectedVendor ? ` (è¡Œåº«${selectedVendor.bank} å¸³è™Ÿ${selectedVendor.account} æˆ¶å${selectedVendor.payee})` : "";
        const note = document.getElementById('workNote').value || "å·¥ç¨‹";

        const baseData = {
            company: document.getElementById('companySelect').value,
            saveMonth: saveMonthLabel,
            formula: document.getElementById('processFormula').innerHTML,
            vendorBank: selectedVendor ? selectedVendor.bank : "",
            vendorAccount: selectedVendor ? selectedVendor.account : "",
            vendorPayee: selectedVendor ? selectedVendor.payee : ""
        };

        db.push({ 
            ...baseData,
            id: timestamp + "_1",
            date: getMinguoDate(parseInt(document.getElementById('p1Mon').value || 0), false), 
            desc: `${note}-ä¿ç•™æ¬¾(2-1)${vendorText}`, 
            amount: pay1
        });
        
        if (p1Pct < 100) {
            db.push({ 
                ...baseData,
                id: timestamp + "_2",
                date: getMinguoDate(parseInt(document.getElementById('p2Mon').value || 0), false), 
                desc: `${note}-ä¿ç•™æ¬¾(2-2)${vendorText}`, 
                amount: net - pay1
            });
        }
        localStorage.setItem('paymentRecords', JSON.stringify(db));
        alert("å„²å­˜æˆåŠŸï¼");
        clearInputFields();
    }

    function clearInputFields() {
        document.querySelectorAll('input:not([type="number"])').forEach(i => i.value = "");
        document.querySelectorAll('input[type="number"]').forEach(i => i.value = "");
        document.getElementById('vendorInfoDisplay').style.display = 'none';
        selectedVendor = null;
        document.getElementById('processFormula').innerHTML = "è«‹è¼¸å…¥è³‡æ–™...";
        document.getElementById('paymentDetail').innerHTML = "";
    }

    function initMonthFilter() {
        const months = new Set();
        db.forEach(item => months.add(item.saveMonth));
        const sorted = Array.from(months).sort().reverse();
        document.getElementById('filterMonth').innerHTML = `<option value="å…¨éƒ¨">å…¨éƒ¨æœˆä»½</option>` + sorted.map(m => `<option value="${m}">${m}</option>`).join('');
    }

    function renderTable() {
        const fComp = document.getElementById('filterCompany').value;
        const fMon = document.getElementById('filterMonth').value;
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = db.filter(i => (fComp === "å…¨éƒ¨" || i.company === fComp) && (fMon === "å…¨éƒ¨" || i.saveMonth === fMon)).map(item => `
            <tr>
                <td>${item.date}</td>
                <td style="cursor:pointer; color:#8E9775;" onclick="showFormula('${item.id}')">${item.desc}</td>
                <td class="amount-cell">${fmt.format(item.amount)}</td>
                <td class="action-cell"><button class="btn-del" onclick="deleteRecord('${item.id}')">Ã—</button></td>
            </tr>
        `).join('');
    }

    function showFormula(id) {
        const record = db.find(i => i.id === id);
        if(record) { document.getElementById('modalBody').innerHTML = record.formula; document.getElementById('infoModal').style.display = 'flex'; }
    }

    function deleteRecord(id) { if(confirm("åˆªé™¤æ­¤ç­†ï¼Ÿ")) { db = db.filter(i => i.id !== id); localStorage.setItem('paymentRecords', JSON.stringify(db)); renderTable(); } }
    function clearData() { if(confirm("å…¨éƒ¨æ¸…ç©ºï¼Ÿ")) { db = []; localStorage.removeItem('paymentRecords'); renderTable(); } }
    
    function exportToExcel() {
        const fComp = document.getElementById('filterCompany').value;
        const fMon = document.getElementById('filterMonth').value;
        const data = db.filter(i => (fComp === "å…¨éƒ¨" || i.company === fComp) && (fMon === "å…¨éƒ¨" || i.saveMonth === fMon));
        let csv = "\uFEFFåŒ¯æ¬¾æ—¥æœŸ,æ˜ç´°,é‡‘é¡\n" + data.map(i => `${i.date},"${i.desc.replace(/"/g, '""')}",${i.amount}`).join("\n");
        downloadCSV(csv, `çµç®—æ¸…å–®_${fMon}.csv`);
    }

    function exportRemittance() {
        const fComp = document.getElementById('filterCompany').value;
        const fMon = document.getElementById('filterMonth').value;
        const data = db.filter(i => (fComp === "å…¨éƒ¨" || i.company === fComp) && (fMon === "å…¨éƒ¨" || i.saveMonth === fMon));
        
        let csv = "\uFEFFåŒ¯æ¬¾æ—¥æœŸ,è§£æ¬¾è¡Œ,æ”¶æ¬¾äººå¸³è™Ÿ,æ”¶æ¬¾äººæˆ¶å,åŒ¯æ¬¾é‡‘é¡\n";
        csv += data.map(i => `${i.date},${i.vendorBank},${i.vendorAccount},${i.vendorPayee},${i.amount}`).join("\n");
        downloadCSV(csv, `åŒ¯æ¬¾è³‡æ–™_${fMon}.csv`);
    }

    function downloadCSV(csv, fileName) {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
        link.download = fileName;
        link.click();
    }

    window.onload = () => { if(vendors.length > 0) renderVendorList(); };
</script>

</body>
</html>ã„’
